<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camions BL â€” Processus PMO PrÃ©-Gate 0</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fraunces:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --primary-dark: #0f2744;
            --accent: #c6a052;
            --accent-light: #d4af61;
            --accent-glow: rgba(198, 160, 82, 0.25);
            --success: #16a34a;
            --success-bg: rgba(22, 163, 74, 0.08);
            --warning: #ca8a04;
            --warning-bg: rgba(202, 138, 4, 0.08);
            --error: #dc2626;
            --error-bg: rgba(220, 38, 38, 0.06);
            --info: #2563eb;
            --bg: #ffffff;
            --bg-card: #f8fafc;
            --bg-card-hover: #f1f5f9;
            --text: #1e293b;
            --text-muted: #64748b;
            --text-dim: #94a3b8;
            --border: #e2e8f0;
            --gradient-gold: linear-gradient(135deg, #c6a052 0%, #d4af61 50%, #c6a052 100%);
            --go: #16a34a;
            --attente: #dc2626;
            --project-color: #2563eb;
            --improvement-color: #16a34a;
            --it-color: #7c3aed;
            --ops-color: #ea580c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; }

        /* â”€â”€â”€ HEADER â”€â”€â”€ */
        .app-header {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            padding: 0.75rem 2rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .app-header-left { display: flex; align-items: center; gap: 0.75rem; }
        .app-logo-icon { width: 40px; height: 40px; background: var(--gradient-gold); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .app-logo-text { font-family: 'Fraunces', serif; font-size: 1.35rem; font-weight: 700; }
        .app-logo-sub { font-size: 0.75rem; color: var(--text-dim); }
        .app-header-right { display: flex; align-items: center; gap: 0.75rem; }
        .header-badge { background: var(--bg-card); padding: 0.35rem 0.75rem; border-radius: 8px; font-size: 0.8rem; color: var(--text-muted); border: 1px solid var(--border); }
        .header-btn { padding: 0.4rem 0.85rem; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); cursor: pointer; font-family: inherit; font-size: 0.8rem; transition: all 0.2s; }
        .header-btn:hover { border-color: var(--accent); color: var(--accent); }

        /* â”€â”€â”€ NAV TABS â”€â”€â”€ */
        .nav-tabs {
            position: fixed; top: 61px; left: 0; right: 0; z-index: 999;
            background: var(--bg-card); border-bottom: 1px solid var(--border);
            display: flex; padding: 0 2rem; overflow-x: auto;
        }
        .nav-tab {
            padding: 0.85rem 0.9rem; border: none; cursor: pointer; font-family: inherit;
            font-size: 0.82rem; font-weight: 500; color: var(--text-dim);
            background: transparent; border-bottom: 3px solid transparent;
            transition: all 0.2s; white-space: nowrap;
        }
        .nav-tab:hover { color: var(--text-muted); }
        .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); background: var(--bg-card-hover); }
        .nav-tab-icon { margin-right: 0.35rem; }

        /* â”€â”€â”€ MAIN CONTENT â”€â”€â”€ */
        .app-content { padding: 7.5rem 2rem 2rem; max-width: 1200px; margin: 0 auto; }
        .page { display: none; }
        .page.active { display: block; }

        /* â”€â”€â”€ CARDS â”€â”€â”€ */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .card-title { font-family: 'Fraunces', serif; font-size: 1.1rem; font-weight: 700; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .card-subtitle { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem; }

        /* â”€â”€â”€ FORM ELEMENTS (CharterPro style) â”€â”€â”€ */
        .form-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.25rem; }
        .form-section-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .form-row.single { grid-template-columns: 1fr; }
        .form-group { margin-bottom: 1rem; }
        .form-group:last-child { margin-bottom: 0; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.4rem; }
        .form-label .req { color: var(--error); }
        .form-control {
            width: 100%; padding: 0.7rem 0.9rem; background: var(--bg); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text); font-family: inherit; font-size: 0.9rem; transition: all 0.2s;
        }
        .form-control:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        textarea.form-control { min-height: 100px; resize: vertical; }
        select.form-control { cursor: pointer; }
        .form-hint { font-size: 0.78rem; color: var(--text-dim); margin-top: 0.3rem; }

        /* Dynamic Lists */
        .dynamic-list { margin-top: 0.75rem; }
        .dynamic-item { display: flex; gap: 0.6rem; margin-bottom: 0.6rem; align-items: flex-start; }
        .dynamic-item input, .dynamic-item textarea { flex: 1; }
        .btn-remove { width: 34px; height: 34px; border-radius: 8px; background: var(--error-bg); color: var(--error); border: 1px solid rgba(229,62,62,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1.1rem; transition: all 0.2s; }
        .btn-remove:hover { background: var(--error); color: white; }
        .btn-add { display: flex; align-items: center; gap: 0.4rem; padding: 0.45rem 0.9rem; background: transparent; border: 1px dashed var(--border); border-radius: 8px; color: var(--text-muted); cursor: pointer; font-family: inherit; font-size: 0.82rem; transition: all 0.2s; }
        .btn-add:hover { border-color: var(--accent); color: var(--accent); }

        /* â”€â”€â”€ BUTTONS â”€â”€â”€ */
        .btn { padding: 0.65rem 1.25rem; border-radius: 8px; font-family: inherit; font-size: 0.88rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 0.4rem; }
        .btn-gold { background: var(--gradient-gold); color: var(--primary-dark); }
        .btn-gold:hover { transform: translateY(-1px); box-shadow: 0 4px 12px var(--accent-glow); }
        .btn-secondary { background: var(--bg-card); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-card-hover); border-color: var(--text-dim); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { opacity: 0.9; }

        /* â”€â”€â”€ RISK / MILESTONE TABLES (CharterPro style) â”€â”€â”€ */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 0.65rem; text-align: left; border-bottom: 1px solid var(--border); }
        .data-table th { font-size: 0.78rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .data-table input, .data-table select { width: 100%; padding: 0.45rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: inherit; font-size: 0.88rem; }
        .data-table input:focus, .data-table select:focus { outline: none; border-color: var(--accent); }

        /* â”€â”€â”€ METRICS GRID (CharterPro style) â”€â”€â”€ */
        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.25rem; }
        .metric-card { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 12px; padding: 1.15rem; text-align: center; color: #ffffff; }
        .metric-value { font-size: 1.6rem; font-weight: 700; color: var(--accent-light); }
        .metric-label { font-size: 0.78rem; color: rgba(255,255,255,0.85); margin-top: 0.2rem; }

        /* â”€â”€â”€ CHARTER SIDEBAR (White theme) â”€â”€â”€ */
        .charter-layout { display: flex; gap: 0; min-height: calc(100vh - 120px); margin: -1.5rem -2rem; }
        .charter-sidebar { width: 260px; background: #f8fafc; border-right: 1px solid #e2e8f0; padding: 1.25rem 0; flex-shrink: 0; position: sticky; top: 0; height: fit-content; }
        .sidebar-title { padding: 0 1.25rem; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; margin-bottom: 0.85rem; }
        .step-item { display: flex; align-items: center; gap: 0.85rem; padding: 0.85rem 1.25rem; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .step-item:hover { background: #f1f5f9; }
        .step-item.active { background: #eef2ff; border-left-color: var(--accent); }
        .step-item.completed .step-number { background: var(--success); color: white; }
        .step-number { width: 30px; height: 30px; border-radius: 50%; background: #e2e8f0; color: #64748b; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.82rem; flex-shrink: 0; }
        .step-item.active .step-number { background: var(--accent); color: var(--primary-dark); }
        .step-info h4 { font-size: 0.9rem; font-weight: 500; margin-bottom: 0.1rem; color: #1e293b; }
        .step-info p { font-size: 0.75rem; color: #94a3b8; }
        .charter-main { flex: 1; padding: 2rem; max-width: 860px; background: #ffffff; }
        .charter-step { display: none; }
        .charter-step.active { display: block; }
        .step-header { margin-bottom: 1.5rem; }
        .step-header h2 { font-family: 'Fraunces', serif; font-size: 1.5rem; font-weight: 700; margin-bottom: 0.35rem; color: #1e293b; }
        .step-header p { color: #64748b; font-size: 0.9rem; }
        .step-nav { display: flex; justify-content: space-between; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0; }

        /* Charter form overrides (white) */
        .charter-main .form-section { background: #f8fafc; border: 1px solid #e2e8f0; }
        .charter-main .form-section-title { color: #1e293b; }
        .charter-main .form-label { color: #475569; }
        .charter-main .form-control { background: #ffffff; border-color: #cbd5e1; color: #1e293b; }
        .charter-main .form-control:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(198,160,82,0.15); }
        .charter-main .form-control::placeholder { color: #94a3b8; }
        .charter-main .form-hint { color: #94a3b8; }
        .charter-main .btn-add { border-color: #cbd5e1; color: #64748b; }
        .charter-main .btn-add:hover { border-color: var(--accent); color: #b8860b; }
        .charter-main .btn-remove { background: #fef2f2; color: #ef4444; border-color: #fecaca; }
        .charter-main .btn-remove:hover { background: #ef4444; color: white; }
        .charter-main .btn-secondary { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .charter-main .btn-secondary:hover { background: #e2e8f0; }
        .charter-main .btn-gold { background: var(--gradient-gold); color: var(--primary-dark); border: none; }
        .charter-main .btn-success { background: var(--success); color: white; border: none; }
        .charter-main .data-table th { color: #475569; border-bottom: 2px solid #e2e8f0; background: transparent; font-size: 0.78rem; }
        .charter-main .data-table td { border-bottom: 1px solid #f1f5f9; }
        .charter-main .data-table input, .charter-main .data-table select { background: #fff; border-color: #cbd5e1; color: #1e293b; }
        .charter-main .data-table input:focus, .charter-main .data-table select:focus { border-color: var(--accent); }

        /* â”€â”€â”€ PREVIEW PANEL (CharterPro style) â”€â”€â”€ */
        .preview-panel { background: white; color: #1a1a2e; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .preview-header { text-align: center; padding: 1.5rem; border-bottom: 3px solid var(--primary); }
        .preview-title { font-family: 'Fraunces', serif; font-size: 1.35rem; color: var(--primary); margin-bottom: 0.2rem; }
        .preview-subtitle { color: #666; font-size: 0.9rem; }
        .preview-meta { display: flex; justify-content: center; gap: 1.5rem; margin-top: 0.75rem; font-size: 0.82rem; color: #666; }
        .preview-body { padding: 1.5rem; }
        .preview-section { margin-bottom: 1.25rem; }
        .preview-section-title { font-family: 'Fraunces', serif; font-size: 0.95rem; color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 0.4rem; margin-bottom: 0.6rem; }
        .preview-section p { line-height: 1.7; margin-bottom: 0.4rem; color: #333; font-size: 0.9rem; }
        .preview-metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin: 0.75rem 0; }
        .preview-metric { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 0.85rem; border-radius: 8px; text-align: center; }
        .preview-metric-value { font-size: 1.3rem; font-weight: 700; color: var(--accent-light); }
        .preview-metric-label { font-size: 0.72rem; opacity: 0.9; }
        .preview-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin: 0.6rem 0; }
        .preview-table th, .preview-table td { padding: 0.5rem; text-align: left; border: 1px solid #e0e0e0; }
        .preview-table th { background: var(--primary); color: white; font-weight: 600; }
        .preview-table tr:nth-child(even) { background: #f9f9f9; }
        .preview-list { margin-left: 1.5rem; color: #333; font-size: 0.9rem; }
        .preview-list li { margin-bottom: 0.3rem; }

        /* â”€â”€â”€ WORKFLOW STEPS â”€â”€â”€ */
        .workflow-step { background: var(--bg-card); border-radius: 12px; padding: 1rem 1.25rem; border: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; cursor: pointer; transition: all 0.25s; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .workflow-step:hover { border-color: var(--accent); transform: translateX(4px); }
        .workflow-step-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.15rem; flex-shrink: 0; color: white; }
        .workflow-step-label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .workflow-step h3 { font-size: 1rem; font-weight: 600; margin: 0.1rem 0; }
        .workflow-step p { font-size: 0.82rem; color: var(--text-muted); margin: 0; }
        .workflow-step-action { padding: 0.4rem 0.85rem; border-radius: 8px; font-size: 0.78rem; font-weight: 500; white-space: nowrap; }
        .workflow-connector { display: flex; justify-content: center; padding: 0.15rem 0; }
        .workflow-connector-line { width: 2px; height: 16px; background: var(--border); }

        /* â”€â”€â”€ WORKFLOW ROW WITH SIDE INPUT â”€â”€â”€ */
        .workflow-row { display: flex; align-items: center; gap: 0; }
        .workflow-row > div:first-child { flex: 1; min-width: 0; }
        .workflow-arrow-left { color: var(--primary-light); font-size: 1rem; padding: 0 0.5rem; opacity: 0.5; flex-shrink: 0; }
        .workflow-side-input {
            width: 240px; flex-shrink: 0;
            background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 10px;
            padding: 0.85rem 1rem; position: relative; transition: all 0.2s;
        }
        .workflow-side-input[onclick]:hover { border-color: var(--success); box-shadow: 0 2px 8px rgba(22,163,74,0.15); transform: translateX(2px); }
        .side-input-freq { font-size: 0.68rem; font-style: italic; color: var(--success); font-weight: 500; margin-bottom: 0.3rem; }
        .side-input-title { font-size: 0.88rem; font-weight: 700; color: #1e293b; line-height: 1.3; margin-bottom: 0.25rem; }
        .side-input-desc { font-size: 0.72rem; color: var(--text-muted); line-height: 1.4; }
        .workflow-step-input { border-style: dashed; background: #faf5ff; }

        /* â”€â”€â”€ SCORING TABLE â”€â”€â”€ */
        .scoring-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
        .scoring-table th { padding: 0.7rem 0.5rem; background: var(--primary); color: white; font-weight: 600; text-align: center; font-size: 0.78rem; }
        .scoring-table th:first-child, .scoring-table th:nth-child(2), .scoring-table th:nth-child(3) { text-align: left; }
        .scoring-table td { padding: 0.5rem; border-bottom: 1px solid var(--border); }
        .scoring-table tbody tr:hover { background: var(--bg-card-hover); }
        .scoring-input { width: 42px; padding: 0.4rem 0.15rem; text-align: center; border-radius: 6px; border: 1px solid var(--border); font-size: 0.9rem; font-weight: 600; background: var(--bg); color: var(--text); }
        .scoring-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
        .score-high { background: var(--success-bg) !important; color: var(--success) !important; border-color: var(--success) !important; }
        .score-mid { background: var(--warning-bg) !important; color: var(--warning) !important; border-color: var(--warning) !important; }
        .score-low { background: var(--error-bg) !important; color: var(--error) !important; border-color: var(--error) !important; }

        /* â”€â”€â”€ CAPACITY BAR â”€â”€â”€ */
        .cap-bar-bg { height: 16px; background: #e2e8f0; border-radius: 5px; overflow: hidden; position: relative; }
        .cap-bar-fill { height: 100%; border-radius: 5px; transition: width 0.5s; }
        .cap-bar-fill.go { background: linear-gradient(90deg, #48bb78, #276749); }
        .cap-bar-fill.attente { background: linear-gradient(90deg, #fc8181, #c53030); }
        .cap-max-line { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--accent); z-index: 2; }

        /* â”€â”€â”€ STATUS BADGES â”€â”€â”€ */
        .badge { padding: 0.15rem 0.6rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
        .badge-go { background: var(--success-bg); color: var(--success); border: 1px solid rgba(56,161,105,0.3); }
        .badge-attente { background: var(--error-bg); color: var(--error); border: 1px solid rgba(229,62,62,0.3); }
        .badge-scored { background: var(--success-bg); color: var(--success); }
        .badge-unscored { background: var(--warning-bg); color: var(--warning); }

        /* â”€â”€â”€ BRANCH BADGES â”€â”€â”€ */
        .branch-card { padding: 0.85rem; border-radius: 10px; text-align: center; border: 1px solid var(--border); }

        /* â”€â”€â”€ TRIAGE CHAT â”€â”€â”€ */
        .chat-area { background: #fafbfc; border-radius: 12px 12px 0 0; border: 1px solid var(--border); border-bottom: none; height: 340px; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.6rem; }
        .chat-area::-webkit-scrollbar { width: 5px; }
        .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .chat-msg { max-width: 85%; padding: 0.6rem 0.9rem; border-radius: 10px; font-size: 0.88rem; line-height: 1.5; white-space: pre-line; }
        .chat-msg.bot { background: #eef2f7; }
        .chat-msg.bot.hl { background: rgba(66,153,225,0.1); border: 1px solid rgba(66,153,225,0.3); }
        .chat-msg.user { background: var(--primary-light); color: #ffffff; margin-left: auto; }
        .chat-input { background: var(--bg-card); border: 1px solid var(--border); border-top: 1px solid var(--border); border-radius: 0 0 12px 12px; padding: 1rem; }

        /* â”€â”€â”€ GATE 0 TABLES â”€â”€â”€ */
        .gate-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
        .gate-table th { padding: 0.65rem 0.5rem; color: white; font-weight: 600; text-align: center; }
        .gate-table th:nth-child(2) { text-align: left; }
        .gate-table td { padding: 0.6rem 0.5rem; border-bottom: 1px solid var(--border); text-align: center; }
        .gate-table td:nth-child(2) { text-align: left; font-weight: 500; }
        .gate-table-go th { background: var(--success); }
        .gate-table-attente th { background: var(--error); }

        /* â”€â”€â”€ NOTIFICATIONS â”€â”€â”€ */
        .notif { position: fixed; top: 12px; right: 12px; z-index: 2000; padding: 0.65rem 1.15rem; border-radius: 10px; color: white; font-size: 0.85rem; font-weight: 500; box-shadow: 0 8px 30px rgba(0,0,0,0.3); animation: fadeIn 0.3s ease-out; }
        .notif.ok { background: var(--success); }
        .notif.warn { background: var(--warning); }

        /* â”€â”€â”€ MODAL OVERLAY â”€â”€â”€ */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; align-items: flex-start; justify-content: center; z-index: 1500; padding: 1.5rem; overflow-y: auto; }
        .modal-box { background: #ffffff; border-radius: 16px; width: 100%; max-width: 1100px; max-height: 92vh; overflow: hidden; display: flex; flex-direction: column; animation: fadeIn 0.3s ease-out; box-shadow: 0 25px 60px rgba(0,0,0,0.3); }

        /* â”€â”€â”€ CHARTER MODAL HEADER â”€â”€â”€ */
        .charter-modal-header { padding: 0.75rem 1.25rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: 16px 16px 0 0; }
        .charter-back-btn { background: none; border: 1px solid #cbd5e1; border-radius: 8px; padding: 0.35rem 0.75rem; font-size: 0.82rem; font-weight: 500; color: #475569; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .charter-back-btn:hover { background: #f1f5f9; border-color: #94a3b8; color: #1e293b; }
        .charter-logo-icon { width: 32px; height: 32px; background: var(--gradient-gold); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .charter-modal-title { font-family: 'Fraunces', serif; font-size: 1.1rem; font-weight: 700; color: #1e293b; }
        .charter-save-indicator { font-size: 0.78rem; color: #94a3b8; }
        .charter-btn-close { background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.4rem 0.85rem; font-size: 0.82rem; font-weight: 500; color: #475569; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .charter-btn-close:hover { background: #e2e8f0; color: #1e293b; }
        .charter-btn-save { background: var(--gradient-gold); border: none; border-radius: 8px; padding: 0.4rem 0.85rem; font-size: 0.82rem; font-weight: 600; color: var(--primary-dark); cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .charter-btn-save:hover { transform: translateY(-1px); box-shadow: 0 4px 12px var(--accent-glow); }

        /* â”€â”€â”€ ANIMATIONS â”€â”€â”€ */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

        /* â”€â”€â”€ PRINT â”€â”€â”€ */
        @media print {
            .app-header, .nav-tabs, .no-print, .btn, button { display: none !important; }
            .app-content { padding: 0 !important; }
            body { background: white !important; color: black !important; }
            .preview-panel { box-shadow: none; border-radius: 0; }
            .preview-section { page-break-inside: avoid; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            @page { size: letter; margin: 0.75in; }
        }

        /* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
        @media (max-width: 900px) {
            .charter-sidebar { display: none; }
            .form-row { grid-template-columns: 1fr; }
            .metrics-grid, .preview-metrics { grid-template-columns: 1fr; }
            .workflow-row { flex-direction: column; gap: 0.5rem; }
            .workflow-arrow-left { transform: rotate(90deg); }
            .workflow-side-input { width: 100%; }
        }
    </style>
</head>
<body>

<!-- â•â•â• LOGIN SCREEN â•â•â• -->
<div id="loginScreen" style="position:fixed;inset:0;background:linear-gradient(135deg,#1a365d 0%,#2d3748 100%);z-index:99999;display:flex;align-items:center;justify-content:center;padding:1rem">
    <div style="display:flex;gap:2rem;align-items:stretch;max-width:850px;width:100%;flex-wrap:wrap;justify-content:center">
        
        <!-- MARCUS Introduction -->
        <div style="flex:1;min-width:280px;max-width:380px;background:linear-gradient(135deg,#8b5cf6,#6366f1);border-radius:16px;padding:2rem;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;color:white">
            <div style="width:120px;height:120px;border-radius:50%;border:4px solid rgba(255,255,255,0.3);overflow:hidden;margin-bottom:1.5rem;box-shadow:0 10px 30px rgba(0,0,0,0.3)">
                <img id="loginMarcusAvatar" style="width:100%;height:100%;object-fit:cover" alt="MARCUS">
            </div>
            <h2 style="font-family:'Fraunces',serif;font-size:1.6rem;margin:0 0 0.5rem;font-weight:700">Bonjour, je suis MARCUS</h2>
            <p style="font-size:0.95rem;opacity:0.9;margin:0 0 1rem;line-height:1.5">Votre assistant PMO intelligent</p>
            <div style="background:rgba(255,255,255,0.15);border-radius:12px;padding:1rem;font-size:0.85rem;line-height:1.6">
                <p style="margin:0 0 0.75rem">Je suis ici pour vous aider Ã :</p>
                <div style="text-align:left;display:inline-block">
                    <div style="margin:0.4rem 0">âœ“ Prioriser vos projets</div>
                    <div style="margin:0.4rem 0">âœ“ GÃ©rer la capacitÃ© des Ã©quipes</div>
                    <div style="margin:0.4rem 0">âœ“ RÃ©soudre les goulots</div>
                    <div style="margin:0.4rem 0">âœ“ PrÃ©parer vos dÃ©cisions Gate 0</div>
                </div>
            </div>
        </div>
        
        <!-- Login Form -->
        <div style="flex:1;min-width:280px;max-width:380px;background:white;border-radius:16px;padding:2.5rem;box-shadow:0 25px 50px rgba(0,0,0,0.3)">
            <div style="text-align:center;margin-bottom:2rem">
                <div style="font-size:3rem;margin-bottom:0.5rem">ğŸ—ï¸</div>
                <h1 style="font-family:'Fraunces',serif;font-size:1.5rem;color:#1a365d;margin:0">Processus PMO</h1>
                <p style="color:#718096;font-size:0.85rem;margin:0.5rem 0 0">Camions BL â€” PrÃ©-Gate 0</p>
            </div>
            <div id="loginError" style="display:none;background:#fed7d7;color:#c53030;padding:0.75rem;border-radius:8px;margin-bottom:1rem;font-size:0.85rem;text-align:center"></div>
            <div style="margin-bottom:1rem">
                <label style="display:block;font-size:0.8rem;font-weight:600;color:#4a5568;margin-bottom:0.4rem">Identifiant</label>
                <input type="text" id="loginUser" style="width:100%;padding:0.75rem;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;box-sizing:border-box" placeholder="Entrez votre identifiant" onkeypress="if(event.key==='Enter')doLogin()">
            </div>
            <div style="margin-bottom:1.5rem">
                <label style="display:block;font-size:0.8rem;font-weight:600;color:#4a5568;margin-bottom:0.4rem">Mot de passe</label>
                <input type="password" id="loginPass" style="width:100%;padding:0.75rem;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;box-sizing:border-box" placeholder="Entrez votre mot de passe" onkeypress="if(event.key==='Enter')doLogin()">
            </div>
            <button onclick="doLogin()" style="width:100%;padding:0.85rem;background:linear-gradient(135deg,#3182ce,#2b6cb0);color:white;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:transform 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                Se connecter
            </button>
            <p style="text-align:center;margin:1.5rem 0 0;font-size:0.75rem;color:#a0aec0">Â© 2026 Sylvain PMO Consulting</p>
        </div>
    </div>
</div>

<!-- â•â•â• HEADER â•â•â• -->
<header class="app-header">
    <div class="app-header-left">
        <div class="app-logo-icon">ğŸ—ï¸</div>
        <div>
            <div class="app-logo-text">Processus PMO</div>
            <div class="app-logo-sub">Camions BL â€” PrÃ©-Gate 0</div>
        </div>
    </div>
    <div class="app-header-right">
        <span class="header-badge" id="headerStats">â€”</span>
        <select id="dealerFilter" class="header-btn" style="padding:0.4rem 0.6rem;font-size:0.8rem;cursor:pointer;background:white" onchange="filterDealer=this.value;renderAll()">
            <option value="all">ğŸ­ Tous les concessionnaires</option>
            <option value="global">ğŸŒ Global</option>
            <option value="granby">ğŸ­ Granby</option>
            <option value="victoriaville">ğŸ­ Victoriaville</option>
            <option value="drummondville">ğŸ­ Drummondville</option>
        </select>
        <button class="header-btn" onclick="exportData()">ğŸ’¾ Exporter</button>
        <label class="header-btn" style="cursor:pointer">ğŸ“‚ Importer<input type="file" accept=".json" style="display:none" onchange="importData(event)"></label>
        <button class="header-btn" onclick="doLogout()" style="background:#fef2f2;color:#c53030;border:1px solid #fecaca">ğŸšª DÃ©connexion</button>
    </div>
</header>

<!-- â•â•â• NAV â•â•â• -->
<nav class="nav-tabs no-print" id="navTabs">
    <button class="nav-tab active" data-tab="workflow"><span class="nav-tab-icon">ğŸ”„</span>Processus</button>
    <button class="nav-tab" data-tab="triage"><span class="nav-tab-icon">ğŸ¯</span>Triage</button>
    <button class="nav-tab" data-tab="portfolio"><span class="nav-tab-icon">ğŸ“Š</span>Portefeuille</button>
    <button class="nav-tab" data-tab="scoring"><span class="nav-tab-icon">â­</span>Scoring</button>
    <button class="nav-tab" data-tab="people"><span class="nav-tab-icon">ğŸ‘¥</span>Ressources</button>
    <button class="nav-tab" data-tab="assign"><span class="nav-tab-icon">ğŸ“Œ</span>Affectation</button>
    <button class="nav-tab" data-tab="recommend"><span class="nav-tab-icon">ğŸš¦</span>Recommandation</button>
    <button class="nav-tab" data-tab="analysis"><span class="nav-tab-icon">ğŸ”</span>Analyse</button>
    <button class="nav-tab" data-tab="gate0"><span class="nav-tab-icon">ğŸ“„</span>Gate 0</button>
</nav>

<!-- â•â•â• CONTENT â•â•â• -->
<div class="app-content">

<!-- â”€â”€â”€ WORKFLOW PAGE â”€â”€â”€ -->
<div class="page active" id="page-workflow">
    <div style="text-align:center;margin-bottom:1.5rem">
        <h2 style="font-family:'Fraunces',serif;font-size:1.5rem;font-weight:700">Processus PMO â€” PrÃ©-Gate 0</h2>
        <p style="color:var(--text-muted);font-size:0.9rem;margin-top:0.3rem">De la capture d'idÃ©es Ã  l'approbation exÃ©cutive</p>
    </div>
    <div style="max-width:660px;margin:0 auto" id="workflowSteps"></div>
    <div class="card" style="margin-top:1.5rem">
        <div class="card-title">Les 4 branches du triage</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem" id="branchCards"></div>
    </div>
    <div style="margin-top:1rem;background:var(--bg-card-hover);border-radius:12px;padding:1rem;border:1px dashed var(--border);text-align:center">
        <p style="margin:0;font-size:0.85rem;color:var(--text-dim)">â†“ AprÃ¨s Gate 0 â†’ <b style="color:var(--text-muted)">Teams Planner</b> (Chantal) â†’ Gate 1 â†’ ExÃ©cution â†’ Gate 2 â†’ BÃ©nÃ©fices â†’ Gate 3</p>
    </div>
</div>

<!-- â”€â”€â”€ TRIAGE PAGE â”€â”€â”€ -->
<div class="page" id="page-triage">
    <h2 style="font-family:'Fraunces',serif;font-size:1.25rem;margin-bottom:1rem">ğŸ¯ Triage des idÃ©es & opportunitÃ©s</h2>
    <div style="max-width:700px;margin:0 auto">
        
        <!-- Decision Criteria Reference -->
        <div style="margin-bottom:1.25rem;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1.25rem">
            <div style="font-size:0.9rem;font-weight:700;color:var(--text);margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem">
                <span style="font-size:1.1rem">ğŸ“‹</span> CritÃ¨res de dÃ©cision
            </div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem">
                <!-- PROJET -->
                <div style="background:rgba(66,153,225,0.08);border:1px solid rgba(66,153,225,0.2);border-radius:10px;padding:0.85rem">
                    <div style="font-size:0.85rem;font-weight:700;color:var(--project-color);margin-bottom:0.5rem">ğŸ“‹ PROJET</div>
                    <div style="font-size:0.72rem;color:var(--text);line-height:1.6">
                        <div>âœ“ Ressources multi-dÃ©partements</div>
                        <div>âœ“ Nouvelle capacitÃ© Ã  crÃ©er</div>
                        <div>âœ“ Ressources externes requises</div>
                        <div>âœ“ Budget dÃ©diÃ© hors opÃ©rations</div>
                        <div>âœ“ DurÃ©e > 90 jours</div>
                        <div>âœ“ Impact stratÃ©gique si Ã©chec</div>
                    </div>
                    <div style="margin-top:0.5rem;font-size:0.68rem;color:var(--primary);font-weight:600">â†’ Charte â†’ Scoring â†’ Gate 0</div>
                </div>
                
                <!-- AMÃ‰LIORATION CONTINUE -->
                <div style="background:rgba(56,161,105,0.08);border:1px solid rgba(56,161,105,0.2);border-radius:10px;padding:0.85rem">
                    <div style="font-size:0.85rem;font-weight:700;color:var(--improvement-color);margin-bottom:0.5rem">ğŸ”„ AMÃ‰LIORATION CONTINUE</div>
                    <div style="font-size:0.72rem;color:var(--text);line-height:1.6">
                        <div>âœ“ Processus existant Ã  amÃ©liorer</div>
                        <div>âœ“ Pas de changement de systÃ¨me majeur</div>
                        <div>âœ“ Ã‰quipe actuelle impliquÃ©e</div>
                        <div>âœ— Pas multi-dÃ©partemental</div>
                        <div>âœ— Pas de ressources externes</div>
                    </div>
                    <div style="margin-top:0.5rem;font-size:0.68rem;color:var(--success);font-weight:600">â†’ Gabarit DMAIC</div>
                </div>
                
                <!-- BILLET TI -->
                <div style="background:rgba(128,90,213,0.08);border:1px solid rgba(128,90,213,0.2);border-radius:10px;padding:0.85rem">
                    <div style="font-size:0.85rem;font-weight:700;color:var(--it-color);margin-bottom:0.5rem">ğŸ« BILLET TI</div>
                    <div style="font-size:0.72rem;color:var(--text);line-height:1.6">
                        <div>âœ“ Bogue ou problÃ¨me technique</div>
                        <div>âœ“ Demande d'accÃ¨s ou Ã©quipement</div>
                        <div>âœ“ Erreur systÃ¨me Ã  corriger</div>
                        <div>âœ“ Support technique requis</div>
                    </div>
                    <div style="margin-top:0.5rem;font-size:0.68rem;color:#805ad5;font-weight:600">â†’ SystÃ¨me de billets TI</div>
                </div>
                
                <!-- OPÃ‰RATIONS -->
                <div style="background:rgba(221,107,32,0.08);border:1px solid rgba(221,107,32,0.2);border-radius:10px;padding:0.85rem">
                    <div style="font-size:0.85rem;font-weight:700;color:var(--ops-color);margin-bottom:0.5rem">âš™ï¸ OPÃ‰RATIONS COURANTES</div>
                    <div style="font-size:0.72rem;color:var(--text);line-height:1.6">
                        <div>âœ“ Processus existant</div>
                        <div>âœ“ Ã‰quipe actuelle peut le faire</div>
                        <div>âœ“ Dans le travail rÃ©gulier</div>
                        <div>âœ— Pas de ressources supplÃ©mentaires</div>
                        <div>âœ— Pas de budget dÃ©diÃ©</div>
                    </div>
                    <div style="margin-top:0.5rem;font-size:0.68rem;color:#dd6b20;font-weight:600">â†’ Retour DMS / Huddle</div>
                </div>
            </div>
        </div>
        
        <div class="chat-area" id="chatArea"></div>
        <div class="chat-input" id="chatInput"></div>
        <div style="margin-top:0.6rem;display:flex;gap:0.4rem;justify-content:center" id="tierIndicator"></div>
    </div>
</div>

<!-- â”€â”€â”€ PORTFOLIO PAGE â”€â”€â”€ -->
<div class="page" id="page-portfolio">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem">
        <h2 style="font-family:'Fraunces',serif;font-size:1.25rem">ğŸ“Š Portefeuille d'initiatives</h2>
        <button class="btn btn-gold" onclick="goTab('triage')">+ Nouvelle initiative</button>
    </div>
    <div id="portfolioList"></div>
</div>

<!-- â”€â”€â”€ SCORING PAGE â”€â”€â”€ -->
<div class="page" id="page-scoring">
    <h2 style="font-family:'Fraunces',serif;font-size:1.25rem;margin-bottom:0.35rem">â­ Scoring & Priorisation</h2>
    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1.25rem">6 critÃ¨res pondÃ©rÃ©s Ã— 10 points â€” le score pondÃ©rÃ© dÃ©termine la prioritÃ©</p>
    <div style="overflow-x:auto" id="scoringTableWrap"></div>
    <div class="card" style="margin-top:1rem" id="criteriaLegend"></div>
</div>

<!-- â”€â”€â”€ PEOPLE PAGE: Named Resources + Availability â”€â”€â”€ -->
<div class="page" id="page-people">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem">
        <div>
            <h2 style="font-family:'Fraunces',serif;font-size:1.25rem">ğŸ‘¥ Ressources de l'organisation</h2>
            <p style="color:var(--text-muted);font-size:0.85rem;margin-top:0.2rem">DisponibilitÃ© en heures/semaine pour les projets â€” validÃ©e par les gestionnaires</p>
        </div>
        <button class="btn btn-gold" onclick="addPerson()">+ Ajouter une ressource</button>
    </div>
    <div id="peopleTableWrap"></div>
    <div class="card" style="margin-top:1rem;background:#f0fdf4;border-color:#bbf7d0" id="peopleSummary"></div>
</div>

<!-- â”€â”€â”€ ASSIGNMENT PAGE: Assign People to Projects â”€â”€â”€ -->
<div class="page" id="page-assign">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem">
        <div>
            <h2 style="font-family:'Fraunces',serif;font-size:1.25rem">ğŸ“Œ Affectation des ressources</h2>
            <p style="color:var(--text-muted);font-size:0.85rem;margin-top:0.2rem">Assignez les personnes aux projets en heures/semaine</p>
        </div>
    </div>
    <div style="overflow-x:auto" id="assignTableWrap"></div>
</div>

<!-- â”€â”€â”€ RECOMMENDATION PAGE: GO / GOULOT Results â”€â”€â”€ -->
<div class="page" id="page-recommend">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem">
        <div>
            <h2 style="font-family:'Fraunces',serif;font-size:1.25rem">ğŸš¦ Recommandation capacitÃ©</h2>
            <p style="color:var(--text-muted);font-size:0.85rem;margin-top:0.2rem">Quels projets peut-on rÃ©aliser avec la capacitÃ© actuelle?</p>
        </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem;margin-bottom:1.25rem" id="recommendKPIs"></div>
    <div id="recommendContent"></div>
</div>

<!-- â”€â”€â”€ ANALYSIS PAGE: Detailed Capacity Drill-down â”€â”€â”€ -->
<div class="page" id="page-analysis">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem">
        <div>
            <h2 style="font-family:'Fraunces',serif;font-size:1.25rem">ğŸ” Analyse de capacitÃ© dÃ©taillÃ©e</h2>
            <p style="color:var(--text-muted);font-size:0.85rem;margin-top:0.2rem">Charge individuelle par ressource â€” identifiez les goulots</p>
        </div>
    </div>
    <div id="analysisContent"></div>
</div>

<!-- â”€â”€â”€ GATE 0 PAGE â”€â”€â”€ -->
<div class="page" id="page-gate0">
    <div class="no-print" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem">
        <div>
            <h2 style="font-family:'Fraunces',serif;font-size:1.25rem">ğŸš¦ Recommandation â€” Gate 0</h2>
            <p style="color:var(--text-muted);font-size:0.85rem;margin-top:0.2rem">Pour approbation par Samuel / ComitÃ© exÃ©cutif</p>
        </div>
        <div style="display:flex;gap:0.5rem">
            <button class="btn btn-gold" onclick="copyGate0Report()">ğŸ“‹ Copier</button>
            <button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ Imprimer</button>
        </div>
    </div>
    <div id="gate0Content"></div>
</div>

</div><!-- /app-content -->

<!-- â•â•â• CHARTER MODAL â•â•â• -->
<div class="modal-overlay" id="charterModal" style="display:none">
    <div class="modal-box">
        <div class="charter-modal-header">
            <div style="display:flex;align-items:center;gap:0.6rem">
                <button class="charter-back-btn" onclick="closeCharter()" title="Retour au portefeuille">â† Retour</button>
                <div class="charter-logo-icon">ğŸ“‹</div>
                <span class="charter-modal-title" id="charterModalTitle">Charte de projet</span>
            </div>
            <div style="display:flex;gap:0.5rem;align-items:center">
                <span class="charter-save-indicator" id="charterSaveStatus">â—</span>
                <button class="charter-btn-close" onclick="closeCharter()">âœ• Fermer</button>
                <button class="charter-btn-save" onclick="saveCharter()">ğŸ’¾ Sauvegarder</button>
            </div>
        </div>
        <div style="display:flex;flex:1;overflow:hidden;max-height:calc(92vh - 56px)">
            <!-- Sidebar -->
            <aside class="charter-sidebar" id="charterSidebar"></aside>
            <!-- Main -->
            <main class="charter-main" style="overflow-y:auto" id="charterMain"></main>
        </div>
    </div>
</div>

<!-- â•â•â• NOTIFICATION â•â•â• -->
<div id="notifEl" class="notif ok" style="display:none"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE_KEY = 'camionsbl_pmo_v2';
const BRANCHES = {
    project: { icon:'ğŸ“‹', label:'PROJET', color:'var(--project-color)', bg:'rgba(66,153,225,0.1)' },
    continuous_improvement: { icon:'ğŸ”„', label:'AMÃ‰LIORATION CONTINUE', color:'var(--improvement-color)', bg:'rgba(56,161,105,0.1)' },
    it_ticket: { icon:'ğŸ«', label:'BILLET TI', color:'var(--it-color)', bg:'rgba(128,90,213,0.1)' },
    operations: { icon:'âš™ï¸', label:'OPÃ‰RATIONS', color:'var(--ops-color)', bg:'rgba(221,107,32,0.1)' },
};
const DEFAULT_CRITERIA = [
    { id:'strategic_fit', label:'Fit stratÃ©gique', short:'Strat.', hint:'Alignement Roches & BHAG' },
    { id:'productivity', label:'Avantages productivitÃ©', short:'Prod.', hint:"Gains d'efficacitÃ©" },
    { id:'market', label:'Attrait marchÃ©', short:'MarchÃ©', hint:'Impact compÃ©titivitÃ©/clients' },
    { id:'core_competency', label:'CompÃ©tence clÃ©', short:'Core', hint:'Alignement core business' },
    { id:'feasibility', label:'FaisabilitÃ© technique', short:'Faisab.', hint:'ComplexitÃ© & risques' },
    { id:'mission', label:'Contribution mission', short:'Mission', hint:"Contribution Ã  la mission" },
];
const DEFAULT_WEIGHTS = { strategic_fit:25, productivity:20, market:15, core_competency:15, feasibility:15, mission:10 };

const FUNCTIONS = [
    { id:'direction', label:'Direction gÃ©nÃ©rale', dept:'Direction', icon:'ğŸ‘”' },
    { id:'gestionnaires', label:'Gestionnaires', dept:'Direction', icon:'ğŸ“‹' },
    { id:'ventes_neufs', label:'Ventes â€” Camions neufs', dept:'Ventes', icon:'ğŸš›' },
    { id:'ventes_usages', label:'Ventes â€” Camions usagÃ©s', dept:'Ventes', icon:'ğŸ”„' },
    { id:'service_client', label:'Service Ã  la clientÃ¨le', dept:'Service', icon:'ğŸ“' },
    { id:'mecaniciens', label:'MÃ©caniciens', dept:'Service', icon:'ğŸ”§' },
    { id:'conseillers_tech', label:'Conseillers techniques', dept:'Service', icon:'âš™ï¸' },
    { id:'pieces', label:'PiÃ¨ces & Inventaire', dept:'PiÃ¨ces', icon:'ğŸ“¦' },
    { id:'finance', label:'Finance & ComptabilitÃ©', dept:'Admin', icon:'ğŸ’°' },
    { id:'ti', label:'TI / Informatique', dept:'Admin', icon:'ğŸ’»' },
    { id:'rh', label:'RH & Administration', dept:'Admin', icon:'ğŸ¢' },
    { id:'marketing', label:'Marketing', dept:'Admin', icon:'ğŸ“£' },
];
const DEALERS = [
    { id:'global', label:'Global (toutes)', icon:'ğŸŒ' },
    { id:'granby', label:'Granby', icon:'ğŸ­' },
    { id:'victoriaville', label:'Victoriaville', icon:'ğŸ­' },
    { id:'drummondville', label:'Drummondville', icon:'ğŸ­' }
];

let filterDealer = 'all'; // 'all' = no filter

const DEFAULT_AVAILABILITY = {};
const DEFAULT_PROJECT_RESOURCES = {};

// â”€â”€ Monthly periods (Feb 2026 - Jan 2027) â”€â”€
const MONTHS = ['2026-02','2026-03','2026-04','2026-05','2026-06','2026-07','2026-08','2026-09','2026-10','2026-11','2026-12','2027-01'];
const MONTH_LABELS = { '2026-02':'FÃ©v 26','2026-03':'Mar 26','2026-04':'Avr 26','2026-05':'Mai 26','2026-06':'Juin 26','2026-07':'Juil 26','2026-08':'AoÃ»t 26','2026-09':'Sep 26','2026-10':'Oct 26','2026-11':'Nov 26','2026-12':'DÃ©c 26','2027-01':'Jan 27' };
const MONTH_SHORT = { '2026-02':'F','2026-03':'M','2026-04':'A','2026-05':'M','2026-06':'J','2026-07':'J','2026-08':'A','2026-09':'S','2026-10':'O','2026-11':'N','2026-12':'D','2027-01':'J' };

function defaultAvailByMonth(baseHrs, summerReduction=true) {
    const a = {};
    MONTHS.forEach(m => {
        // Reduce availability in July/August (vacations)
        if (summerReduction && (m === '2026-07' || m === '2026-08')) {
            a[m] = Math.round(baseHrs * 0.5);
        } else if (summerReduction && m === '2026-12') {
            a[m] = Math.round(baseHrs * 0.75); // Holidays
        } else {
            a[m] = baseHrs;
        }
    });
    return a;
}

// â”€â”€ Named Resources Model with Monthly Availability â”€â”€
const DEFAULT_PEOPLE = [
    { id:'r1', name:'Chantal', funcId:'gestionnaires', availByMonth: defaultAvailByMonth(20) },
    { id:'r2', name:'Gilbert', funcId:'ventes_neufs', availByMonth: defaultAvailByMonth(32) },
    { id:'r3', name:'Lemieux', funcId:'service_client', availByMonth: defaultAvailByMonth(24) },
    { id:'r4', name:'Robichaud', funcId:'ti', availByMonth: defaultAvailByMonth(40) },
    { id:'r5', name:'Tremblay', funcId:'mecaniciens', availByMonth: defaultAvailByMonth(20) },
    { id:'r6', name:'Coopers', funcId:'direction', availByMonth: defaultAvailByMonth(16) },
    { id:'r7', name:'Smith', funcId:'ti', availByMonth: defaultAvailByMonth(48) },
    { id:'r8', name:'Ouellette', funcId:'conseillers_tech', availByMonth: defaultAvailByMonth(24) },
    { id:'r9', name:'Samuel L.', funcId:'direction', availByMonth: defaultAvailByMonth(12) },
    { id:'r10', name:'Dupont', funcId:'finance', availByMonth: defaultAvailByMonth(16) },
    { id:'r11', name:'Martin', funcId:'pieces', availByMonth: defaultAvailByMonth(20) },
    { id:'r12', name:'Bergeron', funcId:'marketing', availByMonth: defaultAvailByMonth(24) },
    { id:'r13', name:'Lavoie', funcId:'rh', availByMonth: defaultAvailByMonth(16) },
    { id:'r14', name:'Gagnon', funcId:'mecaniciens', availByMonth: defaultAvailByMonth(16) },
    { id:'r15', name:'Roy', funcId:'ventes_usages', availByMonth: defaultAvailByMonth(24) },
];

function defaultAssignByMonth(baseHrs) {
    const a = {};
    MONTHS.forEach(m => a[m] = baseHrs);
    return a;
}

// â”€â”€ Assignments: { projectId: { personId: { month: hours } } } â”€â”€
const DEFAULT_ASSIGNMENTS = {
    p1: { r4: defaultAssignByMonth(24), r2: defaultAssignByMonth(16), r3: defaultAssignByMonth(12), r1: defaultAssignByMonth(8), r12: defaultAssignByMonth(8) },
    p2: { r3: defaultAssignByMonth(20), r1: defaultAssignByMonth(16), r5: defaultAssignByMonth(12), r13: defaultAssignByMonth(8) },
    p3: { r7: defaultAssignByMonth(32), r2: defaultAssignByMonth(12), r3: defaultAssignByMonth(8), r1: defaultAssignByMonth(8) },
    p4: { r5: defaultAssignByMonth(20), r8: defaultAssignByMonth(16), r11: defaultAssignByMonth(8), r1: defaultAssignByMonth(8) },
    p5: { r6: defaultAssignByMonth(16), r1: defaultAssignByMonth(20), r3: defaultAssignByMonth(12), r10: defaultAssignByMonth(8) },
    p6: { r7: defaultAssignByMonth(24), r14: defaultAssignByMonth(12), r8: defaultAssignByMonth(8), r1: defaultAssignByMonth(8) },
};
const SOURCES = [
    { v:'reunion_hebdo', l:'RÃ©union hebdomadaire', icon:'ğŸ“…' },
    { v:'reunion_mensuelle', l:'RÃ©union mensuelle', icon:'ğŸ“Š' },
    { v:'terrain', l:'Terrain / OpÃ©rations', icon:'ğŸ”§' },
    { v:'direction', l:'Direction / C.Dir', icon:'ğŸ‘”' },
    { v:'client', l:'Client / Externe', icon:'ğŸ¤' },
    { v:'autre', l:'Autre source', icon:'ğŸ’¡' },
];
const TIER1 = [
    { id:'multifonctionnel', q:'Cette initiative requiert-elle des ressources de plusieurs dÃ©partements?', h:'Ex: IT + Ventes + Marketing pour un CRM' },
    { id:'nouvelle_capacite', q:"CrÃ©e-t-elle une capacitÃ© qui n'existe pas aujourd'hui?", h:'Nouveau systÃ¨me, processus ou offre' },
    { id:'ressources_externes', q:'NÃ©cessite-t-elle des ressources externes?', h:'Fournisseurs, consultants, budget externe' },
];
const TIER2 = [
    { id:'bug_ti', q:"S'agit-il d'un bogue, problÃ¨me technique ou demande TI?", h:'Erreur systÃ¨me, accÃ¨s rÃ©seau, Ã©quipement' },
    { id:'processus_existant', q:'Peut-on amÃ©liorer un processus existant sans changer de systÃ¨me?', h:'Optimisation, standardisation' },
    { id:'equipe_existante', q:"L'Ã©quipe actuelle peut-elle le faire dans son travail rÃ©gulier?", h:'Pas de ressources supplÃ©mentaires' },
];
const TIER3 = [
    { id:'budget_dedie', q:'NÃ©cessite-t-elle un budget dÃ©diÃ© hors opÃ©rations courantes?', h:'Budget projet Ã  approuver' },
    { id:'duree_90jours', q:'DÃ©passe-t-elle 90 jours (un cycle de Roche)?', h:'Traverse plusieurs trimestres' },
    { id:'risque_strategique', q:"L'Ã©chec impacterait-il les objectifs stratÃ©giques?", h:'LiÃ© aux Roches ou BHAG' },
];

const CHARTER_STEPS = [
    { n:1, title:'Informations de base', sub:'Nom, type, dates', icon:'ğŸ“‹' },
    { n:2, title:'Sommaire & Objectifs', sub:'Description, buts', icon:'ğŸ¯' },
    { n:3, title:'PortÃ©e', sub:'Inclus, exclu, livrables', icon:'ğŸ“' },
    { n:4, title:'Parties prenantes', sub:'Sponsor, Ã©quipe, rÃ´les', icon:'ğŸ‘¥' },
    { n:5, title:'Risques & Contraintes', sub:'Ã‰valuation des risques', icon:'âš ï¸' },
    { n:6, title:'Ã‰chÃ©ancier & Budget', sub:'Jalons, finances', icon:'ğŸ’°' },
    { n:7, title:'AperÃ§u & Export', sub:'RÃ©vision, PDF', icon:'ğŸ“„' },
];

const DEFAULT_PROJECTS = [
    { id:'p1', name:'Implantation CRM', chef:'Gilbert', source:'direction', branch:'project', dealer:'global',
      charter:{ sponsor:'Samuel Lamoureux', type:'Software Development', priority:'High', overview:'Centraliser la gestion clients avec un CRM moderne intÃ©grÃ© aux opÃ©rations de vente et service.', objectives:['RÃ©duire le temps de traitement des leads de 40%','Centraliser 100% des donnÃ©es clients'], inScope:'Ventes + Service + Marketing', budget:'150 000$', benefits:'200 000$', duration:'1.5', benefitPeriod:'3', startDate:'2026-03-01', endDate:'2027-08-31',
        risks:[{risk:'RÃ©sistance au changement',impact:'High',mitigation:'Plan de formation dÃ©diÃ©'},{risk:'IntÃ©gration DMS complexe',impact:'Medium',mitigation:'POC prÃ©alable'}],
        milestones:[{phase:'Analyse des besoins',duration:'2 mois',date:'Mai 2026'},{phase:'Configuration',duration:'4 mois',date:'Sep 2026'},{phase:'Formation & Go-live',duration:'3 mois',date:'DÃ©c 2026'}],
        deliverables:['CRM configurÃ© et intÃ©grÃ©','Formation utilisateurs','Documentation processus'], stakeholders:[{name:'Samuel Lamoureux',role:'Sponsor'},{name:'Ã‰quipe ventes',role:'Utilisateurs'}] },
      scores:{strategic_fit:9,productivity:9,market:10,core_competency:10,feasibility:9,mission:9}, resources:20, triageDate:'2026-01-15' },
    { id:'p2', name:'Programme Excellence Service', chef:'Lemieux', source:'reunion_mensuelle', branch:'project', dealer:'global',
      charter:{ sponsor:'Philippe Lamoureux', type:'Business Transformation', priority:'High', overview:'Standardiser la qualitÃ© du service Ã  travers les 5 succursales.', objectives:['Atteindre certification Elite Support','Score satisfaction client > 4.5/5'], inScope:'Service + Formation', budget:'80 000$', benefits:'120 000$', duration:'1', benefitPeriod:'3',
        risks:[{risk:'VariabilitÃ© entre succursales',impact:'High',mitigation:'Standards uniformes'}], milestones:[{phase:'Diagnostic',duration:'2 mois',date:'Avr 2026'},{phase:'DÃ©ploiement',duration:'4 mois',date:'AoÃ»t 2026'}] },
      scores:{strategic_fit:10,productivity:10,market:7,core_competency:7,feasibility:7,mission:7}, resources:20, triageDate:'2026-01-15' },
    { id:'p3', name:'Portail client en ligne', chef:'Robichaud', source:'client', branch:'project', dealer:'global',
      charter:{ sponsor:'Samuel Lamoureux', type:'Software Development', priority:'Medium', overview:'Self-service pour suivi de flottes et demandes de service.', objectives:['RÃ©duire appels clients de 30%','Suivi en temps rÃ©el des vÃ©hicules en service'], inScope:'TI + Ventes + Service', budget:'120 000$', benefits:'160 000$', duration:'1.5', benefitPeriod:'3',
        risks:[{risk:'Adoption par les clients',impact:'Medium',mitigation:'UX testing avec clients pilotes'}], milestones:[{phase:'Design UX',duration:'3 mois',date:'Juin 2026'},{phase:'DÃ©veloppement',duration:'6 mois',date:'DÃ©c 2026'}] },
      scores:{strategic_fit:8,productivity:7,market:7,core_competency:8,feasibility:9,mission:9}, resources:15, triageDate:'2026-01-20' },
    { id:'p4', name:'Lean Service Optimization', chef:'Tremblay', source:'terrain', branch:'project', dealer:'granby',
      charter:{ sponsor:'Marc Ouellette', type:'Business Transformation', priority:'Medium', overview:"RÃ©duire temps d'attente baies service par approche Lean.", objectives:["RÃ©duire temps d'attente de 25%",'Augmenter throughput de 15%'], inScope:'Service + PiÃ¨ces', budget:'45 000$', benefits:'80 000$', duration:'0.5', benefitPeriod:'3',
        risks:[{risk:'Perturbation des opÃ©rations durant le changement',impact:'Medium',mitigation:'DÃ©ploiement par succursale'}], milestones:[{phase:'Analyse Lean',duration:'1 mois',date:'Mars 2026'},{phase:'ImplÃ©mentation',duration:'3 mois',date:'Juin 2026'}] },
      scores:{strategic_fit:7,productivity:7,market:9,core_competency:9,feasibility:8,mission:5}, resources:12, triageDate:'2026-01-22' },
    { id:'p5', name:'Expansion Victoriaville', chef:'Coopers', source:'direction', branch:'project', dealer:'victoriaville',
      charter:{ sponsor:'Samuel Lamoureux', type:'Construction', priority:'High', overview:'Croissance de 10K Ã  26K piÂ² pour capacitÃ© service accrue.', objectives:['Tripler la capacitÃ© de service','Ajouter 4 baies de service'], inScope:'Direction + Service + Admin', budget:'500 000$', benefits:'300 000$', duration:'2', benefitPeriod:'5',
        risks:[{risk:'DÃ©passement de coÃ»ts construction',impact:'High',mitigation:'Contrat prix fixe avec contingence 15%'}], milestones:[{phase:'Plans & permis',duration:'4 mois',date:'Juin 2026'},{phase:'Construction',duration:'8 mois',date:'FÃ©v 2027'},{phase:'AmÃ©nagement',duration:'2 mois',date:'Avr 2027'}] },
      scores:{strategic_fit:7,productivity:7,market:6,core_competency:8,feasibility:8,mission:6}, resources:20, triageDate:'2026-01-10' },
    { id:'p6', name:'App mobile techniciens', chef:'Smith', source:'terrain', branch:'project', dealer:'global',
      charter:{ sponsor:'Marc Ouellette', type:'Software Development', priority:'Medium', overview:'Bons de travail digitaux pour les techniciens sur le terrain.', objectives:['Ã‰liminer 100% des formulaires papier','RÃ©duire temps admin de 30%'], inScope:'TI + Service', budget:'95 000$', benefits:'60 000$', duration:'1', benefitPeriod:'3',
        risks:[{risk:'Adoption par techniciens terrain',impact:'Medium',mitigation:'Champions par succursale + formation hands-on'}], milestones:[{phase:'Prototypage',duration:'2 mois',date:'Avr 2026'},{phase:'DÃ©veloppement',duration:'4 mois',date:'AoÃ»t 2026'},{phase:'Pilote',duration:'2 mois',date:'Oct 2026'}] },
      scores:{strategic_fit:8,productivity:6,market:6,core_competency:7,feasibility:5,mission:5}, resources:20, triageDate:'2026-01-25' },
];

let STATE = { projects: [], maxCapacity: 70, weights: {...DEFAULT_WEIGHTS}, criteria: JSON.parse(JSON.stringify(DEFAULT_CRITERIA)), people: JSON.parse(JSON.stringify(DEFAULT_PEOPLE)), assignments: JSON.parse(JSON.stringify(DEFAULT_ASSIGNMENTS)) };
let currentCharterProject = null;
let charterStep = 1;

// Triage state
let triageState = { step:'desc', desc:'', src:'', ans:{}, tier:1, qi:0, result:null, msgs:[{t:'bot',txt:'ğŸ‘‹ Bienvenue! DÃ©crivez l\'idÃ©e ou l\'opportunitÃ© Ã  Ã©valuer.',hl:true}] };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastSyncTime = 0;
let isSyncing = false;

async function init() {
    try {
        // Try to load from API first
        const response = await fetch('/api/state');
        if (response.ok) {
            const d = await response.json();
            STATE.projects = Array.isArray(d.projects) ? d.projects : DEFAULT_PROJECTS; 
            STATE.maxCapacity = d.maxCapacity || 70; 
            STATE.weights = d.weights || {...DEFAULT_WEIGHTS};
            STATE.criteria = d.criteria || JSON.parse(JSON.stringify(DEFAULT_CRITERIA));
            STATE.people = Array.isArray(d.people) ? d.people : JSON.parse(JSON.stringify(DEFAULT_PEOPLE));
            STATE.assignments = d.assignments || JSON.parse(JSON.stringify(DEFAULT_ASSIGNMENTS));
            STATE.triageItems = d.triageItems || [];
            lastSyncTime = Date.now();
            console.log('âœ“ DonnÃ©es chargÃ©es depuis la base de donnÃ©es');
        } else {
            throw new Error('API not available');
        }
    } catch(e) { 
        // Fallback to localStorage
        console.log('âš  Fallback vers localStorage:', e.message);
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) { 
                const d = JSON.parse(raw); 
                STATE.projects = Array.isArray(d.projects) ? d.projects : DEFAULT_PROJECTS; 
                STATE.maxCapacity = d.maxCapacity || 70; 
                STATE.weights = d.weights || {...DEFAULT_WEIGHTS};
                STATE.criteria = d.criteria || JSON.parse(JSON.stringify(DEFAULT_CRITERIA));
                STATE.people = Array.isArray(d.people) ? d.people : JSON.parse(JSON.stringify(DEFAULT_PEOPLE));
                STATE.assignments = d.assignments || JSON.parse(JSON.stringify(DEFAULT_ASSIGNMENTS));
            }
            else { STATE.projects = JSON.parse(JSON.stringify(DEFAULT_PROJECTS)); }
        } catch(e2) { STATE.projects = JSON.parse(JSON.stringify(DEFAULT_PROJECTS)); }
    }
    setupTabs();
    renderAll();
    
    // Start sync check every 10 seconds
    setInterval(checkForUpdates, 10000);
}

async function saveState() {
    // Always save to localStorage as backup
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); } catch(e) {}
    
    // Save to API
    if (isSyncing) return;
    isSyncing = true;
    
    try {
        const response = await fetch('/api/state', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-User-Name': localStorage.getItem('pmo_user_name') || 'Anonyme'
            },
            body: JSON.stringify({
                projects: STATE.projects,
                people: STATE.people,
                assignments: STATE.assignments,
                triageItems: STATE.triageItems || [],
                criteriaWeights: STATE.weights,
                maxCapacity: STATE.maxCapacity,
                criteria: STATE.criteria
            })
        });
        if (response.ok) {
            lastSyncTime = Date.now();
            showSyncStatus('saved');
        }
    } catch(e) {
        console.log('Erreur sauvegarde API:', e.message);
    }
    isSyncing = false;
}

async function checkForUpdates() {
    if (isSyncing) return;
    try {
        const response = await fetch('/api/state');
        if (response.ok) {
            const d = await response.json();
            const serverTime = new Date(d.updatedAt).getTime();
            if (serverTime > lastSyncTime + 5000) { // 5 second buffer
                // New data available!
                STATE.projects = d.projects || [];
                STATE.people = Array.isArray(d.people) ? d.people : JSON.parse(JSON.stringify(DEFAULT_PEOPLE));
                STATE.assignments = d.assignments || {};
                STATE.triageItems = d.triageItems || [];
                lastSyncTime = Date.now();
                renderAll();
                showSyncStatus('updated', d.updatedBy);
            }
        }
    } catch(e) {}
}

function showSyncStatus(type, userName) {
    const existing = document.getElementById('syncToast');
    if (existing) existing.remove();
    
    const toast = document.createElement('div');
    toast.id = 'syncToast';
    toast.style.cssText = 'position:fixed;bottom:20px;right:20px;padding:0.75rem 1.25rem;border-radius:10px;font-size:0.85rem;z-index:99999;animation:fadeIn 0.3s;box-shadow:0 4px 12px rgba(0,0,0,0.15)';
    
    if (type === 'saved') {
        toast.style.background = '#38a169';
        toast.style.color = 'white';
        toast.innerHTML = 'âœ“ SauvegardÃ©';
    } else if (type === 'updated') {
        toast.style.background = '#4299e1';
        toast.style.color = 'white';
        toast.innerHTML = 'ğŸ”„ Mis Ã  jour' + (userName ? ' par ' + userName : '');
    }
    
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2500);
}

let selectedMonth = MONTHS[0]; // Current selected month for UI

function getTotalAvailableHrs(month) {
    const m = month || selectedMonth;
    return STATE.people.reduce((s,p) => s + (p.availByMonth?.[m] || 0), 0);
}
function getPersonAvailHrs(pid, month) {
    const m = month || selectedMonth;
    const p = STATE.people.find(x=>x.id===pid);
    return p ? (p.availByMonth?.[m] || 0) : 0;
}
function getPersonAssignedHrs(pid, month) {
    const m = month || selectedMonth;
    let total = 0;
    Object.values(STATE.assignments).forEach(projAssign => {
        const personAssign = projAssign[pid];
        if (personAssign) {
            if (typeof personAssign === 'object') {
                total += (personAssign[m] || 0);
            } else {
                total += personAssign; // Legacy format
            }
        }
    });
    return total;
}
function getProjectTotalHrs(projId, month) {
    const m = month || selectedMonth;
    const a = STATE.assignments[projId] || {};
    let total = 0;
    Object.values(a).forEach(personAssign => {
        if (typeof personAssign === 'object') {
            total += (personAssign[m] || 0);
        } else {
            total += personAssign; // Legacy format
        }
    });
    return total;
}
function getPersonYearlyAvail(pid) {
    const p = STATE.people.find(x=>x.id===pid);
    if (!p || !p.availByMonth) return 0;
    return MONTHS.reduce((s,m) => s + (p.availByMonth[m]||0), 0);
}
function getPersonYearlyAssigned(pid) {
    let total = 0;
    Object.values(STATE.assignments).forEach(projAssign => {
        const personAssign = projAssign[pid];
        if (personAssign && typeof personAssign === 'object') {
            MONTHS.forEach(m => total += (personAssign[m] || 0));
        }
    });
    return total;
}
function funcLabel(fid) {
    const f = FUNCTIONS.find(x=>x.id===fid);
    return f ? f.label : fid;
}
function funcIcon(fid) {
    const f = FUNCTIONS.find(x=>x.id===fid);
    return f ? f.icon : 'ğŸ‘¤';
}

function notify(msg, t='ok') {
    const el = document.getElementById('notifEl');
    el.textContent = msg; el.className = 'notif ' + t; el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupTabs() {
    document.querySelectorAll('.nav-tab').forEach(btn => {
        btn.onclick = () => goTab(btn.dataset.tab);
    });
}

function goTab(tabId) {
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
    document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === 'page-' + tabId));
    if (typeof currentTab !== 'undefined') currentTab = tabId;
    renderAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const gid = () => 'p' + Date.now().toString(36) + Math.random().toString(36).substr(2,4);
const weightedScore = s => {
    if(!s) return 0;
    const w = STATE.weights;
    let total = 0;
    STATE.criteria.forEach(c => { total += (s[c.id]||0) * (w[c.id]||0) / 100; });
    return total;
};
const sum = s => s ? Object.values(s).reduce((a,b) => a + (b||0), 0) : 0;
const pct = s => ((weightedScore(s)/10)*100).toFixed(1);
const esc = t => { if(!t)return''; const d=document.createElement('div'); d.textContent=t; return d.innerHTML; };
const fmt = n => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');

function matchesDealer(p) { if(filterDealer==='all') return true; return p.dealer===filterDealer; }
function sorted() { return [...STATE.projects].filter(p=>p.branch==='project'&&p.scores&&matchesDealer(p)).sort((a,b)=>weightedScore(b.scores)-weightedScore(a.scores)); }
function nonProj() { return STATE.projects.filter(p=>p.branch&&p.branch!=='project'&&matchesDealer(p)); }
function allProj() { return STATE.projects.filter(p=>p.branch==='project'&&matchesDealer(p)); }

function srcLabel(v) { const s = SOURCES.find(x=>x.v===v); return s ? s.l : v; }
function dealerLabel(d) { const dl = DEALERS.find(x=>x.id===d); return dl ? dl.label : 'Non assignÃ©'; }
function dealerBadge(d) { if(!d) return ''; const dl = DEALERS.find(x=>x.id===d); if(!dl) return ''; const colors={global:'#6366f1',granby:'#2563eb',victoriaville:'#16a34a',drummondville:'#ea580c'}; return '<span style="font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:6px;background:'+(colors[d]||'#94a3b8')+'15;color:'+(colors[d]||'#94a3b8')+';font-weight:600;white-space:nowrap">'+dl.icon+' '+dl.label+'</span>'; }
function scoreClass(v) { if(v>=8) return 'score-high'; if(v>=5) return 'score-mid'; return 'score-low'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll() {
    // Ensure STATE.people is an array
    if (!Array.isArray(STATE.people)) {
        STATE.people = JSON.parse(JSON.stringify(DEFAULT_PEOPLE));
    }
    const sp = sorted();
    const filteredProjects = allProj();
    const totalProjects = STATE.projects.filter(p=>p.branch==='project').length;
    const yearlyAvail = STATE.people.reduce((s,p) => s + getPersonYearlyAvail(p.id), 0);
    const filterLabel = filterDealer==='all' ? '' : ' Â· Filtre: '+dealerLabel(filterDealer);
    document.getElementById('headerStats').textContent = filteredProjects.length + (filterDealer!=='all'?'/'+totalProjects:'') + ' projets Â· ' + STATE.people.length + ' ressources Â· ' + yearlyAvail + 'h/an' + filterLabel;
    renderWorkflow();
    renderTriage();
    renderPortfolio();
    renderScoring();
    renderPeople();
    renderAssign();
    renderRecommend();
    renderAnalysis();
    renderGate0();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORKFLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWorkflow() {
    let html = '';

    // â”€â”€ Helper: main step card â”€â”€
    function stepCard(num, icon, title, desc, color, action, tab) {
        return `<div class="workflow-step" onclick="goTab('${tab}')">
            <div class="workflow-step-icon" style="background:${color}">${icon}</div>
            <div style="flex:1">
                <div class="workflow-step-label" style="color:${color}">Ã‰tape ${num}</div>
                <h3>${title}</h3>
                <p>${desc}</p>
            </div>
            <div class="workflow-step-action" style="background:${color}22;color:${color}">${action} â†’</div>
        </div>`;
    }
    function connector() {
        return '<div class="workflow-connector"><div class="workflow-connector-line"></div></div>';
    }

    // â”€â”€ Ã‰tape 1: Triage â”€â”€
    html += stepCard(1, 'ğŸ¯', 'Triage', 'Classifier: Projet, AmÃ©lioration, Billet TI ou OpÃ©ration', 'var(--primary)', 'DÃ©marrer', 'triage');
    html += connector();

    // â”€â”€ Ã‰tape 2: Charte de projet â”€â”€
    html += stepCard(2, 'ğŸ“‹', 'Charte de projet', 'Documenter sponsor, objectif, portÃ©e, budget, Ã©chÃ©ancier', 'var(--primary-light)', 'Portefeuille', 'portfolio');
    html += connector();

    // â”€â”€ Ã‰tape 3: Scoring + side input (Poids/critÃ¨res) â”€â”€
    html += `<div class="workflow-row">
        <div style="flex:1">`;
    html += stepCard(3, 'â­', 'Scoring / Priorisation', '6 critÃ¨res pondÃ©rÃ©s Ã— 10 points â€” prioriser par score pondÃ©rÃ©', '#2c7a7b', 'Scorer', 'scoring');
    html += `</div>
        <div class="workflow-arrow-left">â—€</div>
        <div class="workflow-side-input" onclick="openWeightsEditor()" style="cursor:pointer" title="Cliquer pour modifier les poids">
            <div class="side-input-freq">1 fois par quart â€” ExÃ©cutifs</div>
            <div class="side-input-title">Poids / critÃ¨res stratÃ©giques</div>
            <div class="side-input-desc">PondÃ©ration des critÃ¨res de priorisation validÃ©e par le comitÃ© exÃ©cutif</div>
            <div style="margin-top:0.4rem;font-size:0.72rem;font-weight:600;color:var(--primary-light)">âœ Cliquer pour modifier</div>
        </div>
    </div>`;
    html += connector();

    // â”€â”€ Ã‰tape 4: Ressources requises / projet â”€â”€
    html += `<div class="workflow-step workflow-step-input" onclick="goTab('assign')">
        <div class="workflow-step-icon" style="background:#6366f1">ğŸ“Š</div>
        <div style="flex:1">
            <div class="workflow-step-label" style="color:#6366f1">Ã‰tape 4</div>
            <h3>Ressources requises / projet</h3>
            <p>Estimer les ressources nÃ©cessaires pour chaque projet priorisÃ©</p>
        </div>
        <div class="workflow-step-action" style="background:#6366f122;color:#6366f1">Estimer â†’</div>
    </div>`;
    html += connector();

    // â”€â”€ Ã‰tape 5: Analyse de capacitÃ© + side input (Ressources dispo) â”€â”€
    html += `<div class="workflow-row">
        <div style="flex:1">`;
    html += stepCard(5, 'ğŸ‘¥', 'Analyse de capacitÃ©', 'RÃ©sultats: demande vs capacitÃ© sur 12 mois', 'var(--success)', 'Analyser', 'recommend');
    html += `</div>
        <div class="workflow-arrow-left">â—€</div>
        <div class="workflow-side-input" onclick="goTab('people')" style="cursor:pointer" title="Cliquer pour configurer">
            <div class="side-input-freq">1 fois par quart â€” Chefs fonctionnels</div>
            <div class="side-input-title">Ressources disponibles (12 mois)</div>
            <div class="side-input-desc">Personnes nommÃ©es et disponibilitÃ© h/mois incl. vacances Ã©tÃ©</div>
            <div style="margin-top:0.4rem;font-size:0.72rem;font-weight:600;color:var(--primary-light)">âœ Cliquer pour configurer</div>
        </div>
    </div>`;
    html += connector();

    // â”€â”€ Ã‰tape 6: Recommandation Gate 0 â”€â”€
    html += stepCard(6, 'ğŸš¦', 'Recommandation Gate 0', 'Rapport GO/ATTENTE pour approbation par Samuel et comitÃ©', 'var(--accent)', 'Rapport', 'gate0');

    document.getElementById('workflowSteps').innerHTML = html;

    let bhtml = '';
    Object.entries(BRANCHES).forEach(([k,b]) => {
        bhtml += `<div class="branch-card" style="background:${b.bg}">
            <div style="font-size:1.5rem;margin-bottom:0.3rem">${b.icon}</div>
            <div style="font-size:0.78rem;font-weight:600;color:${b.color}">${b.label}</div>
            <div style="font-size:0.7rem;color:var(--text-dim);margin-top:0.25rem">${k==='project'?'â†’ Charte â†’ Scoring â†’ Gate 0':k==='continuous_improvement'?'â†’ Gabarit DMAIC':k==='it_ticket'?'â†’ SystÃ¨me billets TI':'â†’ Retour DMS / Huddle'}</div>
        </div>`;
    });
    document.getElementById('branchCards').innerHTML = bhtml;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRIAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTriage() {
    const S = triageState;
    // Messages
    let mhtml = '';
    S.msgs.forEach(m => {
        mhtml += `<div style="display:flex;justify-content:${m.t==='user'?'flex-end':'flex-start'}">
            <div class="chat-msg ${m.t}${m.hl?' hl':''}">${esc(m.txt)}</div>
        </div>`;
    });
    // Current question
    if (S.step === 'qs') {
        const qs = S.tier===1?TIER1:S.tier===2?TIER2:TIER3;
        const q = qs[S.qi];
        if (q) mhtml += `<div style="display:flex;justify-content:flex-start"><div class="chat-msg bot"><b>${esc(q.q)}</b>${q.h?'<div style="font-size:0.78rem;color:var(--text-dim);margin-top:0.2rem">ğŸ’¡ '+esc(q.h)+'</div>':''}</div></div>`;
    }
    document.getElementById('chatArea').innerHTML = mhtml;
    const ca = document.getElementById('chatArea'); ca.scrollTop = ca.scrollHeight;

    // Input
    let ihtml = '';
    if (S.step === 'desc') {
        ihtml = `<div style="display:flex;gap:0.5rem">
            <input class="form-control" id="triageDescInput" placeholder="Ex: Implanter un nouveau CRM..." onkeydown="if(event.key==='Enter')triageDesc()" style="flex:1">
            <button class="btn btn-gold" onclick="triageDesc()">Suivant â†’</button>
        </div>`;
    } else if (S.step === 'source') {
        ihtml = '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.4rem">';
        SOURCES.forEach(s => {
            ihtml += `<button class="btn btn-secondary" style="flex-direction:column;padding:0.5rem;font-size:0.78rem" onclick="triageSrc('${s.v}')"><span style="font-size:1.15rem">${s.icon}</span>${s.l}</button>`;
        });
        ihtml += '</div>';
    } else if (S.step === 'qs') {
        ihtml = `<div style="display:flex;gap:0.6rem">
            <button class="btn btn-success" style="flex:1;font-size:1rem" onclick="triageAns(true)">âœ“ OUI</button>
            <button class="btn btn-secondary" style="flex:1;font-size:1rem" onclick="triageAns(false)">âœ— NON</button>
        </div>`;
    } else if (S.step === 'done') {
        ihtml = `<div style="display:flex;gap:0.6rem;justify-content:center">
            <button class="btn btn-secondary" onclick="resetTriage()">ğŸ”„ Nouvelle Ã©valuation</button>
            ${S.result==='project'?'<button class="btn btn-gold" onclick="goTab(\'portfolio\')">ğŸ“‹ Portefeuille â†’</button>':''}
        </div>`;
    }
    document.getElementById('chatInput').innerHTML = ihtml;

    // Tier indicator
    if (S.step === 'qs') {
        let th = '';
        [1,2,3].forEach(t => {
            th += `<div style="padding:0.2rem 0.6rem;border-radius:12px;font-size:0.72rem;font-weight:500;background:${S.tier===t?'var(--accent)':(S.tier>t?'var(--success)':'var(--border)')};color:${S.tier>=t?'var(--primary-dark)':'var(--text-dim)'}">Niv. ${t}${S.tier>t?' âœ“':''}</div>`;
        });
        document.getElementById('tierIndicator').innerHTML = th;
        document.getElementById('tierIndicator').style.display = 'flex';
    } else {
        document.getElementById('tierIndicator').style.display = 'none';
    }
}

function triageAddMsg(txt, t='bot', hl=false) { triageState.msgs.push({t,txt,hl}); }

function triageDesc() {
    const inp = document.getElementById('triageDescInput'); if(!inp||!inp.value.trim())return;
    triageState.desc = inp.value.trim();
    triageAddMsg(triageState.desc, 'user');
    triageState.step = 'source';
    setTimeout(() => { triageAddMsg("D'oÃ¹ provient cette idÃ©e/opportunitÃ©?"); renderTriage(); }, 200);
    renderTriage();
}

function triageSrc(v) {
    const s = SOURCES.find(x=>x.v===v);
    triageState.src = v;
    triageAddMsg(s.icon + ' ' + s.l, 'user');
    triageState.step = 'qs'; triageState.tier = 1; triageState.qi = 0;
    setTimeout(() => { triageAddMsg("ğŸ“‹ NIVEAU 1 â€” Filtrage rapide\nUn seul OUI = probablement un PROJET",'bot',true); renderTriage(); }, 200);
    renderTriage();
}

function triageAns(a) {
    const S = triageState;
    const qs = S.tier===1?TIER1:S.tier===2?TIER2:TIER3;
    const q = qs[S.qi]; S.ans[q.id] = a;
    triageAddMsg(a?'âœ“ OUI':'âœ— NON','user');
    const nqi = S.qi + 1;
    if (nqi >= qs.length) {
        if (S.tier===1) {
            if (TIER1.some(q=>S.ans[q.id])) { triageFinish('project'); return; }
            S.tier=2; S.qi=0;
            setTimeout(()=>{triageAddMsg("âœ“ Aucun critÃ¨re projet\nNIVEAU 2 â€” Classification",'bot',true);renderTriage();},200);
        } else if (S.tier===2) {
            if (S.ans.bug_ti) { triageFinish('it_ticket'); return; }
            if (S.ans.processus_existant && S.ans.equipe_existante) { triageFinish('operations'); return; }
            if (S.ans.processus_existant) { triageFinish('continuous_improvement'); return; }
            S.tier=3; S.qi=0;
            setTimeout(()=>{triageAddMsg("ğŸ” AmbiguÃ« â€” questions supplÃ©mentaires...",'bot',true);renderTriage();},200);
        } else {
            triageFinish(TIER3.filter(q=>S.ans[q.id]).length>=2?'project':'continuous_improvement');
            return;
        }
    } else { S.qi = nqi; }
    renderTriage();
}

function triageFinish(bk) {
    const S = triageState; const b = BRANCHES[bk]; S.result = bk; S.step = 'done';
    triageAddMsg(b.icon + ' Verdict: ' + b.label, 'bot', true);
    STATE.projects.push({ id:gid(), name:S.desc, chef:'', source:S.src, branch:bk, dealer:'', charter:{}, scores:bk==='project'?null:undefined, resources:0, triageDate:new Date().toISOString().split('T')[0] });
    saveState(); notify('"'+S.desc+'" ajoutÃ© au portefeuille'); renderTriage();
}

function resetTriage() {
    triageState = { step:'desc', desc:'', src:'', ans:{}, tier:1, qi:0, result:null, msgs:[{t:'bot',txt:'ğŸ‘‹ Bienvenue! DÃ©crivez l\'idÃ©e ou l\'opportunitÃ© Ã  Ã©valuer.',hl:true}] };
    renderTriage();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PORTFOLIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPortfolio() {
    const ap = allProj(); const np = nonProj();
    let html = '<h3 style="font-size:0.88rem;font-weight:600;color:var(--project-color);margin-bottom:0.75rem">ğŸ“‹ Projets ('+ap.length+')</h3>';
    ap.forEach(p => {
        html += `<div class="card" style="display:flex;align-items:center;gap:1rem;padding:1rem 1.25rem">
            <div style="width:5px;height:40px;border-radius:3px;background:${p.scores?'var(--success)':'var(--border)'}"></div>
            <div style="flex:1">
                <div style="font-weight:600;font-size:0.95rem">${esc(p.name)}</div>
                <div style="display:flex;gap:0.75rem;margin-top:0.2rem;font-size:0.78rem;color:var(--text-dim);align-items:center">
                    ${p.chef?'<span>Chef: '+esc(p.chef)+'</span>':''}
                    <span>${srcLabel(p.source)}</span>${dealerBadge(p.dealer)}<span>${p.triageDate||''}</span>
                </div>
            </div>
            ${p.scores?'<span class="badge badge-scored">'+pct(p.scores)+'%</span>':'<span class="badge badge-unscored">Non scorÃ©</span>'}
            <button class="btn btn-secondary" style="padding:0.35rem 0.7rem;font-size:0.78rem" onclick="openCharter('${p.id}')">Charte âœï¸</button>
            <button class="btn-remove" style="width:28px;height:28px" onclick="removeProject('${p.id}')">Ã—</button>
        </div>`;
    });
    if (np.length) {
        html += '<h3 style="font-size:0.88rem;font-weight:600;color:var(--text-dim);margin:1.25rem 0 0.75rem">Autres initiatives ('+np.length+')</h3>';
        np.forEach(p => {
            const b = BRANCHES[p.branch];
            html += `<div style="background:${b?.bg||'var(--bg-card)'};border-radius:10px;padding:0.7rem 1rem;border:1px solid var(--border);display:flex;align-items:center;gap:0.75rem;margin-bottom:0.5rem">
                <span style="font-size:1.15rem">${b?.icon||''}</span>
                <div style="flex:1"><div style="font-size:0.88rem;font-weight:500">${esc(p.name)}</div><div style="font-size:0.75rem;color:${b?.color||'var(--text-dim)'};font-weight:500">${b?.label||''}</div></div>
                <span style="font-size:0.75rem;color:var(--text-dim)">${p.triageDate||''}</span>
                <button class="btn-remove" style="width:24px;height:24px;font-size:0.8rem" onclick="removeProject('${p.id}')">Ã—</button>
            </div>`;
        });
    }
    document.getElementById('portfolioList').innerHTML = html;
}

function removeProject(id) { const n = STATE.projects.find(p=>p.id===id)?.name; STATE.projects = STATE.projects.filter(p=>p.id!==id); saveState(); renderAll(); notify('"'+n+'" retirÃ©','warn'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARTER MODAL (CharterPro-style)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCharter(id) {
    currentCharterProject = STATE.projects.find(p => p.id === id);
    if (!currentCharterProject) return;
    if (!currentCharterProject.charter) currentCharterProject.charter = {};
    charterStep = 1;
    document.getElementById('charterModalTitle').textContent = 'Charte â€” ' + currentCharterProject.name;
    renderCharterSidebar();
    renderCharterStep();
    document.getElementById('charterModal').style.display = 'flex';
}

function closeCharter() { document.getElementById('charterModal').style.display = 'none'; currentCharterProject = null; }

function renderCharterSidebar() {
    let html = '<div class="sidebar-title">Sections de la charte</div>';
    CHARTER_STEPS.forEach(s => {
        html += `<div class="step-item${charterStep===s.n?' active':''}${charterStep>s.n?' completed':''}" onclick="charterGoStep(${s.n})">
            <div class="step-number">${charterStep>s.n?'âœ“':s.n}</div>
            <div class="step-info"><h4>${s.title}</h4><p>${s.sub}</p></div>
        </div>`;
    });
    document.getElementById('charterSidebar').innerHTML = html;
}

function charterGoStep(n) { charterStep = n; renderCharterSidebar(); renderCharterStep(); }

function charterVal(field) { return currentCharterProject?.charter?.[field] || ''; }
function charterArr(field) { return currentCharterProject?.charter?.[field] || []; }

function renderCharterStep() {
    const p = currentCharterProject; const c = p.charter || {};
    let html = '';
    const sn = charterStep;

    if (sn === 1) {
        html = `<div class="step-header"><h2>Informations de base</h2><p>Commencez par les informations fondamentales du projet.</p></div>
        <div class="form-section"><div class="form-section-title">ğŸ“‹ Informations du projet</div>
            <div class="form-group"><label class="form-label">Nom du projet <span class="req">*</span></label>
                <input class="form-control" id="c_name" value="${esc(p.name)}" onchange="charterAutoSave()"></div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Type de projet</label>
                    <select class="form-control" id="c_type" onchange="charterAutoSave()">
                        <option value="">SÃ©lectionner...</option>
                        ${['Software Development','Mobile Development','Construction','Business Transformation','Marketing / Creative','Infrastructure','R&D','Autre'].map(t=>'<option value="'+t+'"'+(c.type===t?' selected':'')+'>'+t+'</option>').join('')}
                    </select></div>
                <div class="form-group"><label class="form-label">PrioritÃ©</label>
                    <select class="form-control" id="c_priority" onchange="charterAutoSave()">
                        ${['High','Medium','Low'].map(t=>'<option value="'+t+'"'+(c.priority===t?' selected':'')+'>'+t+'</option>').join('')}
                    </select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Date de dÃ©but</label><input type="date" class="form-control" id="c_startDate" value="${c.startDate||''}" onchange="charterAutoSave()"></div>
                <div class="form-group"><label class="form-label">Date fin cible</label><input type="date" class="form-control" id="c_endDate" value="${c.endDate||''}" onchange="charterAutoSave()"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Concessionnaire impactÃ©</label>
                    <select class="form-control" id="c_dealer" onchange="charterAutoSave()">
                        <option value="">SÃ©lectionner...</option>
                        ${DEALERS.map(d=>'<option value="'+d.id+'"'+(p.dealer===d.id?' selected':'')+'>'+d.icon+' '+d.label+'</option>').join('')}
                    </select></div>
                <div class="form-group"><label class="form-label">Chef de projet</label><input class="form-control" id="c_chef" value="${esc(p.chef)}" onchange="charterAutoSave()"></div>
            </div>
            <div class="form-group"><label class="form-label">Ressources (jours-personne)</label><input type="number" class="form-control" id="c_resources" value="${p.resources||0}" min="0" onchange="charterAutoSave()"></div>
        </div>`;
    } else if (sn === 2) {
        const objs = charterArr('objectives');
        html = `<div class="step-header"><h2>Sommaire & Objectifs</h2><p>DÃ©crivez ce que ce projet vise Ã  accomplir.</p></div>
        <div class="form-section"><div class="form-section-title">ğŸ“ Sommaire exÃ©cutif</div>
            <div class="form-group"><label class="form-label">Description du projet <span class="req">*</span></label>
                <textarea class="form-control" id="c_overview" onchange="charterAutoSave()" placeholder="Description de haut niveau...">${esc(c.overview||'')}</textarea>
                <p class="form-hint">Ce texte apparaÃ®tra en tÃªte de la charte. Soyez clair et convaincant.</p></div>
        </div>
        <div class="form-section"><div class="form-section-title">ğŸ¯ Objectifs du projet</div>
            <p class="form-hint" style="margin-bottom:0.75rem">Listez les objectifs spÃ©cifiques et mesurables.</p>
            <div class="dynamic-list" id="c_objectivesList">
                ${(objs.length?objs:['']).map((o,i)=>`<div class="dynamic-item"><input class="form-control" value="${esc(o)}" placeholder="Ex: RÃ©duire les tickets support de 40%" onchange="charterAutoSave()"><button class="btn-remove" onclick="this.parentElement.remove();charterAutoSave()">Ã—</button></div>`).join('')}
            </div>
            <button class="btn-add" onclick="addCharterListItem('c_objectivesList','objectif')">+ Ajouter un objectif</button>
        </div>`;
    } else if (sn === 3) {
        const dels = charterArr('deliverables');
        html = `<div class="step-header"><h2>PortÃ©e du projet</h2><p>DÃ©finissez ce qui est inclus et exclu.</p></div>
        <div class="form-section"><div class="form-section-title">âœ… Inclus dans la portÃ©e</div>
            <div class="form-group"><textarea class="form-control" id="c_inScope" onchange="charterAutoSave()" placeholder="Livrables, fonctionnalitÃ©s, paquets de travail inclus...">${esc(c.inScope||'')}</textarea></div>
        </div>
        <div class="form-section"><div class="form-section-title">âŒ Exclus de la portÃ©e</div>
            <div class="form-group"><textarea class="form-control" id="c_outOfScope" onchange="charterAutoSave()" placeholder="Ã‰lÃ©ments explicitement exclus...">${esc(c.outOfScope||'')}</textarea></div>
        </div>
        <div class="form-section"><div class="form-section-title">ğŸ“¦ Livrables clÃ©s</div>
            <div class="dynamic-list" id="c_deliverablesList">
                ${(dels.length?dels:['']).map(d=>`<div class="dynamic-item"><input class="form-control" value="${esc(d)}" placeholder="Ex: Documentation utilisateur" onchange="charterAutoSave()"><button class="btn-remove" onclick="this.parentElement.remove();charterAutoSave()">Ã—</button></div>`).join('')}
            </div>
            <button class="btn-add" onclick="addCharterListItem('c_deliverablesList','livrable')">+ Ajouter un livrable</button>
        </div>`;
    } else if (sn === 4) {
        const sth = charterArr('stakeholders');
        html = `<div class="step-header"><h2>Parties prenantes</h2><p>Identifiez le sponsor, l'Ã©quipe et les rÃ´les clÃ©s.</p></div>
        <div class="form-section"><div class="form-section-title">ğŸ‘” Sponsor & Chef de projet</div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Sponsor exÃ©cutif</label><input class="form-control" id="c_sponsor" value="${esc(c.sponsor||'')}" placeholder="Ex: Samuel Lamoureux" onchange="charterAutoSave()"></div>
                <div class="form-group"><label class="form-label">Chef de projet</label><input class="form-control" id="c_manager" value="${esc(p.chef)}" onchange="charterAutoSave()"></div>
            </div>
        </div>
        <div class="form-section"><div class="form-section-title">ğŸ‘¥ Parties prenantes</div>
            <div class="dynamic-list" id="c_stakeholdersList">
                ${(sth.length?sth:[{name:'',role:''}]).map(s=>`<div class="dynamic-item" style="flex-wrap:wrap;gap:0.4rem">
                    <input class="form-control" style="flex:2;min-width:140px" value="${esc(s.name)}" placeholder="Nom & Titre" onchange="charterAutoSave()">
                    <input class="form-control" style="flex:1;min-width:90px" value="${esc(s.role)}" placeholder="RÃ´le" onchange="charterAutoSave()">
                    <button class="btn-remove" onclick="this.parentElement.remove();charterAutoSave()">Ã—</button>
                </div>`).join('')}
            </div>
            <button class="btn-add" onclick="addCharterStakeholder()">+ Ajouter une partie prenante</button>
        </div>`;
    } else if (sn === 5) {
        const risks = charterArr('risks');
        html = `<div class="step-header"><h2>Risques & Contraintes</h2><p>Identifiez les risques et les contraintes du projet.</p></div>
        <div class="form-section"><div class="form-section-title">âš ï¸ Registre des risques</div>
            <table class="data-table" id="c_riskTable"><thead><tr><th style="width:35%">Risque</th><th style="width:15%">Impact</th><th style="width:35%">Mitigation</th><th style="width:15%"></th></tr></thead>
            <tbody>
                ${(risks.length?risks:[{risk:'',impact:'Medium',mitigation:''}]).map(r=>`<tr>
                    <td><input placeholder="DÃ©crire le risque..." value="${esc(r.risk)}" onchange="charterAutoSave()"></td>
                    <td><select onchange="charterAutoSave()"><option value="High"${r.impact==='High'?' selected':''}>Ã‰levÃ©</option><option value="Medium"${r.impact==='Medium'?' selected':''}>Moyen</option><option value="Low"${r.impact==='Low'?' selected':''}>Faible</option></select></td>
                    <td><input placeholder="StratÃ©gie de mitigation..." value="${esc(r.mitigation)}" onchange="charterAutoSave()"></td>
                    <td><button class="btn-remove" onclick="this.closest('tr').remove();charterAutoSave()">Ã—</button></td>
                </tr>`).join('')}
            </tbody></table>
            <button class="btn-add" style="margin-top:0.75rem" onclick="addCharterRisk()">+ Ajouter un risque</button>
        </div>
        <div class="form-section"><div class="form-section-title">ğŸ”’ Contraintes & HypothÃ¨ses</div>
            <div class="form-group"><label class="form-label">Contraintes</label><textarea class="form-control" id="c_constraints" onchange="charterAutoSave()" placeholder="Limitations et contraintes du projet...">${esc(c.constraints||'')}</textarea></div>
            <div class="form-group"><label class="form-label">HypothÃ¨ses</label><textarea class="form-control" id="c_assumptions" onchange="charterAutoSave()" placeholder="HypothÃ¨ses nÃ©cessaires au succÃ¨s...">${esc(c.assumptions||'')}</textarea></div>
        </div>`;
    } else if (sn === 6) {
        const ms = charterArr('milestones');
        html = `<div class="step-header"><h2>Ã‰chÃ©ancier & Budget</h2><p>DÃ©finissez les jalons, le budget et les projections financiÃ¨res.</p></div>
        <div class="form-section"><div class="form-section-title">ğŸ“… Jalons du projet</div>
            <table class="data-table" id="c_milestoneTable"><thead><tr><th style="width:40%">Phase / Jalon</th><th style="width:20%">DurÃ©e</th><th style="width:25%">Date cible</th><th style="width:15%"></th></tr></thead>
            <tbody>
                ${(ms.length?ms:[{phase:'',duration:'',date:''}]).map(m=>`<tr>
                    <td><input placeholder="Ex: Analyse des besoins" value="${esc(m.phase)}" onchange="charterAutoSave()"></td>
                    <td><input placeholder="Ex: 3 mois" value="${esc(m.duration)}" onchange="charterAutoSave()"></td>
                    <td><input placeholder="Ex: Avr 2026" value="${esc(m.date)}" onchange="charterAutoSave()"></td>
                    <td><button class="btn-remove" onclick="this.closest('tr').remove();charterAutoSave()">Ã—</button></td>
                </tr>`).join('')}
            </tbody></table>
            <button class="btn-add" style="margin-top:0.75rem" onclick="addCharterMilestone()">+ Ajouter un jalon</button>
        </div>
        <div class="form-section"><div class="form-section-title">ğŸ’° Budget & Finances</div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Budget total</label><input class="form-control" id="c_budget" value="${esc(c.budget||'')}" placeholder="Ex: 150 000$" onchange="charterAutoSave();charterCalcROI()"></div>
                <div class="form-group"><label class="form-label">BÃ©nÃ©fices annuels attendus</label><input class="form-control" id="c_benefits" value="${esc(c.benefits||'')}" placeholder="Ex: 200 000$" onchange="charterAutoSave();charterCalcROI()"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">DurÃ©e du projet (annÃ©es)</label><input type="number" class="form-control" id="c_duration" value="${c.duration||''}" step="0.1" placeholder="Ex: 1.5" onchange="charterAutoSave();charterCalcROI()"></div>
                <div class="form-group"><label class="form-label">PÃ©riode de bÃ©nÃ©fices (annÃ©es)</label><input type="number" class="form-control" id="c_benefitPeriod" value="${c.benefitPeriod||''}" placeholder="Ex: 3" onchange="charterAutoSave();charterCalcROI()"></div>
            </div>
        </div>
        <div class="form-section"><div class="form-section-title">ğŸ“Š MÃ©triques calculÃ©es</div>
            <div class="metrics-grid"><div class="metric-card"><div class="metric-value" id="c_roi">--%</div><div class="metric-label">ROI</div></div>
                <div class="metric-card"><div class="metric-value" id="c_payback">-- ans</div><div class="metric-label">PÃ©riode de retour</div></div>
                <div class="metric-card"><div class="metric-value" id="c_npv">$--</div><div class="metric-label">VAN</div></div></div>
            <p class="form-hint">CalculÃ©es automatiquement Ã  partir du budget et des bÃ©nÃ©fices.</p>
        </div>`;
    } else if (sn === 7) {
        charterAutoSave();
        html = `<div class="step-header"><h2>AperÃ§u & Export</h2><p>RÃ©visez la charte et exportez en PDF.</p></div>
        <div class="no-print" style="margin-bottom:1rem;display:flex;gap:0.75rem">
            <button class="btn btn-success" onclick="window.print()">ğŸ“„ Exporter PDF</button>
            <button class="btn btn-gold" onclick="saveCharter()">ğŸ’¾ Sauvegarder</button>
        </div>
        ${buildCharterPreview()}`;
    }

    // Navigation
    html += `<div class="step-nav no-print">
        ${sn>1?'<button class="btn btn-secondary" onclick="charterGoStep('+(sn-1)+')">â† PrÃ©cÃ©dent</button>':'<div></div>'}
        ${sn<7?'<button class="btn btn-gold" onclick="charterGoStep('+(sn+1)+')">Suivant â†’</button>':'<button class="btn btn-gold" onclick="saveCharter()">ğŸ’¾ Sauvegarder & Fermer</button>'}
    </div>`;
    document.getElementById('charterMain').innerHTML = html;
    document.getElementById('charterMain').scrollTop = 0;

    if (sn === 6) charterCalcROI();
}

function charterCalcROI() {
    const bStr = (document.getElementById('c_budget')?.value||'').replace(/[^0-9.]/g,'');
    const benStr = (document.getElementById('c_benefits')?.value||'').replace(/[^0-9.]/g,'');
    const dur = parseFloat(document.getElementById('c_duration')?.value) || 1;
    const bp = parseFloat(document.getElementById('c_benefitPeriod')?.value) || 3;
    const b = parseFloat(bStr)||0; const an = parseFloat(benStr)||0;
    if (b>0 && an>0) {
        const roi = ((an*bp - b)/b)*100;
        const pay = b/an;
        let npv = -b; for(let i=1;i<=bp;i++) npv += an/Math.pow(1.1,i);
        document.getElementById('c_roi').textContent = roi.toFixed(1)+'%';
        document.getElementById('c_payback').textContent = pay.toFixed(1)+' ans';
        document.getElementById('c_npv').textContent = '$'+fmt(Math.round(npv));
    }
}

function charterAutoSave() {
    if (!currentCharterProject) return;
    const c = currentCharterProject.charter || {};
    const sn = charterStep;
    if (sn===1) {
        const nameEl = document.getElementById('c_name');
        if(nameEl) currentCharterProject.name = nameEl.value;
        c.type = document.getElementById('c_type')?.value||'';
        c.priority = document.getElementById('c_priority')?.value||'';
        c.startDate = document.getElementById('c_startDate')?.value||'';
        c.endDate = document.getElementById('c_endDate')?.value||'';
        currentCharterProject.chef = document.getElementById('c_chef')?.value||'';
        currentCharterProject.dealer = document.getElementById('c_dealer')?.value||'';
        currentCharterProject.resources = parseInt(document.getElementById('c_resources')?.value)||0;
    } else if (sn===2) {
        c.overview = document.getElementById('c_overview')?.value||'';
        c.objectives = collectDynList('c_objectivesList');
    } else if (sn===3) {
        c.inScope = document.getElementById('c_inScope')?.value||'';
        c.outOfScope = document.getElementById('c_outOfScope')?.value||'';
        c.deliverables = collectDynList('c_deliverablesList');
    } else if (sn===4) {
        c.sponsor = document.getElementById('c_sponsor')?.value||'';
        currentCharterProject.chef = document.getElementById('c_manager')?.value||currentCharterProject.chef;
        c.stakeholders = collectStakeholders('c_stakeholdersList');
    } else if (sn===5) {
        c.risks = collectRisks('c_riskTable');
        c.constraints = document.getElementById('c_constraints')?.value||'';
        c.assumptions = document.getElementById('c_assumptions')?.value||'';
    } else if (sn===6) {
        c.milestones = collectMilestones('c_milestoneTable');
        c.budget = document.getElementById('c_budget')?.value||'';
        c.benefits = document.getElementById('c_benefits')?.value||'';
        c.duration = document.getElementById('c_duration')?.value||'';
        c.benefitPeriod = document.getElementById('c_benefitPeriod')?.value||'';
    }
    currentCharterProject.charter = c;
    document.getElementById('charterSaveStatus').textContent = 'âœ“ SauvegardÃ©';
    document.getElementById('charterSaveStatus').style.color = '#22c55e';
}

function saveCharter() { charterAutoSave(); saveState(); renderAll(); closeCharter(); notify('Charte sauvegardÃ©e'); }

// Dynamic list helpers
function collectDynList(id) { const items=[]; document.querySelectorAll('#'+id+' .dynamic-item input').forEach(inp=>{if(inp.value.trim())items.push(inp.value.trim());}); return items; }
function collectStakeholders(id) { const items=[]; document.querySelectorAll('#'+id+' .dynamic-item').forEach(item=>{const inps=item.querySelectorAll('input');if(inps[0]?.value.trim()) items.push({name:inps[0].value.trim(),role:inps[1]?.value.trim()||''});}); return items; }
function collectRisks(id) { const items=[]; document.querySelectorAll('#'+id+' tbody tr').forEach(row=>{const inps=row.querySelectorAll('input');const sel=row.querySelector('select');if(inps[0]?.value.trim()) items.push({risk:inps[0].value.trim(),impact:sel?.value||'Medium',mitigation:inps[1]?.value.trim()||''});}); return items; }
function collectMilestones(id) { const items=[]; document.querySelectorAll('#'+id+' tbody tr').forEach(row=>{const inps=row.querySelectorAll('input');if(inps[0]?.value.trim()) items.push({phase:inps[0].value.trim(),duration:inps[1]?.value.trim()||'',date:inps[2]?.value.trim()||''});}); return items; }

function addCharterListItem(listId) { const list=document.getElementById(listId); const div=document.createElement('div'); div.className='dynamic-item'; div.innerHTML='<input class="form-control" placeholder="..." onchange="charterAutoSave()"><button class="btn-remove" onclick="this.parentElement.remove();charterAutoSave()">Ã—</button>'; list.appendChild(div); }
function addCharterStakeholder() { const list=document.getElementById('c_stakeholdersList'); const div=document.createElement('div'); div.className='dynamic-item'; div.style.cssText='flex-wrap:wrap;gap:0.4rem'; div.innerHTML='<input class="form-control" style="flex:2;min-width:140px" placeholder="Nom & Titre" onchange="charterAutoSave()"><input class="form-control" style="flex:1;min-width:90px" placeholder="RÃ´le" onchange="charterAutoSave()"><button class="btn-remove" onclick="this.parentElement.remove();charterAutoSave()">Ã—</button>'; list.appendChild(div); }
function addCharterRisk() { const tb=document.querySelector('#c_riskTable tbody'); const tr=document.createElement('tr'); tr.innerHTML='<td><input placeholder="DÃ©crire le risque..." onchange="charterAutoSave()"></td><td><select onchange="charterAutoSave()"><option value="High">Ã‰levÃ©</option><option value="Medium" selected>Moyen</option><option value="Low">Faible</option></select></td><td><input placeholder="StratÃ©gie..." onchange="charterAutoSave()"></td><td><button class="btn-remove" onclick="this.closest(\'tr\').remove();charterAutoSave()">Ã—</button></td>'; tb.appendChild(tr); }
function addCharterMilestone() { const tb=document.querySelector('#c_milestoneTable tbody'); const tr=document.createElement('tr'); tr.innerHTML='<td><input placeholder="Phase..." onchange="charterAutoSave()"></td><td><input placeholder="DurÃ©e..." onchange="charterAutoSave()"></td><td><input placeholder="Date..." onchange="charterAutoSave()"></td><td><button class="btn-remove" onclick="this.closest(\'tr\').remove();charterAutoSave()">Ã—</button></td>'; tb.appendChild(tr); }

function buildCharterPreview() {
    const p=currentCharterProject; const c=p?.charter||{};
    const bStr=(c.budget||'').replace(/[^0-9.]/g,''); const benStr=(c.benefits||'').replace(/[^0-9.]/g,'');
    const b=parseFloat(bStr)||0; const an=parseFloat(benStr)||0; const bp=parseFloat(c.benefitPeriod)||3;
    let roi='--',pay='--',npv='--';
    if(b>0&&an>0){ roi=((an*bp-b)/b*100).toFixed(1)+'%'; pay=(b/an).toFixed(1)+' ans'; let n=-b;for(let i=1;i<=bp;i++)n+=an/Math.pow(1.1,i);npv='$'+fmt(Math.round(n)); }

    let h = `<div class="preview-panel"><div class="preview-header">
        <div style="font-size:1.5rem;margin-bottom:0.3rem">ğŸ“‹</div>
        <h1 class="preview-title">${esc(p.name)||'Charte de projet'}</h1>
        <p class="preview-subtitle">${esc(c.type)||'Type de projet'}</p>
        <div class="preview-meta"><span>Date: ${c.startDate?new Date(c.startDate).toLocaleDateString('fr-CA',{month:'long',year:'numeric'}):'--'}</span><span>PrioritÃ©: ${c.priority||'--'}</span></div>
    </div><div class="preview-body">`;
    if(c.overview) h+=`<div class="preview-section"><h3 class="preview-section-title">Sommaire du projet</h3><p>${esc(c.overview)}</p></div>`;
    if(b>0) h+=`<div class="preview-section"><h3 class="preview-section-title">Sommaire financier</h3><div class="preview-metrics"><div class="preview-metric"><div class="preview-metric-value">${roi}</div><div class="preview-metric-label">ROI</div></div><div class="preview-metric"><div class="preview-metric-value">${esc(c.budget)||'--'}</div><div class="preview-metric-label">Budget</div></div><div class="preview-metric"><div class="preview-metric-value">${pay}</div><div class="preview-metric-label">Retour</div></div></div>
        <table class="preview-table"><tr><th>MÃ©trique</th><th>Valeur</th></tr><tr><td>VAN</td><td>${npv}</td></tr><tr><td>Sponsor</td><td>${esc(c.sponsor)||'--'}</td></tr><tr><td>Chef de projet</td><td>${esc(p.chef)||'--'}</td></tr></table></div>`;
    if(c.objectives?.length) h+=`<div class="preview-section"><h3 class="preview-section-title">Objectifs</h3><ul class="preview-list">${c.objectives.map(o=>'<li>'+esc(o)+'</li>').join('')}</ul></div>`;
    if(c.inScope||c.outOfScope) h+=`<div class="preview-section"><h3 class="preview-section-title">PortÃ©e</h3>${c.inScope?'<p><b>Inclus:</b> '+esc(c.inScope)+'</p>':''}${c.outOfScope?'<p><b>Exclu:</b> '+esc(c.outOfScope)+'</p>':''}</div>`;
    if(c.deliverables?.length) h+=`<div class="preview-section"><h3 class="preview-section-title">Livrables clÃ©s</h3><ul class="preview-list">${c.deliverables.map(d=>'<li>'+esc(d)+'</li>').join('')}</ul></div>`;
    if(c.risks?.length&&c.risks[0]?.risk) h+=`<div class="preview-section"><h3 class="preview-section-title">Ã‰valuation des risques</h3><table class="preview-table"><tr><th>Risque</th><th>Impact</th><th>Mitigation</th></tr>${c.risks.filter(r=>r.risk).map(r=>'<tr><td>'+esc(r.risk)+'</td><td>'+r.impact+'</td><td>'+esc(r.mitigation)+'</td></tr>').join('')}</table></div>`;
    if(c.milestones?.length&&c.milestones[0]?.phase) h+=`<div class="preview-section"><h3 class="preview-section-title">Ã‰chÃ©ancier</h3><table class="preview-table"><tr><th>Phase</th><th>DurÃ©e</th><th>Cible</th></tr>${c.milestones.filter(m=>m.phase).map(m=>'<tr><td>'+esc(m.phase)+'</td><td>'+esc(m.duration)+'</td><td>'+esc(m.date)+'</td></tr>').join('')}</table></div>`;
    if(c.constraints||c.assumptions) h+=`<div class="preview-section"><h3 class="preview-section-title">Contraintes & HypothÃ¨ses</h3>${c.constraints?'<p><b>Contraintes:</b> '+esc(c.constraints)+'</p>':''}${c.assumptions?'<p><b>HypothÃ¨ses:</b> '+esc(c.assumptions)+'</p>':''}</div>`;
    h+=`</div></div>`;
    return h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCORING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderScoring() {
    const ap = [...allProj()].sort((a,b)=>weightedScore(b.scores||{})-weightedScore(a.scores||{}));
    const w = STATE.weights;
    const totalW = STATE.criteria.reduce((s,c)=>s+(w[c.id]||0),0);
    const warnW = totalW !== 100;

    let html = '<table class="scoring-table"><thead><tr><th>#</th><th>Projet</th><th>Chef</th>';
    STATE.criteria.forEach(c => html += `<th title="${c.hint}"><div>${c.short}</div><div style="font-size:0.65rem;font-weight:400;opacity:0.85;margin-top:2px">${w[c.id]||0}%</div></th>`);
    html += '<th style="background:var(--primary-light)"><div>PondÃ©rÃ©</div><div style="font-size:0.65rem;font-weight:400;opacity:0.85;margin-top:2px">/10</div></th><th>%</th><th>h/mois</th></tr></thead><tbody>';
    ap.forEach((p,i) => {
        const sc=p.scores||{}; const ws=weightedScore(sc); const pc=pct(sc); const pn=parseFloat(pc);
        html += `<tr><td style="text-align:center"><span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:6px;background:rgba(66,153,225,0.15);color:var(--project-color);font-size:0.75rem;font-weight:700">${i+1}</span></td>
        <td style="font-weight:500">${esc(p.name)} ${dealerBadge(p.dealer)}</td><td style="color:var(--text-dim)">${esc(p.chef)||'â€”'}</td>`;
        STATE.criteria.forEach(c => {
            html += `<td style="text-align:center"><input type="number" min="1" max="10" class="scoring-input ${sc[c.id]?scoreClass(sc[c.id]):''}" value="${sc[c.id]||''}" onchange="updateScore('${p.id}','${c.id}',this.value)"></td>`;
        });
        html += `<td style="text-align:center;font-weight:700;font-size:1.05rem;color:var(--accent)">${ws?ws.toFixed(1):'â€”'}</td>
        <td style="text-align:center"><span class="badge ${pn>=80?'badge-go':pn>=65?'badge-unscored':'badge-attente'}">${ws?pc+'%':'â€”'}</span></td>
        <td style="text-align:center"><span style="font-size:0.85rem;color:var(--text-dim);cursor:pointer" title="Modifier dans l'onglet Affectation" onclick="goTab('assign')">${MONTHS.reduce((s,m) => s + getProjectTotalHrs(p.id, m), 0) || 'â€”'}<span style="font-size:0.65rem">h/an</span></span></td></tr>`;
    });
    html += '</tbody></table>';

    // Weight warning
    if (warnW) {
        html += `<div style="margin-top:0.75rem;padding:0.6rem 1rem;background:#fef3c7;border:1px solid #fbbf24;border-radius:8px;font-size:0.82rem;color:#92400e">âš ï¸ Les poids totalisent <b>${totalW}%</b> au lieu de 100%. <button onclick="openCriteriaEditor()" style="margin-left:0.5rem;background:var(--accent);color:white;border:none;padding:0.25rem 0.65rem;border-radius:6px;cursor:pointer;font-size:0.78rem;font-weight:600">Ajuster les poids</button></div>`;
    }
    document.getElementById('scoringTableWrap').innerHTML = html;

    // Legend + Score Guide
    let lhtml = '';

    // Score guide
    lhtml += `<div style="margin-bottom:1rem;padding:1rem;background:#f0f9ff;border:1px solid #bae6fd;border-radius:10px">
        <div style="font-size:0.78rem;font-weight:600;color:var(--primary);text-transform:uppercase;margin-bottom:0.5rem">ğŸ“ Guide de notation</div>
        <div style="display:flex;gap:1.5rem;flex-wrap:wrap">
            <div style="display:flex;align-items:center;gap:0.5rem"><span class="scoring-input score-high" style="display:inline-flex;align-items:center;justify-content:center;pointer-events:none">10</span><span style="font-size:0.82rem;color:var(--text-muted)">Parfaitement conforme</span></div>
            <div style="display:flex;align-items:center;gap:0.5rem"><span class="scoring-input score-high" style="display:inline-flex;align-items:center;justify-content:center;pointer-events:none">8</span><span style="font-size:0.82rem;color:var(--text-muted)">TrÃ¨s conforme</span></div>
            <div style="display:flex;align-items:center;gap:0.5rem"><span class="scoring-input score-mid" style="display:inline-flex;align-items:center;justify-content:center;pointer-events:none">5</span><span style="font-size:0.82rem;color:var(--text-muted)">Partiellement conforme</span></div>
            <div style="display:flex;align-items:center;gap:0.5rem"><span class="scoring-input score-low" style="display:inline-flex;align-items:center;justify-content:center;pointer-events:none">3</span><span style="font-size:0.82rem;color:var(--text-muted)">Peu conforme</span></div>
            <div style="display:flex;align-items:center;gap:0.5rem"><span class="scoring-input score-low" style="display:inline-flex;align-items:center;justify-content:center;pointer-events:none">1</span><span style="font-size:0.82rem;color:var(--text-muted)">Non conforme</span></div>
        </div>
    </div>`;

    // Criteria legend + edit button
    lhtml += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
        <div style="font-size:0.78rem;font-weight:600;color:var(--text-dim);text-transform:uppercase">LÃ©gende des critÃ¨res</div>
        <button onclick="openCriteriaEditor()" class="btn" style="padding:0.3rem 0.75rem;font-size:0.78rem;background:#f0fdf4;color:var(--success);border:1px solid #bbf7d0">âš™ï¸ GÃ©rer critÃ¨res & poids</button>
    </div>`;
    lhtml += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem">';
    STATE.criteria.forEach(c => lhtml += `<div style="font-size:0.78rem;color:var(--text-muted)"><b>${c.short}</b> (${w[c.id]||0}%) â€” ${c.label}<br><span style="color:var(--text-dim)">${c.hint}</span></div>`);
    lhtml += '</div>';
    document.getElementById('criteriaLegend').innerHTML = lhtml;
}

function updateScore(id, crit, val) {
    const p = STATE.projects.find(x=>x.id===id); if(!p) return;
    if(!p.scores) p.scores = {};
    p.scores[crit] = Math.min(10, Math.max(0, parseInt(val)||0));
    saveState(); renderScoring(); renderAll();
}
function updateRes(id, val) { const p = STATE.projects.find(x=>x.id===id); if(p) p.resources = parseInt(val)||0; saveState(); renderAll(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CRITERIA & WEIGHTS EDITOR (Combined)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCriteriaEditor() {
    let html = `<div class="modal-overlay" id="criteriaOverlay" onclick="if(event.target===this)closeCriteria()">
    <div class="modal-box" style="max-width:820px;max-height:90vh;overflow-y:auto">
        <div class="charter-modal-header">
            <div style="display:flex;align-items:center;gap:0.6rem">
                <div class="charter-logo-icon">âš™ï¸</div>
                <span class="charter-modal-title">CritÃ¨res de scoring & pondÃ©ration</span>
            </div>
            <div style="display:flex;gap:0.5rem;align-items:center">
                <button class="charter-btn-close" onclick="closeCriteria()">âœ• Fermer</button>
                <button class="charter-btn-save" onclick="saveCriteria()">ğŸ’¾ Sauvegarder</button>
            </div>
        </div>
        <div style="padding:1.5rem">
            <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:0.25rem">Personnalisez les critÃ¨res et leur importance relative pour le calcul du score pondÃ©rÃ©.</p>
            <p style="font-size:0.78rem;color:var(--text-dim);margin-bottom:1.25rem;font-style:italic">ğŸ”„ ValidÃ© 1 fois par trimestre par le comitÃ© exÃ©cutif. Les poids doivent totaliser 100%.</p>

            <table style="width:100%;border-collapse:collapse" id="criteriaTable">
            <thead><tr>
                <th style="text-align:center;padding:0.5rem;font-size:0.75rem;font-weight:600;color:var(--text-dim);border-bottom:2px solid var(--border);width:30px">#</th>
                <th style="text-align:left;padding:0.5rem;font-size:0.75rem;font-weight:600;color:var(--text-dim);border-bottom:2px solid var(--border);width:80px">AbrÃ©v.</th>
                <th style="text-align:left;padding:0.5rem;font-size:0.75rem;font-weight:600;color:var(--text-dim);border-bottom:2px solid var(--border)">Nom complet</th>
                <th style="text-align:left;padding:0.5rem;font-size:0.75rem;font-weight:600;color:var(--text-dim);border-bottom:2px solid var(--border)">Description / Aide</th>
                <th style="text-align:center;padding:0.5rem;font-size:0.75rem;font-weight:600;color:var(--text-dim);border-bottom:2px solid var(--border);width:75px">Poids %</th>
                <th style="text-align:center;padding:0.5rem;font-size:0.75rem;font-weight:600;color:var(--text-dim);border-bottom:2px solid var(--border);width:45px"></th>
            </tr></thead>
            <tbody id="criteriaRows">`;

    STATE.criteria.forEach((c, i) => {
        html += renderCriteriaRow(c, i);
    });

    html += `</tbody>
            <tfoot><tr>
                <td colspan="4" style="padding:0.7rem 0.6rem;font-weight:700;text-align:right;border-top:2px solid var(--border)">Total des poids</td>
                <td style="padding:0.7rem 0.6rem;text-align:center;border-top:2px solid var(--border)">
                    <span id="critWeightTotal" style="font-size:1.1rem;font-weight:700">100%</span>
                </td>
                <td style="border-top:2px solid var(--border)"></td>
            </tr></tfoot>
            </table>

            <div style="margin-top:1rem;display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center">
                <button onclick="addCriterion()" class="btn" style="font-size:0.82rem;padding:0.4rem 0.85rem;background:var(--primary);color:white">+ Ajouter un critÃ¨re</button>
                <div style="border-left:1px solid var(--border);height:24px;margin:0 0.5rem"></div>
                <button onclick="distributeWeightsEqual()" class="btn btn-secondary" style="font-size:0.78rem;padding:0.35rem 0.75rem">â†º RÃ©partition Ã©gale</button>
                <button onclick="resetCriteriaDefault()" class="btn btn-secondary" style="font-size:0.78rem;padding:0.35rem 0.75rem">â†º Valeurs par dÃ©faut</button>
            </div>

            <div style="margin-top:1rem;padding:0.6rem 0.85rem;background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;font-size:0.78rem;color:#0369a1">
                ğŸ’¡ <b>Conseil:</b> Les critÃ¨res les plus importants pour votre stratÃ©gie devraient avoir un poids plus Ã©levÃ©. Le total doit Ã©galer 100%.
            </div>
        </div>
    </div></div>`;

    document.body.insertAdjacentHTML('beforeend', html);
    updateCriteriaWeightTotal();
}

function renderCriteriaRow(c, i) {
    const w = STATE.weights[c.id] || 0;
    return `<tr data-id="${c.id}">
        <td style="text-align:center;padding:0.5rem;border-bottom:1px solid var(--border);font-weight:600;color:var(--text-dim)">${i+1}</td>
        <td style="padding:0.5rem;border-bottom:1px solid var(--border)">
            <input type="text" class="crit-short" value="${esc(c.short)}" maxlength="10" style="width:70px;padding:0.35rem;border-radius:6px;border:1px solid var(--border);font-size:0.85rem;font-weight:600">
        </td>
        <td style="padding:0.5rem;border-bottom:1px solid var(--border)">
            <input type="text" class="crit-label" value="${esc(c.label)}" style="width:100%;padding:0.35rem;border-radius:6px;border:1px solid var(--border);font-size:0.85rem">
        </td>
        <td style="padding:0.5rem;border-bottom:1px solid var(--border)">
            <input type="text" class="crit-hint" value="${esc(c.hint)}" style="width:100%;padding:0.35rem;border-radius:6px;border:1px solid var(--border);font-size:0.82rem;color:var(--text-muted)">
        </td>
        <td style="text-align:center;padding:0.5rem;border-bottom:1px solid var(--border)">
            <input type="number" class="crit-weight" min="0" max="100" value="${w}" style="width:58px;padding:0.35rem;border-radius:6px;border:1px solid var(--border);font-size:0.9rem;font-weight:600;text-align:center" oninput="updateCriteriaWeightTotal()">
        </td>
        <td style="text-align:center;padding:0.5rem;border-bottom:1px solid var(--border)">
            <button onclick="removeCriterion('${c.id}')" class="btn-remove" title="Supprimer" style="width:28px;height:28px">Ã—</button>
        </td>
    </tr>`;
}

function updateCriteriaWeightTotal() {
    let total = 0;
    document.querySelectorAll('#criteriaRows .crit-weight').forEach(input => {
        total += parseInt(input.value) || 0;
    });
    const el = document.getElementById('critWeightTotal');
    if (el) {
        el.textContent = total + '%';
        el.style.color = total === 100 ? 'var(--success)' : 'var(--error)';
    }
}

function addCriterion() {
    const newId = 'crit_' + Date.now();
    const newCrit = { id: newId, label: 'Nouveau critÃ¨re', short: 'Nouv.', hint: 'Description du critÃ¨re' };
    STATE.criteria.push(newCrit);
    STATE.weights[newId] = 0;
    
    const tbody = document.getElementById('criteriaRows');
    tbody.insertAdjacentHTML('beforeend', renderCriteriaRow(newCrit, STATE.criteria.length - 1));
    updateCriteriaWeightTotal();
}

function removeCriterion(id) {
    if (document.querySelectorAll('#criteriaRows tr').length <= 1) {
        alert('Vous devez conserver au moins un critÃ¨re.');
        return;
    }
    if (!confirm('Supprimer ce critÃ¨re? Les scores existants pour ce critÃ¨re seront perdus.')) return;
    
    const row = document.querySelector(`#criteriaRows tr[data-id="${id}"]`);
    if (row) row.remove();
    
    document.querySelectorAll('#criteriaRows tr').forEach((tr, i) => {
        tr.querySelector('td').textContent = i + 1;
    });
    updateCriteriaWeightTotal();
}

function distributeWeightsEqual() {
    const rows = document.querySelectorAll('#criteriaRows tr');
    const count = rows.length;
    if (count === 0) return;
    
    const eq = Math.floor(100 / count);
    const rem = 100 - eq * count;
    
    rows.forEach((row, i) => {
        row.querySelector('.crit-weight').value = eq + (i < rem ? 1 : 0);
    });
    updateCriteriaWeightTotal();
}

function resetCriteriaDefault() {
    if (!confirm('RÃ©initialiser tous les critÃ¨res aux valeurs par dÃ©faut? Les modifications seront perdues.')) return;
    STATE.criteria = JSON.parse(JSON.stringify(DEFAULT_CRITERIA));
    STATE.weights = {...DEFAULT_WEIGHTS};
    closeCriteria();
    openCriteriaEditor();
}

function saveCriteria() {
    const rows = document.querySelectorAll('#criteriaRows tr');
    const newCriteria = [];
    const newWeights = {};
    let totalWeight = 0;
    
    rows.forEach((row, i) => {
        const id = row.dataset.id;
        const short = row.querySelector('.crit-short').value.trim() || ('C'+(i+1));
        const label = row.querySelector('.crit-label').value.trim() || 'CritÃ¨re '+(i+1);
        const hint = row.querySelector('.crit-hint').value.trim() || '';
        const weight = parseInt(row.querySelector('.crit-weight').value) || 0;
        
        newCriteria.push({ id, short, label, hint });
        newWeights[id] = weight;
        totalWeight += weight;
    });
    
    if (newCriteria.length === 0) {
        alert('Vous devez avoir au moins un critÃ¨re.');
        return;
    }
    
    if (totalWeight !== 100) {
        if (!confirm(`Les poids totalisent ${totalWeight}% au lieu de 100%. Sauvegarder quand mÃªme?`)) return;
    }
    
    const removedIds = STATE.criteria.map(c => c.id).filter(id => !newCriteria.find(nc => nc.id === id));
    if (removedIds.length > 0) {
        STATE.projects.forEach(p => {
            if (p.scores) {
                removedIds.forEach(id => delete p.scores[id]);
            }
        });
    }
    
    STATE.criteria = newCriteria;
    STATE.weights = newWeights;
    
    saveState();
    closeCriteria();
    renderScoring();
    renderAll();
    notify('CritÃ¨res et poids mis Ã  jour');
}

function closeCriteria() {
    document.getElementById('criteriaOverlay')?.remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PEOPLE: Named Resources + Availability
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPeople() {
    const people = STATE.people;
    
    // Table with 12 month columns
    let html = '<div class="card" style="padding:0.75rem"><div style="overflow-x:auto"><table class="scoring-table" style="min-width:900px"><thead><tr>';
    html += '<th style="text-align:left;min-width:100px;position:sticky;left:0;background:var(--primary);z-index:3;color:white">Nom</th>';
    html += '<th style="text-align:left;min-width:90px;color:white">Fonction</th>';
    
    // Month headers
    MONTHS.forEach(m => {
        html += `<th style="text-align:center;min-width:52px;font-size:0.72rem;color:white" title="${MONTH_LABELS[m]}">${MONTH_LABELS[m]}</th>`;
    });
    html += '<th style="text-align:center;min-width:55px;background:var(--primary-light);color:white">AnnÃ©e</th>';
    html += '<th style="text-align:center;width:35px;color:white"></th>';
    html += '</tr></thead><tbody>';

    // Group by function
    const grouped = {};
    people.forEach(p => {
        if (!grouped[p.funcId]) grouped[p.funcId] = [];
        grouped[p.funcId].push(p);
    });

    const funcOrder = FUNCTIONS.map(f=>f.id).filter(fid => grouped[fid]);
    Object.keys(grouped).forEach(fid => { if(!funcOrder.includes(fid)) funcOrder.push(fid); });

    funcOrder.forEach(fid => {
        const fPeople = grouped[fid] || [];
        const f = FUNCTIONS.find(x=>x.id===fid);
        // Function header
        const colSpan = 3 + MONTHS.length + 1;
        html += `<tr style="background:var(--bg-card-hover)"><td colspan="${colSpan}" style="font-weight:700;font-size:0.82rem;padding:0.5rem 0.6rem;color:var(--text-dim)"><span style="font-size:1rem;margin-right:0.3rem">${f?.icon||'ğŸ‘¤'}</span>${f?.label||fid}</td></tr>`;
        
        fPeople.forEach(p => {
            const yearAvail = getPersonYearlyAvail(p.id);
            const yearAssigned = getPersonYearlyAssigned(p.id);
            
            html += `<tr>
                <td style="font-weight:500;padding-left:1.2rem;position:sticky;left:0;background:var(--bg-card);z-index:1"><input type="text" value="${esc(p.name)}" style="border:none;background:transparent;font-weight:500;font-size:inherit;color:inherit;width:90px;padding:0.2rem 0" onchange="updatePersonName('${p.id}',this.value)"></td>
                <td style="font-size:0.75rem;color:var(--text-dim)">${f?.icon||''} ${(f?.label||'').split('â€”')[0].trim().substring(0,12)}</td>`;
            
            // Monthly availability inputs
            MONTHS.forEach(m => {
                const avail = p.availByMonth?.[m] || 0;
                const assigned = getPersonAssignedHrs(p.id, m);
                const over = assigned > avail;
                html += `<td style="text-align:center">
                    <input type="number" min="0" max="200" step="1" class="scoring-input" style="width:42px;font-size:0.75rem;padding:0.2rem;${over?'border-color:var(--error);background:#fef2f2':''}" value="${avail}" onchange="updatePersonAvailMonth('${p.id}','${m}',this.value)" title="Dispo: ${avail}h | AssignÃ©: ${assigned}h">
                </td>`;
            });
            
            // Yearly total
            const yearPct = yearAvail > 0 ? Math.round(yearAssigned / yearAvail * 100) : 0;
            const yearOver = yearAssigned > yearAvail;
            html += `<td style="text-align:center;font-weight:700;font-size:0.78rem;color:${yearOver?'var(--error)':'var(--success)'}" title="${yearAssigned}h assignÃ© / ${yearAvail}h dispo">${yearAvail}h<div style="font-size:0.65rem;font-weight:400;color:var(--text-dim)">${yearPct}%</div></td>`;
            
            html += `<td style="text-align:center"><button class="btn-remove" style="width:24px;height:24px;font-size:0.9rem" onclick="removePerson('${p.id}')" title="Supprimer">Ã—</button></td>`;
            html += '</tr>';
        });
    });

    // Totals row
    html += `<tr style="border-top:2px solid var(--border);background:var(--bg-card-hover)">
        <td style="font-weight:700;position:sticky;left:0;background:var(--bg-card-hover);z-index:1" colspan="2">Total (${people.length})</td>`;
    
    let grandAvail = 0, grandAssigned = 0;
    MONTHS.forEach(m => {
        const mAvail = getTotalAvailableHrs(m);
        const mAssigned = people.reduce((s,p) => s + getPersonAssignedHrs(p.id, m), 0);
        const mOver = mAssigned > mAvail;
        grandAvail += mAvail;
        grandAssigned += mAssigned;
        html += `<td style="text-align:center;font-weight:700;font-size:0.72rem;color:${mOver?'var(--error)':'var(--text-muted)'}">${mAvail}h</td>`;
    });
    html += `<td style="text-align:center;font-weight:700;font-size:0.82rem;color:var(--primary)">${grandAvail}h</td><td></td></tr>`;
    
    // Assigned row
    html += `<tr style="background:var(--bg-card-hover)">
        <td style="font-weight:600;font-size:0.78rem;color:var(--text-dim);position:sticky;left:0;background:var(--bg-card-hover);z-index:1" colspan="2">AssignÃ©</td>`;
    MONTHS.forEach(m => {
        const mAvail = getTotalAvailableHrs(m);
        const mAssigned = people.reduce((s,p) => s + getPersonAssignedHrs(p.id, m), 0);
        const mOver = mAssigned > mAvail;
        html += `<td style="text-align:center;font-size:0.72rem;font-weight:600;color:${mOver?'var(--error)':'var(--accent)'}">${mAssigned}h</td>`;
    });
    html += `<td style="text-align:center;font-weight:700;font-size:0.82rem;color:var(--accent)">${grandAssigned}h</td><td></td></tr>`;
    
    html += '</tbody></table></div></div>';
    
    // Legend
    html += `<div style="margin-top:0.5rem;display:flex;gap:1rem;font-size:0.72rem;color:var(--text-dim)">
        <span>ğŸŸ¡ Mois Ã  capacitÃ© rÃ©duite (vacances)</span>
        <span>ğŸ”´ Cellule rouge = surcharge</span>
    </div>`;
    
    document.getElementById('peopleTableWrap').innerHTML = html;

    // Summary card - find months with bottlenecks
    const bottleneckMonths = MONTHS.filter(m => {
        const mAvail = getTotalAvailableHrs(m);
        const mAssigned = people.reduce((s,p) => s + getPersonAssignedHrs(p.id, m), 0);
        return mAssigned > mAvail;
    });
    
    const overloadedPeople = people.filter(p => getPersonYearlyAssigned(p.id) > getPersonYearlyAvail(p.id)).length;
    
    document.getElementById('peopleSummary').innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem">
            <div style="text-align:center"><div style="font-size:1.5rem;font-weight:700;color:var(--primary)">${people.length}</div><div style="font-size:0.78rem;color:var(--text-dim)">Ressources</div></div>
            <div style="text-align:center"><div style="font-size:1.5rem;font-weight:700;color:var(--success)">${grandAvail}h</div><div style="font-size:0.78rem;color:var(--text-dim)">Dispo. annuelle</div></div>
            <div style="text-align:center"><div style="font-size:1.5rem;font-weight:700;color:var(--accent)">${grandAssigned}h</div><div style="font-size:0.78rem;color:var(--text-dim)">AssignÃ© annuel</div></div>
            <div style="text-align:center"><div style="font-size:1.5rem;font-weight:700;color:${bottleneckMonths.length?'var(--error)':'var(--success)'}">${bottleneckMonths.length}</div><div style="font-size:0.78rem;color:var(--text-dim)">Mois en surcharge</div></div>
        </div>
        ${bottleneckMonths.length ? `<div style="margin-top:0.75rem;padding:0.5rem 0.75rem;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;font-size:0.78rem;color:var(--error)">
            âš ï¸ <b>Alerte capacitÃ©:</b> ${bottleneckMonths.map(m => MONTH_LABELS[m]).join(', ')}
        </div>` : ''}
        <div style="margin-top:0.5rem;padding:0.5rem 0.75rem;background:rgba(255,255,255,0.7);border-radius:8px;font-size:0.78rem;color:var(--text-dim);font-style:italic">
            ğŸ”„ Heures/mois disponibles pour les projets. Ajustez juillet/aoÃ»t/dÃ©cembre pour les vacances.
        </div>`;
}

function addPerson() {
    const id = 'r' + Date.now();
    STATE.people.push({ id, name:'Nouvelle ressource', funcId:'gestionnaires', availByMonth: defaultAvailByMonth(16) });
    saveState(); renderPeople(); renderAssign();
}
function removePerson(pid) {
    if (!confirm('Supprimer cette ressource?')) return;
    STATE.people = STATE.people.filter(p => p.id !== pid);
    Object.keys(STATE.assignments).forEach(projId => { delete STATE.assignments[projId][pid]; });
    saveState(); renderAll();
}
function updatePersonAvailMonth(pid, month, val) {
    const p = STATE.people.find(x=>x.id===pid);
    if (p) {
        if (!p.availByMonth) p.availByMonth = {};
        p.availByMonth[month] = parseFloat(val) || 0;
    }
    saveState(); renderPeople(); renderRecommend(); renderAnalysis();
}
function updatePersonFunc(pid, fid) {
    const p = STATE.people.find(x=>x.id===pid);
    if (p) p.funcId = fid;
    saveState(); renderPeople();
}
function updatePersonName(pid, val) {
    const p = STATE.people.find(x=>x.id===pid);
    if (p) p.name = val.trim() || 'Sans nom';
    saveState(); renderPeople(); renderAssign(); renderRecommend(); renderAnalysis();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ASSIGNMENT: Assign People to Projects
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAssign() {
    const projs = sorted();
    const people = STATE.people;
    if (!projs.length) {
        document.getElementById('assignTableWrap').innerHTML = '<div class="card" style="text-align:center;padding:2rem;color:var(--text-dim)">Aucun projet scorÃ©. ComplÃ©tez le scoring d\'abord.</div>';
        return;
    }

    // Month selector
    let html = `<div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.75rem;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:0.5rem">
            <span style="font-size:0.85rem;font-weight:600;color:var(--text-muted)">ğŸ“… Mois:</span>
            <select id="assignMonthSelect" style="padding:0.4rem 0.6rem;border-radius:8px;border:1px solid var(--border);background:var(--bg);font-size:0.85rem;font-weight:600" onchange="selectedMonth=this.value;renderAssign();renderRecommend();renderAnalysis()">
                ${MONTHS.map(m => `<option value="${m}" ${m===selectedMonth?'selected':''}>${MONTH_LABELS[m]}</option>`).join('')}
            </select>
        </div>
        <div style="display:flex;gap:0.3rem">
            ${MONTHS.map(m => {
                const mAvail = getTotalAvailableHrs(m);
                const mAssigned = people.reduce((s,p) => s + getPersonAssignedHrs(p.id, m), 0);
                const mOver = mAssigned > mAvail;
                const isSelected = m === selectedMonth;
                return `<button onclick="selectedMonth='${m}';renderAssign();renderRecommend();renderAnalysis()" style="padding:0.25rem 0.4rem;border-radius:5px;border:1px solid ${isSelected?'var(--primary)':mOver?'var(--error)':'var(--border)'};background:${isSelected?'var(--primary)':mOver?'#fef2f2':'var(--bg)'};color:${isSelected?'white':mOver?'var(--error)':'var(--text-dim)'};font-size:0.68rem;font-weight:${isSelected?'700':'500'};cursor:pointer" title="${MONTH_LABELS[m]}: ${mAssigned}h / ${mAvail}h">${MONTH_SHORT[m]}</button>`;
            }).join('')}
        </div>
    </div>`;

    // Table
    html += '<div class="card" style="padding:0.75rem"><div style="overflow-x:auto"><table class="scoring-table" style="min-width:700px"><thead><tr>';
    html += '<th style="text-align:left;min-width:180px;position:sticky;left:0;background:var(--primary);z-index:2;color:white">Projet</th>';
    people.forEach(p => {
        const f = FUNCTIONS.find(x=>x.id===p.funcId);
        const avail = getPersonAvailHrs(p.id, selectedMonth);
        const assigned = getPersonAssignedHrs(p.id, selectedMonth);
        const over = assigned > avail;
        html += `<th style="text-align:center;min-width:60px;${over?'background:#fef2f2;color:var(--text)':''}" title="${esc(p.name)} â€” ${f?.label||''} â€” ${MONTH_LABELS[selectedMonth]}: ${assigned}h / ${avail}h"><span style="font-size:0.82rem;font-weight:600;display:block;${over?'':'color:white'}">${esc(p.name)}</span><div style="font-size:0.62rem;font-weight:400;${over?'color:var(--error)':'color:rgba(255,255,255,0.75)'}">${avail}h</div></th>`;
    });
    html += `<th style="text-align:center;background:var(--primary-light);color:white;min-width:60px">Total</th></tr></thead><tbody>`;

    projs.forEach((proj, i) => {
        const assignments = STATE.assignments[proj.id] || {};
        let totalH = 0;
        
        html += `<tr>
            <td style="font-weight:500;position:sticky;left:0;background:var(--bg-card);z-index:1">
                <span style="display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:5px;background:rgba(66,153,225,0.12);color:var(--project-color);font-size:0.7rem;font-weight:700;margin-right:0.4rem">${i+1}</span>${esc(proj.name)}
            </td>`;
        
        people.forEach(p => {
            const personAssign = assignments[p.id];
            let v = 0;
            if (personAssign) {
                v = (typeof personAssign === 'object') ? (personAssign[selectedMonth] || 0) : personAssign;
            }
            totalH += v;
            
            const avail = getPersonAvailHrs(p.id, selectedMonth);
            const assigned = getPersonAssignedHrs(p.id, selectedMonth);
            const over = assigned > avail;
            
            html += `<td style="text-align:center;${over?'background:#fef2f2':''}"><input type="number" min="0" max="200" step="1" class="scoring-input" style="width:46px;font-size:0.8rem;${v > 0 && over ? 'border-color:var(--error)':''}" value="${v||''}" placeholder="â€”" onchange="updateAssignmentMonth('${proj.id}','${p.id}','${selectedMonth}',this.value)"></td>`;
        });
        html += `<td style="text-align:center;font-weight:700;font-size:1rem;color:var(--accent)">${totalH || 'â€”'}</td></tr>`;
    });

    // Person totals row
    html += '<tr style="border-top:2px solid var(--border);background:var(--bg-card-hover)"><td style="font-weight:700;position:sticky;left:0;background:var(--bg-card-hover);z-index:1">Total assignÃ©</td>';
    let grandTotal = 0;
    people.forEach(p => {
        const avail = getPersonAvailHrs(p.id, selectedMonth);
        const assigned = getPersonAssignedHrs(p.id, selectedMonth);
        const over = assigned > avail;
        grandTotal += assigned;
        html += `<td style="text-align:center;font-weight:700;color:${over?'var(--error)':'var(--success)'};${over?'background:#fef2f2':''}"><div>${assigned}h</div><div style="font-size:0.6rem;font-weight:400;color:var(--text-dim)">/${avail}h</div></td>`;
    });
    html += `<td style="text-align:center;font-weight:700;font-size:1.05rem;color:var(--accent)">${grandTotal}h</td></tr>`;
    html += '</tbody></table></div></div>';

    // Hint
    html += `<div style="margin-top:0.75rem;padding:0.6rem 1rem;background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;font-size:0.82rem;color:#0369a1">
        ğŸ’¡ Assignez les heures/mois pour <b>${MONTH_LABELS[selectedMonth]}</b>. Changez de mois avec le sÃ©lecteur ou les boutons ci-dessus. Les colonnes en rouge indiquent une surcharge.
    </div>`;
    
    // Copy to all months button
    html += `<div style="margin-top:0.5rem;text-align:right">
        <button class="btn" style="font-size:0.78rem;padding:0.4rem 0.8rem" onclick="copyMonthToAll()" title="Copier les valeurs de ${MONTH_LABELS[selectedMonth]} vers tous les autres mois">ğŸ“‹ Copier ce mois â†’ tous les mois</button>
    </div>`;

    document.getElementById('assignTableWrap').innerHTML = html;
}

function updateAssignmentMonth(projId, personId, month, val) {
    if (!STATE.assignments[projId]) STATE.assignments[projId] = {};
    if (!STATE.assignments[projId][personId]) STATE.assignments[projId][personId] = {};
    
    // Ensure it's an object (migrate from legacy)
    if (typeof STATE.assignments[projId][personId] !== 'object') {
        const oldVal = STATE.assignments[projId][personId];
        STATE.assignments[projId][personId] = {};
        MONTHS.forEach(m => STATE.assignments[projId][personId][m] = oldVal);
    }
    
    const v = parseFloat(val) || 0;
    if (v > 0) {
        STATE.assignments[projId][personId][month] = v;
    } else {
        delete STATE.assignments[projId][personId][month];
        // Clean up empty objects
        if (Object.keys(STATE.assignments[projId][personId]).length === 0) {
            delete STATE.assignments[projId][personId];
        }
    }
    
    // Sync legacy resources field (yearly total)
    const p = STATE.projects.find(x=>x.id===projId);
    if (p) {
        let yearTotal = 0;
        MONTHS.forEach(m => yearTotal += getProjectTotalHrs(projId, m));
        p.resources = yearTotal;
    }
    
    saveState();
    renderAssign();
    renderPeople();
    renderRecommend();
    renderAnalysis();
    renderGate0();
}

function copyMonthToAll() {
    if (!confirm(`Copier les valeurs de ${MONTH_LABELS[selectedMonth]} vers tous les autres mois?`)) return;
    
    const projs = sorted();
    projs.forEach(proj => {
        const assignments = STATE.assignments[proj.id] || {};
        STATE.people.forEach(p => {
            const personAssign = assignments[p.id];
            if (personAssign && typeof personAssign === 'object') {
                const val = personAssign[selectedMonth] || 0;
                MONTHS.forEach(m => {
                    if (val > 0) personAssign[m] = val;
                    else delete personAssign[m];
                });
            }
        });
    });
    
    saveState();
    renderAll();
    notify('Valeurs copiÃ©es vers tous les mois');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECOMMENDATION: GO / GOULOT Summary
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getCapacityResults(month) {
    const m = month || selectedMonth;
    const projs = sorted();
    const people = STATE.people;
    
    // Calculate total assigned per person for this month (across ALL projects)
    const totalAssignedPerPerson = {};
    people.forEach(p => {
        totalAssignedPerPerson[p.id] = getPersonAssignedHrs(p.id, m);
    });

    const results = projs.map((proj, i) => {
        const a = STATE.assignments[proj.id] || {};
        const totalH = getProjectTotalHrs(proj.id, m);
        let bottlenecks = [];
        
        // Check if any person assigned to this project is overloaded this month
        people.forEach(p => {
            const personAssign = a[p.id];
            let hrs = 0;
            if (personAssign) {
                hrs = (typeof personAssign === 'object') ? (personAssign[m] || 0) : personAssign;
            }
            if (hrs > 0) {
                const avail = getPersonAvailHrs(p.id, m);
                const totalAssigned = totalAssignedPerPerson[p.id];
                if (totalAssigned > avail) {
                    bottlenecks.push({ person: p, month: m, assigned: hrs, over: +(totalAssigned - avail).toFixed(0) });
                }
            }
        });

        const canFit = bottlenecks.length === 0;

        return { ...proj, totalH, canFit, bottlenecks, status: canFit ? 'GO' : 'GOULOT' };
    });

    return results;
}

function getYearlyCapacityResults() {
    const projs = sorted();
    const people = STATE.people;
    
    // Check each project across all months
    return projs.map(proj => {
        let monthlyStatus = {};
        let allBottlenecks = [];
        let worstMonth = null;
        let worstOver = 0;
        
        MONTHS.forEach(m => {
            const results = getCapacityResults(m);
            const projResult = results.find(r => r.id === proj.id);
            if (projResult) {
                monthlyStatus[m] = projResult.canFit ? 'GO' : 'GOULOT';
                if (!projResult.canFit) {
                    projResult.bottlenecks.forEach(b => {
                        allBottlenecks.push({ ...b, month: m });
                        if (b.over > worstOver) {
                            worstOver = b.over;
                            worstMonth = m;
                        }
                    });
                }
            }
        });
        
        const blockedMonths = MONTHS.filter(m => monthlyStatus[m] === 'GOULOT');
        const canFit = blockedMonths.length === 0;
        
        let yearTotalH = 0;
        MONTHS.forEach(m => yearTotalH += getProjectTotalHrs(proj.id, m));
        
        return {
            ...proj,
            totalH: yearTotalH,
            canFit,
            blockedMonths,
            worstMonth,
            bottlenecks: allBottlenecks,
            status: canFit ? 'GO' : 'GOULOT'
        };
    });
}

function renderRecommend() {
    const yearlyResults = getYearlyCapacityResults();
    const monthlyResults = getCapacityResults(selectedMonth);
    const people = STATE.people;
    
    // Monthly stats
    const mAvail = getTotalAvailableHrs(selectedMonth);
    const mAssigned = people.reduce((s,p) => s + getPersonAssignedHrs(p.id, selectedMonth), 0);
    const mGap = mAvail - mAssigned;
    const mOverloaded = people.filter(p => getPersonAssignedHrs(p.id, selectedMonth) > getPersonAvailHrs(p.id, selectedMonth)).length;
    
    // Yearly stats
    const goP = yearlyResults.filter(r => r.canFit);
    const blockP = yearlyResults.filter(r => !r.canFit);
    const blockedMonthsCount = new Set(blockP.flatMap(p => p.blockedMonths)).size;

    // Month selector bar
    let monthBar = `<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap">
        <span style="font-size:0.85rem;font-weight:600;color:var(--text-muted)">ğŸ“… Vue:</span>
        <select style="padding:0.4rem 0.6rem;border-radius:8px;border:1px solid var(--border);background:var(--bg);font-size:0.85rem;font-weight:600" onchange="selectedMonth=this.value;renderAssign();renderRecommend();renderAnalysis()">
            ${MONTHS.map(m => `<option value="${m}" ${m===selectedMonth?'selected':''}>${MONTH_LABELS[m]}</option>`).join('')}
        </select>
        <div style="display:flex;gap:0.25rem;margin-left:0.5rem">
            ${MONTHS.map(m => {
                const results = getCapacityResults(m);
                const hasBlock = results.some(r => !r.canFit);
                const isSelected = m === selectedMonth;
                return `<button onclick="selectedMonth='${m}';renderAssign();renderRecommend();renderAnalysis()" style="padding:0.2rem 0.35rem;border-radius:4px;border:1px solid ${isSelected?'var(--primary)':hasBlock?'var(--error)':'var(--border)'};background:${isSelected?'var(--primary)':hasBlock?'#fef2f2':'var(--bg)'};color:${isSelected?'white':hasBlock?'var(--error)':'var(--text-dim)'};font-size:0.65rem;font-weight:${isSelected?'700':'500'};cursor:pointer" title="${MONTH_LABELS[m]}">${MONTH_SHORT[m]}</button>`;
            }).join('')}
        </div>
    </div>`;

    // KPIs for selected month
    document.getElementById('recommendKPIs').innerHTML = monthBar + `
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem">
            <div class="card" style="text-align:center;padding:0.85rem;border-color:rgba(56,161,105,0.3)">
                <div style="font-size:1.5rem;font-weight:700;color:var(--success)">${goP.length}</div>
                <div style="font-size:0.75rem;color:var(--text-dim)">Projets faisables (annÃ©e)</div>
            </div>
            <div class="card" style="text-align:center;padding:0.85rem;border-color:${blockP.length?'rgba(229,62,62,0.3)':'rgba(56,161,105,0.3)'}">
                <div style="font-size:1.5rem;font-weight:700;color:${blockP.length?'var(--error)':'var(--success)'}">${blockP.length}</div>
                <div style="font-size:0.75rem;color:var(--text-dim)">Projets avec goulots</div>
            </div>
            <div class="card" style="text-align:center;padding:0.85rem;border-color:rgba(198,160,82,0.3)">
                <div style="font-size:1.5rem;font-weight:700;color:${mGap>=0?'var(--success)':'var(--error)'}">${mGap>=0?'+':''}${mGap}h</div>
                <div style="font-size:0.75rem;color:var(--text-dim)">${MONTH_LABELS[selectedMonth]}</div>
            </div>
            <div class="card" style="text-align:center;padding:0.85rem;border-color:${blockedMonthsCount?'rgba(229,62,62,0.3)':'rgba(56,161,105,0.3)'}">
                <div style="font-size:1.5rem;font-weight:700;color:${blockedMonthsCount?'var(--error)':'var(--success)'}">${blockedMonthsCount}</div>
                <div style="font-size:0.75rem;color:var(--text-dim)">Mois en surcharge</div>
            </div>
        </div>`;

    // Project list with monthly bottleneck info
    let content = '';
    yearlyResults.forEach((r, i) => {
        const statusBadge = r.canFit 
            ? '<span class="badge badge-go">FAISABLE</span>' 
            : '<span class="badge badge-attente">GOULOT</span>';
        
        content += `<div style="display:flex;align-items:flex-start;gap:0.6rem;padding:0.75rem 0.85rem;margin-bottom:0.45rem;background:${r.canFit?'rgba(56,161,105,0.04)':'rgba(229,62,62,0.04)'};border-radius:10px;border:1px solid ${r.canFit?'rgba(56,161,105,0.15)':'rgba(229,62,62,0.15)'}">
            <span style="width:24px;height:24px;border-radius:7px;background:${r.canFit?'var(--success-bg)':'var(--error-bg)'};color:${r.canFit?'var(--success)':'var(--error)'};display:flex;align-items:center;justify-content:center;font-size:0.72rem;font-weight:700;flex-shrink:0;margin-top:0.1rem">${i+1}</span>
            <div style="flex:1;min-width:0">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:0.5rem;flex-wrap:wrap">
                    <div style="font-size:0.92rem;font-weight:600;color:${r.canFit?'var(--text)':'var(--error)'}">${esc(r.name)}</div>
                    <div style="display:flex;align-items:center;gap:0.5rem;flex-shrink:0">
                        <span style="font-size:0.82rem;font-weight:600;color:var(--text-dim)">${r.totalH}h/an</span>
                        <span style="font-size:0.78rem;color:var(--text-dim)">${pct(r.scores)}%</span>
                        ${statusBadge}
                    </div>
                </div>`;
        
        // Show blocked months
        if (r.blockedMonths && r.blockedMonths.length) {
            content += `<div style="margin-top:0.35rem;display:flex;flex-wrap:wrap;gap:0.25rem;align-items:center">
                <span style="font-size:0.7rem;color:var(--error);font-weight:500">âš ï¸ Mois bloquÃ©s:</span>`;
            r.blockedMonths.forEach(m => {
                content += `<span style="padding:0.15rem 0.4rem;background:#fef2f2;border:1px solid #fecaca;border-radius:4px;font-size:0.68rem;color:var(--error);font-weight:600">${MONTH_LABELS[m]}</span>`;
            });
            content += '</div>';
            
            // Show unique bottleneck people
            const uniqueBottlenecks = [];
            r.bottlenecks.forEach(b => {
                if (!uniqueBottlenecks.find(x => x.person.id === b.person.id)) {
                    uniqueBottlenecks.push(b);
                }
            });
            if (uniqueBottlenecks.length) {
                content += '<div style="margin-top:0.25rem;display:flex;flex-wrap:wrap;gap:0.25rem">';
                uniqueBottlenecks.slice(0, 5).forEach(b => {
                    content += `<span style="display:inline-flex;align-items:center;gap:0.2rem;padding:0.15rem 0.45rem;background:var(--error-bg);border-radius:5px;font-size:0.68rem;color:var(--error);font-weight:500">${funcIcon(b.person.funcId)} ${esc(b.person.name)}</span>`;
                });
                if (uniqueBottlenecks.length > 5) {
                    content += `<span style="font-size:0.68rem;color:var(--text-dim)">+${uniqueBottlenecks.length - 5} autres</span>`;
                }
                content += '</div>';
            }
        }

        // Show assigned people for GO projects
        if (r.canFit) {
            const a = STATE.assignments[r.id] || {};
            const assignedPeople = people.filter(p => {
                const pa = a[p.id];
                if (!pa) return false;
                if (typeof pa === 'object') return Object.values(pa).some(v => v > 0);
                return pa > 0;
            });
            if (assignedPeople.length) {
                content += '<div style="margin-top:0.3rem;display:flex;flex-wrap:wrap;gap:0.25rem">';
                assignedPeople.forEach(p => {
                    const pa = a[p.id];
                    const hrs = typeof pa === 'object' ? (pa[selectedMonth] || 0) : pa;
                    content += `<span style="display:inline-flex;align-items:center;gap:0.2rem;padding:0.15rem 0.45rem;background:var(--success-bg);border-radius:5px;font-size:0.68rem;color:var(--success)">${funcIcon(p.funcId)} ${esc(p.name)} ${hrs}h</span>`;
                });
                content += '</div>';
            }
        }

        content += '</div></div>';
    });
    document.getElementById('recommendContent').innerHTML = content;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYSIS: Detailed Per-Person Capacity
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAnalysis() {
    const projs = sorted();
    const people = STATE.people;
    
    // Calculate monthly data for chart
    const monthlyData = MONTHS.map(m => {
        const avail = getTotalAvailableHrs(m);
        const assigned = people.reduce((s,p) => s + getPersonAssignedHrs(p.id, m), 0);
        return { month: m, avail, assigned, gap: avail - assigned, pct: avail > 0 ? Math.round(assigned / avail * 100) : 0 };
    });
    const maxHrs = Math.max(...monthlyData.map(d => Math.max(d.avail, d.assigned)));
    
    // Monthly Capacity vs Demand Chart
    let html = `<div class="card" style="margin-bottom:1rem;padding:1rem">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem">
            <div style="font-size:0.95rem;font-weight:700;color:var(--text)">ğŸ“Š CapacitÃ© vs Demande â€” Vue annuelle</div>
            <div style="display:flex;gap:1rem;font-size:0.75rem">
                <span style="display:flex;align-items:center;gap:0.3rem"><span style="width:12px;height:12px;background:var(--primary);border-radius:2px"></span> CapacitÃ©</span>
                <span style="display:flex;align-items:center;gap:0.3rem"><span style="width:12px;height:12px;background:var(--accent);border-radius:2px"></span> Demande</span>
            </div>
        </div>
        <div style="display:flex;gap:0.5rem;align-items:flex-end;height:160px;padding:0.5rem 0;border-bottom:2px solid var(--border)">`;
    
    monthlyData.forEach(d => {
        const availH = maxHrs > 0 ? Math.round(d.avail / maxHrs * 130) : 0;
        const assignH = maxHrs > 0 ? Math.round(d.assigned / maxHrs * 130) : 0;
        const isOver = d.assigned > d.avail;
        const isSelected = d.month === selectedMonth;
        
        html += `<div style="flex:1;display:flex;flex-direction:column;align-items:center;cursor:pointer;padding:0.25rem;border-radius:6px;${isSelected?'background:rgba(66,153,225,0.1)':''}" onclick="selectedMonth='${d.month}';renderAssign();renderRecommend();renderAnalysis()" title="${MONTH_LABELS[d.month]}: ${d.assigned}h / ${d.avail}h (${d.pct}%)">
            <div style="display:flex;gap:2px;align-items:flex-end;height:130px">
                <div style="width:14px;height:${availH}px;background:var(--primary);border-radius:2px 2px 0 0;opacity:0.6" title="CapacitÃ©: ${d.avail}h"></div>
                <div style="width:14px;height:${assignH}px;background:${isOver?'var(--error)':'var(--accent)'};border-radius:2px 2px 0 0" title="Demande: ${d.assigned}h"></div>
            </div>
            <div style="font-size:0.65rem;font-weight:${isSelected?'700':'500'};color:${isSelected?'var(--primary)':isOver?'var(--error)':'var(--text-dim)'};margin-top:0.3rem">${MONTH_SHORT[d.month]}</div>
            <div style="font-size:0.6rem;font-weight:600;color:${isOver?'var(--error)':d.pct>=80?'var(--accent)':'var(--success)'}">${d.pct}%</div>
        </div>`;
    });
    
    html += `</div>
        <div style="display:flex;justify-content:space-between;margin-top:0.5rem;font-size:0.75rem;color:var(--text-dim)">
            <span>Cliquez sur un mois pour voir les dÃ©tails</span>
            <span style="font-weight:600;color:${monthlyData.filter(d=>d.assigned>d.avail).length?'var(--error)':'var(--success)'}">${monthlyData.filter(d=>d.assigned>d.avail).length} mois en surcharge</span>
        </div>
    </div>`;
    
    // Selected month summary
    const selData = monthlyData.find(d => d.month === selectedMonth);
    html += `<div class="card" style="margin-bottom:1rem;padding:1rem;background:${selData.gap<0?'rgba(229,62,62,0.03)':'rgba(56,161,105,0.03)'};border-color:${selData.gap<0?'rgba(229,62,62,0.2)':'rgba(56,161,105,0.2)'}">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem">
            <div style="font-size:1rem;font-weight:700;color:var(--text)">ğŸ“… ${MONTH_LABELS[selectedMonth]}</div>
            <div style="display:flex;gap:1.5rem;font-size:0.9rem">
                <div><span style="color:var(--text-dim)">CapacitÃ©:</span> <span style="font-weight:700;color:var(--primary)">${selData.avail}h</span></div>
                <div><span style="color:var(--text-dim)">Demande:</span> <span style="font-weight:700;color:var(--accent)">${selData.assigned}h</span></div>
                <div><span style="color:var(--text-dim)">Ã‰cart:</span> <span style="font-weight:700;color:${selData.gap>=0?'var(--success)':'var(--error)'}">${selData.gap>=0?'+':''}${selData.gap}h</span></div>
                <div><span style="color:var(--text-dim)">Utilisation:</span> <span style="font-weight:700;color:${selData.pct>100?'var(--error)':selData.pct>=80?'var(--accent)':'var(--success)'}">${selData.pct}%</span></div>
            </div>
        </div>
    </div>`;
    
    // Group people by function
    const grouped = {};
    people.forEach(p => {
        if (!grouped[p.funcId]) grouped[p.funcId] = [];
        grouped[p.funcId].push(p);
    });

    // Per-function sections
    FUNCTIONS.forEach(f => {
        const fPeople = grouped[f.id];
        if (!fPeople || !fPeople.length) return;

        const funcAvail = fPeople.reduce((s,p) => s + getPersonAvailHrs(p.id, selectedMonth), 0);
        const funcAssigned = fPeople.reduce((s,p) => s + getPersonAssignedHrs(p.id, selectedMonth), 0);
        const funcPct = funcAvail > 0 ? Math.round(funcAssigned / funcAvail * 100) : 0;
        const funcOver = funcAssigned > funcAvail;

        html += `<div class="card" style="margin-bottom:0.85rem">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.6rem">
                <div style="display:flex;align-items:center;gap:0.4rem">
                    <span style="font-size:1.15rem">${f.icon}</span>
                    <span style="font-size:0.95rem;font-weight:700">${f.label}</span>
                    <span style="font-size:0.78rem;color:var(--text-dim)">(${fPeople.length} pers.)</span>
                </div>
                <div style="display:flex;align-items:center;gap:0.5rem">
                    <span style="font-size:0.82rem;color:var(--text-dim)">${funcAssigned}h / ${funcAvail}h</span>
                    <span style="font-size:0.88rem;font-weight:700;color:${funcOver?'var(--error)':funcPct>=80?'var(--accent)':'var(--success)'}">${funcPct}%</span>
                </div>
            </div>`;

        fPeople.forEach(p => {
            const avail = getPersonAvailHrs(p.id, selectedMonth);
            const assigned = getPersonAssignedHrs(p.id, selectedMonth);
            const gap = avail - assigned;
            const pctUsed = avail > 0 ? Math.round(assigned / avail * 100) : (assigned > 0 ? 999 : 0);
            const over = assigned > avail;

            html += `<div style="margin-bottom:0.65rem;padding:0.6rem 0.75rem;background:${over?'rgba(229,62,62,0.03)':'var(--bg-card-hover)'};border-radius:8px;border:1px solid ${over?'rgba(229,62,62,0.15)':'transparent'}">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.3rem">
                    <div style="font-size:0.88rem;font-weight:600">${esc(p.name)}</div>
                    <div style="display:flex;align-items:center;gap:0.5rem">
                        <span style="font-size:0.78rem;color:var(--text-dim)">${assigned}h / ${avail}h</span>
                        <span style="font-size:0.82rem;font-weight:700;color:${over?'var(--error)':pctUsed>=80?'var(--accent)':'var(--success)'}">${pctUsed}%</span>
                        <span style="font-size:0.82rem;font-weight:700;color:${gap>=0?'var(--success)':'var(--error)'}">${gap>=0?'+':''}${gap}h</span>
                    </div>
                </div>
                <div class="cap-bar-bg" style="height:8px;margin-bottom:0.35rem"><div class="cap-bar-fill ${over?'attente':'go'}" style="width:${Math.min(100,pctUsed)}%;height:100%;border-radius:4px"></div></div>`;

            // Show which projects this person is assigned to for selected month
            const projList = projs.filter(proj => {
                const pa = STATE.assignments[proj.id]?.[p.id];
                if (!pa) return false;
                if (typeof pa === 'object') return (pa[selectedMonth] || 0) > 0;
                return pa > 0;
            });
            
            if (projList.length) {
                html += '<div style="display:flex;flex-wrap:wrap;gap:0.25rem">';
                projList.forEach(proj => {
                    const pa = STATE.assignments[proj.id][p.id];
                    const hrs = typeof pa === 'object' ? (pa[selectedMonth] || 0) : pa;
                    html += `<span style="display:inline-flex;align-items:center;gap:0.2rem;padding:0.15rem 0.45rem;background:rgba(66,153,225,0.08);border-radius:5px;font-size:0.7rem;color:var(--project-color);font-weight:500">${esc(proj.name)} <span style="font-weight:700">${hrs}h</span></span>`;
                });
                html += '</div>';
            } else {
                html += '<div style="font-size:0.72rem;color:var(--text-dim);font-style:italic">Aucun projet assignÃ© ce mois</div>';
            }

            html += '</div>';
        });

        html += '</div>';
    });

    if (!Object.keys(grouped).length) {
        html += '<div class="card" style="text-align:center;padding:2rem;color:var(--text-dim)">Aucune ressource dÃ©finie. Ajoutez des ressources dans l\'onglet Ressources.</div>';
    }

    document.getElementById('analysisContent').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GATE 0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGate0() {
    const results = getYearlyCapacityResults();
    const np = nonProj();
    const yearlyAvail = STATE.people.reduce((s,p) => s + getPersonYearlyAvail(p.id), 0);
    const avgMonthlyAvail = Math.round(yearlyAvail / MONTHS.length);
    const goP = results.filter(r => r.canFit);
    const blockP = results.filter(r => !r.canFit);

    let html = `<div style="background:linear-gradient(135deg,var(--primary),var(--primary-light));border-radius:12px;padding:1.5rem;margin-bottom:1.25rem;color:#ffffff">
        <h3 style="font-family:'Fraunces',serif;font-size:1.1rem;font-weight:700;margin-bottom:1rem;color:#ffffff">Sommaire exÃ©cutif</h3>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.85rem">
            <div style="background:rgba(255,255,255,.1);border-radius:8px;padding:1rem;text-align:center"><div style="font-size:1.75rem;font-weight:700">${results.length}</div><div style="font-size:0.75rem;opacity:.8">Projets Ã©valuÃ©s</div></div>
            <div style="background:rgba(255,255,255,.1);border-radius:8px;padding:1rem;text-align:center"><div style="font-size:1.75rem;font-weight:700;color:#68d391">${goP.length}</div><div style="font-size:0.75rem;opacity:.8">Projets FAISABLES</div></div>
            <div style="background:rgba(255,255,255,.1);border-radius:8px;padding:1rem;text-align:center"><div style="font-size:1.75rem;font-weight:700;color:#fc8181">${blockP.length}</div><div style="font-size:0.75rem;opacity:.8">Projets GOULOT</div></div>
            <div style="background:rgba(255,255,255,.1);border-radius:8px;padding:1rem;text-align:center"><div style="font-size:1.75rem;font-weight:700">${avgMonthlyAvail}h</div><div style="font-size:0.75rem;opacity:.8">CapacitÃ© moy./mois</div></div>
        </div></div>`;

    // GO table
    html += '<h3 style="font-size:0.95rem;font-weight:600;color:var(--success);margin-bottom:0.6rem">âœ“ Projets recommandÃ©s (FAISABLES)</h3><div style="overflow-x:auto;margin-bottom:1.25rem"><table class="gate-table"><thead class="gate-table-go"><tr><th>#</th><th>Projet</th><th>Chef</th>';
    STATE.criteria.forEach(c => html += '<th>'+c.short+'</th>');
    html += '<th>PondÃ©rÃ©</th><th>%</th><th>h/an</th><th>Statut</th></tr></thead><tbody>';
    goP.forEach((p,i) => {
        html += `<tr style="background:${i%2===0?'var(--bg-card)':'var(--bg-card-hover)'}"><td>${i+1}</td><td>${esc(p.name)}</td><td style="color:var(--text-dim)">${esc(p.chef)}</td>`;
        STATE.criteria.forEach(c => html += '<td>'+(p.scores?.[c.id]||'â€”')+'</td>');
        html += `<td style="font-weight:700">${weightedScore(p.scores).toFixed(1)}</td><td>${pct(p.scores)}%</td><td>${p.totalH}h</td><td><span class="badge badge-go">GO</span></td></tr>`;
    });
    html += '</tbody></table></div>';

    // GOULOT table
    if (blockP.length) {
        html += '<h3 style="font-size:0.95rem;font-weight:600;color:var(--error);margin-bottom:0.6rem">â¸ Projets bloquÃ©s (GOULOTS)</h3><div style="overflow-x:auto;margin-bottom:1.25rem"><table class="gate-table"><thead class="gate-table-attente"><tr><th>#</th><th>Projet</th><th>Chef</th><th>Score %</th><th>h/an</th><th>Mois bloquÃ©s</th></tr></thead><tbody>';
        blockP.forEach((p,i) => {
            const monthsStr = p.blockedMonths.map(m => MONTH_LABELS[m]).slice(0,4).join(', ') + (p.blockedMonths.length > 4 ? '...' : '');
            html += `<tr style="background:${i%2===0?'var(--bg-card)':'var(--bg-card-hover)'}"><td>${goP.length+i+1}</td><td>${esc(p.name)}</td><td style="color:var(--text-dim)">${esc(p.chef)}</td><td>${pct(p.scores)}%</td><td>${p.totalH}h</td><td style="color:var(--error);font-size:0.75rem">${monthsStr}</td></tr>`;
        });
        html += '</tbody></table></div>';
    }

    // Non-project
    if (np.length) {
        html += '<h3 style="font-size:0.95rem;font-weight:600;color:var(--text-dim);margin-bottom:0.6rem">Initiatives routÃ©es (non-projet)</h3><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.6rem;margin-bottom:1.25rem">';
        np.forEach(p => { const b=BRANCHES[p.branch]; html += `<div class="branch-card" style="background:${b?.bg};text-align:left;padding:0.85rem"><span style="font-size:1.15rem">${b?.icon}</span><div style="font-size:0.85rem;font-weight:500;margin-top:0.2rem">${esc(p.name)}</div><div style="font-size:0.72rem;color:${b?.color};font-weight:600;margin-top:0.2rem">${b?.label}</div></div>`; });
        html += '</div>';
    }

    html += `<div style="margin-top:1.5rem;background:var(--bg-card-hover);border-radius:12px;padding:1rem;border:1px dashed var(--border);text-align:center">
        <p style="margin:0;font-size:0.85rem;color:var(--text-dim)">ğŸ“Œ AprÃ¨s approbation Gate 0 â†’ <b style="color:var(--text-muted)">Microsoft Teams Planner</b> (Chantal) â†’ Gate 1 â†’ ExÃ©cution â†’ Gate 2 â†’ BÃ©nÃ©fices â†’ Gate 3</p>
        <p style="margin:0.5rem 0 0;font-size:0.82rem;color:var(--text-dim)">ğŸ’¡ Besoin d'aide? Cliquez sur <b style="color:#8b5cf6">MARCUS</b> en bas Ã  droite pour une analyse IA</p>
    </div>`;
    document.getElementById('gate0Content').innerHTML = html;
}

function copyGate0Report() {
    const results = getYearlyCapacityResults();
    const np=nonProj();
    const yearlyAvail = STATE.people.reduce((s,p) => s + getPersonYearlyAvail(p.id), 0);
    const avgMonthlyAvail = Math.round(yearlyAvail / MONTHS.length);
    const goP=results.filter(r=>r.canFit); const blockP=results.filter(r=>!r.canFit);
    const lines = ['â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','RAPPORT DE RECOMMANDATION â€” GATE 0','CAMIONS BL â€” PMO & Innovation','Date: '+new Date().toLocaleDateString('fr-CA'),'Horizon: '+MONTHS.length+' mois ('+MONTH_LABELS[MONTHS[0]]+' Ã  '+MONTH_LABELS[MONTHS[MONTHS.length-1]]+')','â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','',
        'CAPACITÃ‰: '+avgMonthlyAvail+'h/mois moy. | PROJETS: '+results.length+' | GO: '+goP.length+' | GOULOT: '+blockP.length,'',
        'â”€â”€â”€ PROJETS GO â”€â”€â”€',...goP.map((p,i)=>(i+1)+'. '+p.name+' | '+pct(p.scores)+'% | '+p.totalH+'h/an | Chef:'+p.chef),'',
        'â”€â”€â”€ PROJETS GOULOT â”€â”€â”€',...blockP.map((p,i)=>(i+1)+'. '+p.name+' | '+pct(p.scores)+'% | '+p.totalH+'h/an | Mois bloquÃ©s: '+p.blockedMonths.map(m=>MONTH_LABELS[m]).join(', ')),'',
        'â”€â”€â”€ NON-PROJET â”€â”€â”€',...np.map(p=>'â€¢ '+p.name+' â†’ '+(BRANCHES[p.branch]?.label||p.branch)),'',
        'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','PrÃ©parÃ© par: Sylvain PMO Consulting','â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'];
    navigator.clipboard?.writeText(lines.join('\n')).then(()=>notify('Rapport copiÃ©!'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARCUS â€” AI ADVISOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MARCUS_AVATAR = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAAAAAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCABQAFADASIAAhEBAxEB/8QAHAAAAgMBAQEBAAAAAAAAAAAAAAgFBgcEAwEC/8QAOBAAAQMDAgMECQIFBQAAAAAAAQIDBAAFEQYhEhMxB0FRYQgUIjJCYnGBkaHwFZKxwdEXI0NSU//EABoBAAMAAwEAAAAAAAAAAAAAAAAEBQECBgP/xAAnEQACAgICAgECBwAAAAAAAAAAAQIDBBESIRNBMQVRFCIyQlKB8P/aAAwDAQACEQMRAD8ATKiiigArstVruN0f5NuhPyljqG0E4+p6D71NdmelJesNWRrNEYdfK/aWlGxwPE9EjxJ6DJppLX2QXpi0sJjm3W8NLHLgIWQjG+VuuAEqOcHhH3UaXuyFX17GaMWVvfoWD/T3VSUAuQGmyfhXJbCvxmom8acvdoRx3C2yGG//AEKeJH8wyKcF/sZcUz6zK1E4u4pUFNcDHDHa8fYzxLPgSftUNc+y1cKI56lqCSuSsf7pkNJKHMZ9kJHug5wc5rwjmrfY0/pza/KxQqK0PtH0g1FXLmW+I5EfiYM2IUEJAP8AyN/L0yOgztt0zynk9raJ0ouL0wooorJqFFFFADY+g9p5tjT161K42C/KfTEaUR0QkZVj6kj8UyqB7OwFLd6MeoZVv7EuVa4Hrs8XVxhpsqwgFSeMqWfhSE/npWp6M1BqGTPkQ747b1OHHJRG6pO+Qf0qPky1a9lzErlKlaRcZ2cHIGKp2pCEpURVf7TLtKl3Rq0R73Lti2SS7yBkuEjYbb5GM1WrNLlqUlUTVab7BOQ8l7BW313SoeexB/rS3z2OwhKD0yP1pbm5l7ZfWElJjlp5B+NBJBH4JpWb7AXa71NtrmeKK+tkk9/CojP6U2mpWlFUOc2fcc5Tg7ilXQ/Yj9aXrtnsUyJqeVfOBBgXB7iaUlQKkqKQeFY6pJwT51Yxpx4ab7I2dVJzckuih0UUUyTwooooAcD0TLfEndjT7SFlouT3kSFMq4VlWB39x4SkA1p1h0VY7Tq6bqSKw81LlJwlnnZaYQO5tONhnxJO9ZP6Jb6IfZLIcbVlaro+tYx0IQ2B+grVG5d1ft65UZ9tElW/Lc7k9w8j3/eomRNq2SR02LUpUwkzjgRYj2pLo5IZbU6+lxnKx7yFjCkg+Y227q/MXT1issJuJFt8VmOxxclltGyeI5VuSTvgZ3qk8y+ovypF3lNx2218zlhwZJ+x6VZ4a50+3KmJKzGKcoU4kpJHj9PCldyUdeig64c+T/39nFdYsaY06ylHC2cbJ2xg5GKxLtoQzG0K+Hwkvu3FDbR4cZ4eMk/Ybfetgtslf8S5TxwF/wCaXHt3vN5mapVaLnBVCZgOOchBVnmpUo4cz0IIAAx4HvzVLHr8ig16JubeqYWR/l0Z1RRRVM5sKKK9Ysd+S+liMy486s4ShCSpR+woAYP0QtRMoYu+mX1gL5iZrCSfeGAhwD6YQfzTIuRoktDa/U47rje6ONAOM9aUzsA0TKR2oabRPkOR5cqYEIYZWOJLYSpThWR8oI4fPfpimFterERvWGFhfMjvKacQR7SVJ6/UYIOfOpebVwny+5d+m2uyvgv2k5NtjnFkxobKM5w00kH+lRN6urcSKuPx7kbjNR961zxtKDI7uqjgCq7p60XzWEtx6IhQiFWHZroKWE+ST1WfJOfMik4wc3pdlCUvHHc3pHJCmS5t7CYaQp1RwjPQeZ8hVA7abrYrnqOLp5CBIjWyKYr8lPvl0qKiQfFJJ+5IrR+1e423s701/C7M4XL3PQU89eONKOhcx8I7kjx8cGlxbbVxlRJKickk5JPjVnFr8S7Oezcr8RLUfhEBe7W9a5y47h5jectOhJCXE9xH72rgrQIFwWY6mnkIfjqJy26kKSQNuh+leE2w2KekrjKctzx3wPbbP2O4/NN8U/0iKf3Kvp62KutxRH4+U0N3XMZ4U/5rSLemFaoao9tZ5KCMKXnLrh8Sr+3Sqxo2OGYHN6Leyon5QeEf3qZcWCOox9azDpbB9mhdhU1cbtCl6jKecux2aVLZQfieUAy0P5nK1t/Tc5Vuh6jv8dDcm6IQm4htHAnngEJdSn4ApPUeIHjVT9DyyQ5971DcpyG3Go7cdpCVnYr4isEjvxgGmYvMK33SEYcwtuMlaFlPMA3QoKH6gUlk1+aLTHMLJeNapr49mVWLQdli3Nl65Ql3UE5LT27beeh4R7xHzbeVWbX9/t2lNMSbtPKUR4yAhplGE8azshtA8z+Bk91XVCYqMuFxkd+SsACk19IDXidaaxcbtzyjY4Ci3EGfZeV0W9j5ug+UDxNFVUa1qKNcjJsvlym9lA1TeJ+pL5KvFyc45EheSB7qE/ChPygbCq85GUZCkLkO4VulIVgY+1SMx5uM3xH2lk4QkdVHwrmjMlKjIkKSp5Q3x0SP+o/e9ey6Fz6hngQEIGABgCvF5RCuBJ3I/Fe78hKEE5Fej7lrTplrgYkC7OPKU66XAW+VgcICcZB6/vplAf/Z';
let currentTab = 'projets';

function getPortfolioSummary() {
    const results = getYearlyCapacityResults();
    const people = STATE.people;
    const goP = results.filter(r => r.canFit);
    const blockP = results.filter(r => !r.canFit);
    
    // Monthly capacity data
    const monthlyData = MONTHS.map(m => {
        const avail = getTotalAvailableHrs(m);
        const assigned = people.reduce((s,p) => s + getPersonAssignedHrs(p.id, m), 0);
        return { month: MONTH_LABELS[m], avail, assigned, gap: avail - assigned, pct: avail > 0 ? Math.round(assigned / avail * 100) : 0 };
    });
    
    // Criteria info
    const criteriaInfo = STATE.criteria.map(c => ({
        name: c.label,
        short: c.short,
        weight: STATE.weights[c.id] || 0
    }));
    
    // Project details
    const projectDetails = results.map(p => ({
        name: p.name,
        chef: p.chef || 'Non assignÃ©',
        scores: STATE.criteria.map(c => ({ criteria: c.short, score: p.scores?.[c.id] || 0 })),
        weightedScore: weightedScore(p.scores).toFixed(1),
        percentScore: pct(p.scores),
        hoursPerYear: p.totalH,
        status: p.canFit ? 'FAISABLE' : 'GOULOT',
        blockedMonths: p.blockedMonths ? p.blockedMonths.map(m => MONTH_LABELS[m]) : [],
        bottleneckPeople: p.bottlenecks ? [...new Set(p.bottlenecks.map(b => b.person.name))].slice(0,3) : []
    }));
    
    // People by function with overload info
    const peopleByFunction = {};
    people.forEach(p => {
        const f = FUNCTIONS.find(x=>x.id===p.funcId);
        const fName = f?.label || p.funcId;
        if (!peopleByFunction[fName]) peopleByFunction[fName] = [];
        
        const overloadMonths = MONTHS.filter(m => {
            const avail = getPersonAvailHrs(p.id, m);
            const assigned = getPersonAssignedHrs(p.id, m);
            return assigned > avail;
        }).map(m => MONTH_LABELS[m]);
        
        peopleByFunction[fName].push({
            name: p.name,
            avgAvailPerMonth: Math.round(getPersonYearlyAvail(p.id) / MONTHS.length),
            avgAssignedPerMonth: Math.round(getPersonYearlyAssigned(p.id) / MONTHS.length),
            overloadMonths
        });
    });
    
    return {
        company: 'Camions BL',
        horizon: `${MONTHS.length} mois (${MONTH_LABELS[MONTHS[0]]} Ã  ${MONTH_LABELS[MONTHS[MONTHS.length-1]]})`,
        totalProjects: results.length,
        feasibleProjects: goP.length,
        blockedProjects: blockP.length,
        criteria: criteriaInfo,
        monthlyCapacity: monthlyData,
        projects: projectDetails,
        resources: peopleByFunction,
        currentTab: currentTab,
        selectedMonth: MONTH_LABELS[selectedMonth]
    };
}

function getContextPrompt(tab) {
    const contexts = {
        'projets': {
            title: 'Gestion des projets',
            help: `L'utilisateur est dans l'onglet PROJETS oÃ¹ il gÃ¨re la liste des initiatives.
            
Aide-le Ã :
- Comprendre comment ajouter/modifier des projets
- DÃ©terminer si une initiative devrait Ãªtre un projet ou non-projet
- Remplir correctement les informations de la charte de projet
- Identifier les informations manquantes importantes`
        },
        'scoring': {
            title: 'Scoring et priorisation',
            help: `L'utilisateur est dans l'onglet SCORING oÃ¹ il Ã©value les projets selon les critÃ¨res stratÃ©giques.

Aide-le Ã :
- Comprendre comment noter chaque critÃ¨re (1-10)
- Ã‰quilibrer les poids des critÃ¨res
- Identifier les projets mal notÃ©s ou avec des scores manquants
- InterprÃ©ter les scores pondÃ©rÃ©s pour la priorisation`
        },
        'people': {
            title: 'Gestion des ressources',
            help: `L'utilisateur est dans l'onglet RESSOURCES oÃ¹ il gÃ¨re les personnes et leur disponibilitÃ© mensuelle.

Aide-le Ã :
- Ajouter les bonnes personnes avec leurs fonctions
- DÃ©finir la disponibilitÃ© rÃ©aliste par mois (heures/mois)
- Tenir compte des vacances (Ã©tÃ©, dÃ©cembre)
- Ã‰quilibrer la charge entre les Ã©quipes`
        },
        'assign': {
            title: 'Affectation des ressources',
            help: `L'utilisateur est dans l'onglet AFFECTATION oÃ¹ il assigne les heures par personne par projet par mois.

Aide-le Ã :
- RÃ©partir les heures de faÃ§on rÃ©aliste
- Ã‰viter les surcharges (cases rouges)
- Utiliser la fonction "Copier ce mois vers tous"
- Comprendre l'impact des affectations sur la capacitÃ©`
        },
        'recommend': {
            title: 'Recommandations',
            help: `L'utilisateur est dans l'onglet RECOMMANDATION qui montre quels projets sont faisables vs bloquÃ©s.

Aide-le Ã :
- Comprendre pourquoi certains projets sont en GOULOT
- Identifier les personnes qui causent les goulots
- Proposer des solutions pour dÃ©bloquer les projets
- Prioriser les projets Ã  faire passer en Gate 0`
        },
        'analyse': {
            title: 'Analyse de capacitÃ©',
            help: `L'utilisateur est dans l'onglet ANALYSE qui montre le graphique capacitÃ© vs demande.

Aide-le Ã :
- InterprÃ©ter le graphique mensuel
- Identifier les mois problÃ©matiques
- Comprendre la charge par fonction/personne
- Planifier les ajustements de capacitÃ©`
        },
        'gate0': {
            title: 'Gate 0 - DÃ©cision',
            help: `L'utilisateur est dans l'onglet GATE 0 qui est le rapport final pour la prise de dÃ©cision.

Aide-le Ã :
- PrÃ©parer la prÃ©sentation au comitÃ© exÃ©cutif
- Justifier les recommandations GO vs GOULOT
- Identifier les actions requises pour dÃ©bloquer les projets
- Copier le rapport pour partage`
        }
    };
    return contexts[tab] || contexts['projets'];
}

async function openMarcus() {
    const context = getContextPrompt(currentTab);
    const summary = getPortfolioSummary();
    const isNewSetup = summary.totalProjects === 0 && Object.values(summary.resources).flat().length === 0;
    
    // Show selection modal first
    let html = `<div class="modal-overlay" id="marcusOverlay" onclick="if(event.target===this)closeMarcus()">
    <div class="modal-box" style="max-width:520px">
        <div class="charter-modal-header" style="background:linear-gradient(135deg,#8b5cf6,#6366f1)">
            <div style="display:flex;align-items:center;gap:0.6rem">
                <img src="${MARCUS_AVATAR}" style="width:40px;height:40px;border-radius:50%;border:2px solid rgba(255,255,255,0.5);object-fit:cover">
                <div>
                    <span class="charter-modal-title" style="color:white">MARCUS</span>
                    <div style="font-size:0.72rem;color:rgba(255,255,255,0.8);margin-top:0.1rem">Comment puis-je t'aider?</div>
                </div>
            </div>
            <button class="charter-btn-close" style="background:rgba(255,255,255,0.2);color:white" onclick="closeMarcus()">âœ•</button>
        </div>
        <div style="padding:1.5rem" id="marcusContent">
            <div style="display:flex;flex-direction:column;gap:0.85rem">
                
                <!-- 1. Portfolio analysis -->
                <button onclick="runMarcusAnalysis('portfolio')" style="display:flex;align-items:center;gap:1rem;padding:1.1rem;background:var(--bg-card);border:2px solid var(--border);border-radius:12px;cursor:pointer;text-align:left;transition:all 0.2s" onmouseover="this.style.borderColor='var(--success)';this.style.background='rgba(56,161,105,0.05)'" onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg-card)'">
                    <div style="width:50px;height:50px;border-radius:12px;background:linear-gradient(135deg,#22c55e,#16a34a);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                        <span style="font-size:1.5rem">ğŸ“Š</span>
                    </div>
                    <div>
                        <div style="font-size:1rem;font-weight:700;color:var(--text);margin-bottom:0.25rem">Analyser mon portefeuille</div>
                        <div style="font-size:0.82rem;color:var(--text-dim)">Diagnostic complet et recommandations stratÃ©giques.</div>
                    </div>
                </button>
                
                <!-- 2. Help with current section -->
                <button onclick="runMarcusAnalysis('process')" style="display:flex;align-items:center;gap:1rem;padding:1.1rem;background:var(--bg-card);border:2px solid var(--border);border-radius:12px;cursor:pointer;text-align:left;transition:all 0.2s" onmouseover="this.style.borderColor='var(--primary)';this.style.background='rgba(66,153,225,0.05)'" onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg-card)'">
                    <div style="width:50px;height:50px;border-radius:12px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                        <span style="font-size:1.5rem">â“</span>
                    </div>
                    <div>
                        <div style="font-size:1rem;font-weight:700;color:var(--text);margin-bottom:0.25rem">Aide avec cette section</div>
                        <div style="font-size:0.82rem;color:var(--text-dim)">Je ne sais pas quoi faire dans <b>${context.title}</b>.</div>
                    </div>
                </button>
                
                <!-- 3. First Time Setup - highlighted if new -->
                <button onclick="runMarcusAnalysis('setup')" style="display:flex;align-items:center;gap:1rem;padding:1.1rem;background:${isNewSetup?'rgba(139,92,246,0.08)':'var(--bg-card)'};border:2px solid ${isNewSetup?'#8b5cf6':'var(--border)'};border-radius:12px;cursor:pointer;text-align:left;transition:all 0.2s;position:relative" onmouseover="this.style.borderColor='#8b5cf6';this.style.background='rgba(139,92,246,0.08)'" onmouseout="this.style.borderColor='${isNewSetup?'#8b5cf6':'var(--border)'}';this.style.background='${isNewSetup?'rgba(139,92,246,0.08)':'var(--bg-card)'}'" >
                    <div style="width:50px;height:50px;border-radius:12px;background:linear-gradient(135deg,#8b5cf6,#6366f1);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                        <span style="font-size:1.5rem">ğŸš€</span>
                    </div>
                    <div style="flex:1">
                        <div style="font-size:1rem;font-weight:700;color:var(--text);margin-bottom:0.25rem">PremiÃ¨re configuration</div>
                        <div style="font-size:0.82rem;color:var(--text-dim)">Guide pas Ã  pas pour dÃ©marrer de zÃ©ro.</div>
                    </div>
                    ${isNewSetup ? '<div style="position:absolute;top:-8px;right:-8px;background:#8b5cf6;color:white;font-size:0.65rem;font-weight:700;padding:3px 8px;border-radius:10px">RECOMMANDÃ‰</div>' : ''}
                </button>
                
                <!-- Separator -->
                <div style="border-top:1px dashed var(--border);margin:0.5rem 0"></div>
                
                <!-- 4. Reset / Start fresh - with DANGEREUX tag -->
                <button onclick="closeMarcus();startResetProcess()" style="display:flex;align-items:center;gap:1rem;padding:0.9rem;background:var(--bg-card);border:2px solid var(--border);border-radius:12px;cursor:pointer;text-align:left;transition:all 0.2s;opacity:0.7;position:relative" onmouseover="this.style.borderColor='var(--error)';this.style.background='rgba(229,62,62,0.05)';this.style.opacity='1'" onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg-card)';this.style.opacity='0.7'">
                    <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#ef4444,#dc2626);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                        <span style="font-size:1.2rem">ğŸ—‘ï¸</span>
                    </div>
                    <div style="flex:1">
                        <div style="font-size:0.9rem;font-weight:700;color:var(--error);margin-bottom:0.15rem">Repartir Ã  zÃ©ro</div>
                        <div style="font-size:0.75rem;color:var(--text-dim)">Effacer tous les projets et recommencer.</div>
                    </div>
                    <div style="background:#dc2626;color:white;font-size:0.6rem;font-weight:700;padding:3px 6px;border-radius:4px;letter-spacing:0.5px">âš ï¸ DANGEREUX</div>
                </button>
            </div>
        </div>
    </div></div>`;
    
    document.body.insertAdjacentHTML('beforeend', html);
}

async function runMarcusAnalysis(mode) {
    const context = getContextPrompt(currentTab);
    
    // Show loading state
    document.getElementById('marcusContent').innerHTML = `
        <div style="text-align:center;padding:3rem">
            <img src="${MARCUS_AVATAR}" style="width:80px;height:80px;border-radius:50%;border:3px solid var(--primary);margin-bottom:1rem;animation:pulse 1.5s infinite">
            <div style="font-size:1rem;font-weight:600;color:var(--text-muted);margin-bottom:0.5rem">MARCUS analyse...</div>
            <div style="font-size:0.85rem;color:var(--text-dim)">${mode === 'setup' ? 'PrÃ©paration du guide de dÃ©marrage...' : mode === 'process' ? 'PrÃ©paration des instructions...' : 'Examen de votre portefeuille en cours'}</div>
        </div>
        <style>@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }</style>`;
    
    // Update modal title
    document.querySelector('#marcusOverlay .charter-modal-header > div > div > div:last-child').textContent = 
        mode === 'setup' ? 'Guide de premiÃ¨re configuration' : mode === 'process' ? `Aide â€” ${context.title}` : 'Analyse du portefeuille';
    
    // Expand modal for results
    document.querySelector('#marcusOverlay .modal-box').style.maxWidth = '800px';
    
    // Gather portfolio data
    const summary = getPortfolioSummary();
    const contextInfo = getContextPrompt(currentTab);
    
    // Build prompts based on mode
    let systemPrompt, userPrompt;
    
    if (mode === 'setup') {
        systemPrompt = `Tu es MARCUS, un assistant PMO intÃ©grÃ© dans l'outil de gestion de portefeuille de projets de Camions BL.

L'utilisateur vient de dÃ©ployer l'application et a besoin d'un guide complet pour configurer le systÃ¨me de zÃ©ro.

WORKFLOW IMPORTANT:
- Les initiatives Ã  Ã©valuer PROVIENNENT de Microsoft Teams Planner
- AprÃ¨s approbation Gate 0, les projets RETOURNENT dans Teams Planner pour exÃ©cution
- Cet outil sert Ã  la phase PRÃ‰-GATE 0 (Ã©valuation, priorisation, planification capacitÃ©)

L'OUTIL CONTIENT CES ONGLETS (dans l'ordre):
1. PROCESSUS - Diagramme du workflow PMO (informatif seulement)
2. TRIAGE - DÃ©terminer si une initiative est un projet ou non
3. PORTEFEUILLE - Liste des projets avec chartes
4. SCORING - Ã‰valuer les projets selon des critÃ¨res pondÃ©rÃ©s
5. RESSOURCES - DÃ©finir les personnes et leur disponibilitÃ© mensuelle
6. AFFECTATION - Assigner les heures par projet/personne/mois
7. RECOMMANDATION - Voir quels projets sont faisables vs bloquÃ©s
8. ANALYSE - Graphiques de capacitÃ© vs demande
9. GATE 0 - Rapport final pour dÃ©cision exÃ©cutive

TON RÃ”LE: Guider l'utilisateur Ã©tape par Ã©tape pour une premiÃ¨re configuration complÃ¨te.

STYLE:
- Utilise le tutoiement
- Sois encourageant et pÃ©dagogique
- Donne des exemples concrets
- Explique le POURQUOI de chaque Ã©tape

FORMAT: Utilise UNIQUEMENT **TITRE EN GRAS** pour les sections (pas de # ou ##). Utilise des tirets - pour les listes.`;

        userPrompt = `L'utilisateur dÃ©marre avec un systÃ¨me vide et a besoin d'un guide de configuration complet.

Ã‰TAT ACTUEL:
- Projets: ${summary.totalProjects}
- Ressources: ${Object.values(summary.resources).flat().length}

Fournis un guide complet de dÃ©marrage avec ces sections:

**BIENVENUE DANS L'OUTIL PMO**
(2-3 phrases d'introduction encourageantes. Mentionner que les initiatives viennent de Teams Planner et y retournent aprÃ¨s Gate 0.)

**Ã‰TAPE 1: CONFIGURER LES RESSOURCES**
(Aller dans l'onglet Ressources, ajouter les personnes clÃ©s avec leur fonction et disponibilitÃ© mensuelle. Donner un exemple concret.)

**Ã‰TAPE 2: IMPORTER VOS INITIATIVES**
(Les initiatives proviennent de Microsoft Teams Planner. Aller dans Triage pour les classifier, puis dans Portefeuille pour crÃ©er les chartes. Expliquer les champs importants.)

**Ã‰TAPE 3: Ã‰VALUER ET PRIORISER**
(Aller dans l'onglet Scoring, noter chaque projet sur les critÃ¨res, expliquer l'impact des poids.)

**Ã‰TAPE 4: AFFECTER LES RESSOURCES**
(Aller dans l'onglet Affectation, distribuer les heures par personne/projet/mois. Attention aux surcharges.)

**Ã‰TAPE 5: ANALYSER ET DÃ‰CIDER**
(Consulter Recommandation pour voir les goulots, ajuster, puis utiliser Gate 0 pour le rapport final. AprÃ¨s approbation, les projets retournent dans Teams Planner pour exÃ©cution.)

**CONSEIL CLÃ‰**
(Un conseil important pour rÃ©ussir avec l'outil)

RÃ©ponds en franÃ§ais, de faÃ§on claire, structurÃ©e et encourageante.`;

    } else if (mode === 'process') {
        systemPrompt = `Tu es MARCUS, un assistant PMO intÃ©grÃ© dans l'outil de gestion de portefeuille de projets de Camions BL.

L'utilisateur est dans la section "${contextInfo.title}" et a besoin d'aide pour comprendre quoi faire.

${contextInfo.help}

TON RÃ”LE: Guide l'utilisateur pas Ã  pas, de faÃ§on simple et pratique. Explique QUOI faire et COMMENT le faire dans cette section spÃ©cifique.

STYLE:
- Utilise le tutoiement
- Sois concis et direct
- NumÃ©rote les Ã©tapes
- Donne des exemples concrets basÃ©s sur leurs donnÃ©es

FORMAT: Utilise UNIQUEMENT **TITRE EN GRAS** pour les sections (pas de # ou ##). Utilise des tirets - pour les listes.`;

        userPrompt = `L'utilisateur est dans la section "${contextInfo.title}" et ne sait pas quoi faire.

DONNÃ‰ES ACTUELLES:
- Nombre de projets: ${summary.totalProjects}
- Projets faisables: ${summary.feasibleProjects}
- Projets bloquÃ©s: ${summary.blockedProjects}
- Mois sÃ©lectionnÃ©: ${summary.selectedMonth}
- Nombre de ressources: ${Object.values(summary.resources).flat().length}

Fournis exactement ces 4 sections (utilise **TITRE** pour chaque):

**OBJECTIF DE CETTE SECTION**
(1-2 phrases: Ã  quoi sert cet onglet)

**Ã‰TAPES Ã€ SUIVRE**
(3-5 Ã©tapes avec tirets, concrÃ¨tes et actionnables)

**CONSEILS PRATIQUES**
(2-3 astuces avec tirets)

**PROCHAINE Ã‰TAPE**
(oÃ¹ aller aprÃ¨s)

RÃ©ponds en franÃ§ais, de faÃ§on claire et encourageante.`;

    } else {
        systemPrompt = `Tu es MARCUS, un conseiller expert en gestion de portefeuille de projets (PMO) pour Camions BL, un concessionnaire de camions au QuÃ©bec.

Tu analyses les donnÃ©es de leur portefeuille de projets et donnes des recommandations stratÃ©giques en franÃ§ais pour:
1. Optimiser l'allocation des ressources
2. RÃ©soudre les goulots d'Ã©tranglement
3. Prioriser les projets pour passer Gate 0
4. Identifier les risques de capacitÃ©

STYLE:
- Sois concis et pratique
- Utilise le tutoiement professionnel
- Donne des recommandations actionnables

FORMAT: Utilise UNIQUEMENT **TITRE EN GRAS** pour les sections (pas de # ou ##). Utilise des tirets - pour les listes.`;

        userPrompt = `DONNÃ‰ES DU PORTEFEUILLE:
${JSON.stringify(summary, null, 2)}

Fournis exactement ces 4 sections (utilise **TITRE** pour chaque):

**DIAGNOSTIC**
(2-3 phrases sur la santÃ© du portefeuille)

**ACTIONS PRIORITAIRES**
(3-5 actions concrÃ¨tes avec tirets)

**PROJETS BLOQUÃ‰S**
(pour chaque GOULOT, une solution spÃ©cifique avec tirets)

**ALERTES**
(risques ou problÃ¨mes urgents avec tirets)

RÃ©ponds en franÃ§ais avec des recommandations pratiques.`;
    }

    try {
        const response = await fetch("/api/marcus", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                system: systemPrompt,
                max_tokens: mode === 'setup' ? 2500 : 1500,
                messages: [
                    { role: "user", content: userPrompt }
                ]
            })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Erreur API');
        }
        
        const aiResponse = data.content?.[0]?.text || "Erreur: Pas de rÃ©ponse";
        
        // Format and display response
        const formattedResponse = formatMarcusResponse(aiResponse, mode);
        document.getElementById('marcusContent').innerHTML = formattedResponse;
        
    } catch (error) {
        document.getElementById('marcusContent').innerHTML = `
            <div style="text-align:center;padding:2rem">
                <div style="font-size:2rem;margin-bottom:1rem">âš ï¸</div>
                <div style="font-size:1rem;font-weight:600;color:var(--error);margin-bottom:0.5rem">Connexion impossible</div>
                <div style="font-size:0.85rem;color:var(--text-dim)">${error.message}</div>
                <button onclick="openMarcus()" class="btn" style="margin-top:1rem">ğŸ”„ RÃ©essayer</button>
            </div>`;
    }
}

function formatMarcusResponse(text, mode) {
    // First, convert any ## or ### headers to bold format
    let html = text
        .replace(/^###\s*(.+)$/gm, '**$1**')
        .replace(/^##\s*(.+)$/gm, '**$1**')
        .replace(/^#\s*(.+)$/gm, '**$1**');
    
    // Convert markdown-style formatting to HTML
    html = html
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n- /g, '</li><li>')
        .replace(/\n\* /g, '</li><li>')
        .replace(/\n(\d+)\. /g, '</li><li>')
        .replace(/^- /gm, '<li>')
        .replace(/^\* /gm, '<li>')
        .replace(/^(\d+)\. /gm, '<li>');
    
    // Wrap in paragraphs
    html = '<p>' + html + '</p>';
    
    // Section styling for SETUP mode
    html = html.replace(/<strong>([^<]*BIENVENUE[^<]*)<\/strong>/gi, '<h3 style="color:#8b5cf6;font-size:1.05rem;margin:0.5rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem"><span style="font-size:1.2rem">ğŸ‘‹</span> $1</h3>')
               .replace(/<strong>([^<]*Ã‰TAPE 1[^<]*)<\/strong>/gi, '<h3 style="color:var(--primary);font-size:0.95rem;margin:1.5rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem;padding-top:0.75rem;border-top:1px solid var(--border)"><span style="background:var(--primary);color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700">1</span> $1</h3>')
               .replace(/<strong>([^<]*Ã‰TAPE 2[^<]*)<\/strong>/gi, '<h3 style="color:var(--primary);font-size:0.95rem;margin:1.5rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem;padding-top:0.75rem;border-top:1px solid var(--border)"><span style="background:var(--primary);color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700">2</span> $1</h3>')
               .replace(/<strong>([^<]*Ã‰TAPE 3[^<]*)<\/strong>/gi, '<h3 style="color:var(--primary);font-size:0.95rem;margin:1.5rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem;padding-top:0.75rem;border-top:1px solid var(--border)"><span style="background:var(--primary);color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700">3</span> $1</h3>')
               .replace(/<strong>([^<]*Ã‰TAPE 4[^<]*)<\/strong>/gi, '<h3 style="color:var(--primary);font-size:0.95rem;margin:1.5rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem;padding-top:0.75rem;border-top:1px solid var(--border)"><span style="background:var(--primary);color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700">4</span> $1</h3>')
               .replace(/<strong>([^<]*Ã‰TAPE 5[^<]*)<\/strong>/gi, '<h3 style="color:var(--primary);font-size:0.95rem;margin:1.5rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem;padding-top:0.75rem;border-top:1px solid var(--border)"><span style="background:var(--primary);color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700">5</span> $1</h3>')
               .replace(/<strong>([^<]*CONSEIL CLÃ‰[^<]*|[^<]*CONSEIL[^<]*CLÃ‰[^<]*)<\/strong>/gi, '<h3 style="color:var(--success);font-size:0.95rem;margin:1.5rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem;padding-top:0.75rem;border-top:1px solid var(--border)"><span style="font-size:1.1rem">ğŸ’</span> $1</h3>');
    
    // Section styling for PROCESS mode
    html = html.replace(/<strong>([^<]*OBJECTIF[^<]*)<\/strong>/gi, '<h3 style="color:var(--primary);font-size:0.95rem;margin:1.25rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem"><span style="font-size:1.1rem">ğŸ¯</span> $1</h3>')
               .replace(/<strong>([^<]*Ã‰TAPES[^<]*|[^<]*SUIVRE[^<]*)<\/strong>/gi, '<h3 style="color:var(--success);font-size:0.95rem;margin:1.25rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem"><span style="font-size:1.1rem">ğŸ“‹</span> $1</h3>')
               .replace(/<strong>([^<]*CONSEILS[^<]*|[^<]*PRATIQUES[^<]*)<\/strong>/gi, '<h3 style="color:#8b5cf6;font-size:0.95rem;margin:1.25rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem"><span style="font-size:1.1rem">ğŸ’¡</span> $1</h3>')
               .replace(/<strong>([^<]*PROCHAINE[^<]*|[^<]*SUITE[^<]*)<\/strong>/gi, '<h3 style="color:var(--accent);font-size:0.95rem;margin:1.25rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem"><span style="font-size:1.1rem">â¡ï¸</span> $1</h3>');
    
    // Section styling for PORTFOLIO mode
    html = html.replace(/<strong>([^<]*DIAGNOSTIC[^<]*)<\/strong>/gi, '<h3 style="color:var(--primary);font-size:0.95rem;margin:1.25rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem"><span style="font-size:1.1rem">ğŸ”</span> $1</h3>')
               .replace(/<strong>([^<]*ACTIONS[^<]*|[^<]*PRIORITAIRES[^<]*)<\/strong>/gi, '<h3 style="color:var(--success);font-size:0.95rem;margin:1.25rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem"><span style="font-size:1.1rem">âœ…</span> $1</h3>')
               .replace(/<strong>([^<]*BLOQUÃ‰S[^<]*|[^<]*GOULOT[^<]*)<\/strong>/gi, '<h3 style="color:var(--error);font-size:0.95rem;margin:1.25rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem"><span style="font-size:1.1rem">ğŸš§</span> $1</h3>')
               .replace(/<strong>([^<]*ALERTES[^<]*|[^<]*RISQUES[^<]*)<\/strong>/gi, '<h3 style="color:#d97706;font-size:0.95rem;margin:1.25rem 0 0.5rem;display:flex;align-items:center;gap:0.4rem"><span style="font-size:1.1rem">âš ï¸</span> $1</h3>');
    
    // Style lists
    html = html.replace(/<li>/g, '<li style="margin:0.35rem 0;padding-left:0.25rem">');
    
    // Wrap lists properly
    html = html.replace(/(<li[^>]*>.*?<\/li>)+/g, '<ul style="margin:0.5rem 0;padding-left:1.25rem;list-style-type:disc">$&</ul>');
    
    // Clean up empty tags
    html = html.replace(/<p><\/p>/g, '').replace(/<\/li><\/ul><ul[^>]*><li/g, '</li><li');
    
    // Mode labels for footer
    const modeLabels = { setup: 'ğŸš€ Configuration', process: 'â“ Aide', portfolio: 'ğŸ“Š Analyse' };
    const modeLabel = modeLabels[mode] || modeLabels.portfolio;
    
    return `<div style="font-size:0.88rem;line-height:1.6;color:var(--text);max-height:60vh;overflow-y:auto;padding-right:0.5rem">${html}</div>
        <div style="margin-top:1.5rem;padding-top:1rem;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap">
            <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
                <button onclick="runMarcusAnalysis('${mode}')" class="btn" style="font-size:0.78rem;padding:0.4rem 0.8rem;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:white;border:none">ğŸ”„ Actualiser</button>
                <button onclick="closeMarcus();openMarcus()" class="btn btn-secondary" style="font-size:0.78rem;padding:0.4rem 0.8rem">â† Autres options</button>
                <button onclick="closeMarcus()" class="btn btn-secondary" style="font-size:0.78rem;padding:0.4rem 0.8rem">âœ“ Fermer</button>
            </div>
            <span style="font-size:0.68rem;color:var(--text-dim)">MARCUS ${modeLabel} â€” ${new Date().toLocaleTimeString('fr-CA', {hour:'2-digit', minute:'2-digit'})}</span>
        </div>`;
}

function closeMarcus() {
    document.getElementById('marcusOverlay')?.remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESET / START FRESH (Triple verification)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startResetProcess() {
    const projectCount = STATE.projects.length;
    const peopleCount = Object.values(STATE.people).flat().length;
    
    if (projectCount === 0 && peopleCount === 0) {
        notify('Le systÃ¨me est dÃ©jÃ  vide!', 'info');
        return;
    }
    
    // Step 1: First confirmation
    let html = `<div class="modal-overlay" id="resetOverlay" onclick="if(event.target===this)closeResetModal()">
    <div class="modal-box" style="max-width:480px">
        <div class="charter-modal-header" style="background:linear-gradient(135deg,#ef4444,#dc2626)">
            <div style="display:flex;align-items:center;gap:0.6rem">
                <span style="font-size:1.5rem">âš ï¸</span>
                <div>
                    <span class="charter-modal-title" style="color:white">Repartir Ã  zÃ©ro</span>
                    <div style="font-size:0.72rem;color:rgba(255,255,255,0.8);margin-top:0.1rem">Ã‰tape 1 de 3</div>
                </div>
            </div>
            <button class="charter-btn-close" style="background:rgba(255,255,255,0.2);color:white" onclick="closeResetModal()">âœ•</button>
        </div>
        <div style="padding:1.5rem" id="resetContent">
            <div style="text-align:center;margin-bottom:1.5rem">
                <div style="font-size:3rem;margin-bottom:1rem">ğŸ—‘ï¸</div>
                <h3 style="color:var(--error);margin:0 0 0.5rem">Attention: Action irrÃ©versible</h3>
                <p style="color:var(--text-dim);font-size:0.9rem;margin:0">Cette action va supprimer <b>dÃ©finitivement</b> toutes les donnÃ©es.</p>
            </div>
            
            <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:1rem;margin-bottom:1.5rem">
                <div style="font-size:0.85rem;font-weight:600;color:var(--error);margin-bottom:0.5rem">DonnÃ©es qui seront effacÃ©es:</div>
                <div style="font-size:0.9rem;color:var(--text)">
                    <div>â€¢ <b>${projectCount}</b> projet(s)</div>
                    <div>â€¢ <b>${peopleCount}</b> ressource(s)</div>
                    <div>â€¢ Toutes les affectations</div>
                    <div>â€¢ Tous les scores</div>
                </div>
            </div>
            
            <p style="font-size:0.85rem;color:var(--text-dim);text-align:center;margin-bottom:1.5rem">
                ğŸ’¡ Conseil: Exportez vos donnÃ©es avant de continuer.
            </p>
            
            <div style="display:flex;gap:0.75rem">
                <button onclick="closeResetModal()" class="btn btn-secondary" style="flex:1">Annuler</button>
                <button onclick="resetStep2()" class="btn" style="flex:1;background:var(--error);color:white;border-color:var(--error)">Continuer â†’</button>
            </div>
        </div>
    </div></div>`;
    
    document.body.insertAdjacentHTML('beforeend', html);
}

function resetStep2() {
    document.getElementById('resetContent').innerHTML = `
        <div style="text-align:center;margin-bottom:1.5rem">
            <div style="font-size:3rem;margin-bottom:1rem">ğŸ”</div>
            <h3 style="color:var(--error);margin:0 0 0.5rem">Confirmation requise</h3>
            <p style="color:var(--text-dim);font-size:0.9rem;margin:0">Ã‰tape 2 de 3: Tapez <b>EFFACER</b> pour confirmer.</p>
        </div>
        
        <div style="margin-bottom:1.5rem">
            <input type="text" id="resetConfirmInput" placeholder="Tapez EFFACER ici" style="width:100%;padding:0.85rem;border:2px solid var(--error);border-radius:8px;font-size:1.1rem;text-align:center;text-transform:uppercase;box-sizing:border-box" oninput="checkResetInput()">
            <div id="resetInputFeedback" style="font-size:0.8rem;text-align:center;margin-top:0.5rem;color:var(--text-dim)"></div>
        </div>
        
        <div style="display:flex;gap:0.75rem">
            <button onclick="closeResetModal()" class="btn btn-secondary" style="flex:1">Annuler</button>
            <button id="resetStep2Btn" onclick="resetStep3()" class="btn" style="flex:1;background:#ccc;color:white;border-color:#ccc;cursor:not-allowed" disabled>Continuer â†’</button>
        </div>`;
    
    document.querySelector('#resetOverlay .charter-modal-header > div > div > div:last-child').textContent = 'Ã‰tape 2 de 3';
    document.getElementById('resetConfirmInput').focus();
}

function checkResetInput() {
    const input = document.getElementById('resetConfirmInput').value.toUpperCase();
    const btn = document.getElementById('resetStep2Btn');
    const feedback = document.getElementById('resetInputFeedback');
    
    if (input === 'EFFACER') {
        btn.disabled = false;
        btn.style.background = 'var(--error)';
        btn.style.borderColor = 'var(--error)';
        btn.style.cursor = 'pointer';
        feedback.innerHTML = 'âœ“ Correct';
        feedback.style.color = 'var(--success)';
    } else {
        btn.disabled = true;
        btn.style.background = '#ccc';
        btn.style.borderColor = '#ccc';
        btn.style.cursor = 'not-allowed';
        feedback.innerHTML = input.length > 0 ? 'âœ— Tapez exactement "EFFACER"' : '';
        feedback.style.color = 'var(--error)';
    }
}

function resetStep3() {
    document.getElementById('resetContent').innerHTML = `
        <div style="text-align:center;margin-bottom:1.5rem">
            <div style="font-size:3rem;margin-bottom:1rem">ğŸš¨</div>
            <h3 style="color:var(--error);margin:0 0 0.5rem">DerniÃ¨re chance!</h3>
            <p style="color:var(--text-dim);font-size:0.9rem;margin:0">Ã‰tape 3 de 3: ÃŠtes-vous <b>absolument certain</b>?</p>
        </div>
        
        <div style="background:rgba(239,68,68,0.15);border:2px solid rgba(239,68,68,0.5);border-radius:8px;padding:1.25rem;margin-bottom:1.5rem;text-align:center">
            <div style="font-size:1.1rem;font-weight:700;color:var(--error);margin-bottom:0.5rem">âš ï¸ POINT DE NON-RETOUR âš ï¸</div>
            <div style="font-size:0.9rem;color:var(--text)">
                Cette action est <b>DÃ‰FINITIVE</b> et <b>IRRÃ‰VERSIBLE</b>.<br>
                Toutes vos donnÃ©es seront perdues pour toujours.
            </div>
        </div>
        
        <div style="display:flex;gap:0.75rem">
            <button onclick="closeResetModal()" class="btn" style="flex:1;background:var(--success);color:white;border-color:var(--success)">ğŸ›¡ï¸ Non, annuler</button>
            <button onclick="executeReset()" class="btn" style="flex:1;background:var(--error);color:white;border-color:var(--error)">ğŸ—‘ï¸ Oui, tout effacer</button>
        </div>`;
    
    document.querySelector('#resetOverlay .charter-modal-header > div > div > div:last-child').textContent = 'Ã‰tape 3 de 3';
}

function executeReset() {
    // Reset all data
    STATE.projects = [];
    STATE.people = { TI: [], Ops: [], RH: [], Ventes: [], Finance: [], Direction: [] };
    STATE.assignments = {};
    STATE.triageItems = [];
    
    // Save and refresh
    saveState();
    
    // Show success and close
    document.getElementById('resetContent').innerHTML = `
        <div style="text-align:center;padding:2rem">
            <div style="font-size:4rem;margin-bottom:1rem">âœ¨</div>
            <h3 style="color:var(--success);margin:0 0 0.5rem">RÃ©initialisation complÃ¨te!</h3>
            <p style="color:var(--text-dim);font-size:0.9rem;margin:0 0 1.5rem">Le systÃ¨me est maintenant vide et prÃªt pour une nouvelle configuration.</p>
            <button onclick="closeResetModal();location.reload()" class="btn" style="background:var(--success);color:white;border-color:var(--success)">ğŸš€ Commencer</button>
        </div>`;
    
    document.querySelector('#resetOverlay .charter-modal-header').style.background = 'linear-gradient(135deg,#22c55e,#16a34a)';
    document.querySelector('#resetOverlay .charter-modal-header span').textContent = 'âœ“';
    document.querySelector('#resetOverlay .charter-modal-header .charter-modal-title').textContent = 'TerminÃ©';
    document.querySelector('#resetOverlay .charter-modal-header > div > div > div:last-child').textContent = 'SystÃ¨me rÃ©initialisÃ©';
}

function closeResetModal() {
    document.getElementById('resetOverlay')?.remove();
}

// Keep old function name for compatibility
function openAIAdvisor() { openMarcus(); }
function closeAIAdvisor() { closeMarcus(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPORT/EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportData() {
    const d = JSON.stringify(STATE, null, 2);
    const b = new Blob([d], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(b);
    a.download = 'camionsbl_pmo_'+new Date().toISOString().split('T')[0]+'.json'; a.click();
    notify('DonnÃ©es exportÃ©es');
}
function importData(e) {
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ev => {
        try { const d = JSON.parse(ev.target.result);
            if(d.projects) { STATE.projects=d.projects; STATE.maxCapacity=d.maxCapacity||70; STATE.weights=d.weights||{...DEFAULT_WEIGHTS}; STATE.criteria=d.criteria||JSON.parse(JSON.stringify(DEFAULT_CRITERIA)); STATE.people=d.people||JSON.parse(JSON.stringify(DEFAULT_PEOPLE)); STATE.assignments=d.assignments||JSON.parse(JSON.stringify(DEFAULT_ASSIGNMENTS)); saveState(); renderAll(); notify('DonnÃ©es importÃ©es'); }
            else alert('Format invalide');
        } catch(err) { alert('Erreur: '+err.message); }
    };
    r.readAsText(f);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN / AUTHENTICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AUTH_CREDENTIALS = {
    username: 'admin',
    password: 'camionsbl2026'
};

function checkLogin() {
    const isLoggedIn = sessionStorage.getItem('pmo_logged_in') === 'true';
    const loginScreen = document.getElementById('loginScreen');
    
    // Set MARCUS avatar on login page
    const loginAvatar = document.getElementById('loginMarcusAvatar');
    if (loginAvatar) loginAvatar.src = MARCUS_AVATAR;
    
    if (isLoggedIn) {
        loginScreen.style.display = 'none';
    } else {
        loginScreen.style.display = 'flex';
    }
}

function doLogin() {
    const user = document.getElementById('loginUser').value.trim().toLowerCase();
    const pass = document.getElementById('loginPass').value;
    const errorDiv = document.getElementById('loginError');
    
    if (user === AUTH_CREDENTIALS.username && pass === AUTH_CREDENTIALS.password) {
        sessionStorage.setItem('pmo_logged_in', 'true');
        document.getElementById('loginScreen').style.display = 'none';
        errorDiv.style.display = 'none';
    } else {
        errorDiv.textContent = 'Identifiant ou mot de passe incorrect';
        errorDiv.style.display = 'block';
        document.getElementById('loginPass').value = '';
    }
}

function doLogout() {
    try {
        sessionStorage.removeItem('pmo_logged_in');
        const loginScreen = document.getElementById('loginScreen');
        if (loginScreen) {
            loginScreen.style.display = 'flex';
            const loginAvatar = document.getElementById('loginMarcusAvatar');
            if (loginAvatar) loginAvatar.src = MARCUS_AVATAR;
        }
        const loginUser = document.getElementById('loginUser');
        const loginPass = document.getElementById('loginPass');
        const loginError = document.getElementById('loginError');
        if (loginUser) loginUser.value = '';
        if (loginPass) loginPass.value = '';
        if (loginError) loginError.style.display = 'none';
    } catch(e) {
        console.error('Logout error:', e);
        sessionStorage.clear();
        location.reload();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
checkLogin();
init();

// Add floating MARCUS button
document.body.insertAdjacentHTML('beforeend', `
<div id="marcusFloating" style="position:fixed;bottom:24px;right:24px;z-index:9999">
    <button onclick="openMarcus()" style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#8b5cf6,#6366f1);border:3px solid white;cursor:pointer;box-shadow:0 4px 20px rgba(139,92,246,0.4);display:flex;align-items:center;justify-content:center;transition:transform 0.2s,box-shadow 0.2s;padding:0;overflow:hidden" onmouseover="this.style.transform='scale(1.1)';this.style.boxShadow='0 6px 25px rgba(139,92,246,0.5)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 20px rgba(139,92,246,0.4)'" title="MARCUS â€” Assistant IA">
        <img src="${MARCUS_AVATAR}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">
    </button>
    <div style="position:absolute;bottom:-6px;right:-6px;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:white;font-size:0.55rem;font-weight:700;padding:3px 8px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.3);border:2px solid white">MARCUS</div>
</div>
`);
</script>
</body>
</html>
